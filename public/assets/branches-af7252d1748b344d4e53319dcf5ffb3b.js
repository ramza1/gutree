/*! Copyright (c) 2011 Brandon Aaron (http://brandonaaron.net)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.0.6
 * 
 * Requires: 1.2.2+
 */
(function(e){function t(t){var n=t||window.event,i=[].slice.call(arguments,1),s=0,o=0,r=0;return t=e.event.fix(n),t.type="mousewheel",n.wheelDelta&&(s=n.wheelDelta/120),n.detail&&(s=-n.detail/3),r=s,void 0!==n.axis&&n.axis===n.HORIZONTAL_AXIS&&(r=0,o=-1*s),void 0!==n.wheelDeltaY&&(r=n.wheelDeltaY/120),void 0!==n.wheelDeltaX&&(o=-1*n.wheelDeltaX/120),i.unshift(t,s,o,r),(e.event.dispatch||e.event.handle).apply(this,i)}var n=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks)for(var i=n.length;i;)e.event.fixHooks[n[--i]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=n.length;e;)this.addEventListener(n[--e],t,!1);else this.onmousewheel=t},teardown:function(){if(this.removeEventListener)for(var e=n.length;e;)this.removeEventListener(n[--e],t,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})})(jQuery),function(e){function t(){this===s.elem&&(s.pos=[-260,-260],s.elem=!1,o=3)}var n,i,s={pos:[-260,-260]},o=3,r=document,a=r.documentElement,l=r.body;e.event.special.mwheelIntent={setup:function(){var n=e(this).bind("mousewheel",e.event.special.mwheelIntent.handler);return this!==r&&this!==a&&this!==l&&n.bind("mouseleave",t),n=null,!0},teardown:function(){return e(this).unbind("mousewheel",e.event.special.mwheelIntent.handler).unbind("mouseleave",t),!0},handler:function(t){var r=[t.clientX,t.clientY];return this===s.elem||Math.abs(s.pos[0]-r[0])>o||Math.abs(s.pos[1]-r[1])>o?(s.elem=this,s.pos=r,o=250,clearTimeout(i),i=setTimeout(function(){o=10},200),clearTimeout(n),n=setTimeout(function(){o=3},1500),t=e.extend({},t,{type:"mwheelIntent"}),e.event.handle.apply(this,arguments)):void 0}},e.fn.extend({mwheelIntent:function(e){return e?this.bind("mwheelIntent",e):this.trigger("mwheelIntent")},unmwheelIntent:function(e){return this.unbind("mwheelIntent",e)}}),e(function(){l=r.body,e(r).bind("mwheelIntent.mwheelIntentDefault",e.noop)})}(jQuery),/*
 * jScrollPane - v2.0.0beta12 - 2012-09-27
 * http://jscrollpane.kelvinluck.com/
 *
 * Copyright (c) 2010 Kelvin Luck
 * Dual licensed under the MIT or GPL licenses.
 */
function(e,t,n){e.fn.jScrollPane=function(i){function s(i,s){function o(t){var s,a,c,d,h,p,g=!1,v=!1;if(F=t,q===n)h=i.scrollTop(),p=i.scrollLeft(),i.css({overflow:"hidden",padding:0}),U=i.innerWidth()+bt,W=i.innerHeight(),i.width(U),q=e('<div class="jspPane" />').css("padding",yt).append(i.children()),z=e('<div class="jspContainer" />').css({width:U+"px",height:W+"px"}).append(q).appendTo(i);else{if(i.css("width",""),g=F.stickToBottom&&k(),v=F.stickToRight&&A(),d=i.innerWidth()+bt!=U||i.outerHeight()!=W,d&&(U=i.innerWidth()+bt,W=i.innerHeight(),z.css({width:U+"px",height:W+"px"})),!d&&_t==V&&q.outerHeight()==G)return i.width(U),void 0;_t=V,q.css("width",""),i.width(U),z.find(">.jspVerticalBar,>.jspHorizontalBar").remove().end()}q.css("overflow","auto"),V=t.contentWidth?t.contentWidth:q[0].scrollWidth,G=q[0].scrollHeight,q.css("overflow",""),J=V/U,Y=G/W,X=Y>1,Q=J>1,Q||X?(i.addClass("jspScrollable"),s=F.maintainPosition&&(et||it),s&&(a=S(),c=x()),r(),l(),u(),s&&(E(v?V-U:a,!1),w(g?G-W:c,!1)),M(),D(),B(),F.enableKeyboardNavigation&&P(),F.clickOnTrack&&f(),L(),F.hijackInternalLinks&&$()):(i.removeClass("jspScrollable"),q.css({top:0,width:z.width()-bt}),I(),j(),R(),m()),F.autoReinitialise&&!vt?vt=setInterval(function(){o(F)},F.autoReinitialiseDelay):!F.autoReinitialise&&vt&&clearInterval(vt),h&&i.scrollTop(0)&&w(h,!1),p&&i.scrollLeft(0)&&E(p,!1),i.trigger("jsp-initialised",[Q||X])}function r(){X&&(z.append(e('<div class="jspVerticalBar" />').append(e('<div class="jspCap jspCapTop" />'),e('<div class="jspTrack" />').append(e('<div class="jspDrag" />').append(e('<div class="jspDragTop" />'),e('<div class="jspDragBottom" />'))),e('<div class="jspCap jspCapBottom" />'))),st=z.find(">.jspVerticalBar"),ot=st.find(">.jspTrack"),K=ot.find(">.jspDrag"),F.showArrows&&(ct=e('<a class="jspArrow jspArrowUp" />').bind("mousedown.jsp",h(0,-1)).bind("click.jsp",N),ut=e('<a class="jspArrow jspArrowDown" />').bind("mousedown.jsp",h(0,1)).bind("click.jsp",N),F.arrowScrollOnHover&&(ct.bind("mouseover.jsp",h(0,-1,ct)),ut.bind("mouseover.jsp",h(0,1,ut))),d(ot,F.verticalArrowPositions,ct,ut)),at=W,z.find(">.jspVerticalBar>.jspCap:visible,>.jspVerticalBar>.jspArrow").each(function(){at-=e(this).outerHeight()}),K.hover(function(){K.addClass("jspHover")},function(){K.removeClass("jspHover")}).bind("mousedown.jsp",function(t){e("html").bind("dragstart.jsp selectstart.jsp",N),K.addClass("jspActive");var n=t.pageY-K.position().top;return e("html").bind("mousemove.jsp",function(e){v(e.pageY-n,!1)}).bind("mouseup.jsp mouseleave.jsp",g),!1}),a())}function a(){ot.height(at+"px"),et=0,rt=F.verticalGutter+ot.outerWidth(),q.width(U-rt-bt);try{0===st.position().left&&q.css("margin-left",rt+"px")}catch(e){}}function l(){Q&&(z.append(e('<div class="jspHorizontalBar" />').append(e('<div class="jspCap jspCapLeft" />'),e('<div class="jspTrack" />').append(e('<div class="jspDrag" />').append(e('<div class="jspDragLeft" />'),e('<div class="jspDragRight" />'))),e('<div class="jspCap jspCapRight" />'))),dt=z.find(">.jspHorizontalBar"),ht=dt.find(">.jspTrack"),tt=ht.find(">.jspDrag"),F.showArrows&&(mt=e('<a class="jspArrow jspArrowLeft" />').bind("mousedown.jsp",h(-1,0)).bind("click.jsp",N),gt=e('<a class="jspArrow jspArrowRight" />').bind("mousedown.jsp",h(1,0)).bind("click.jsp",N),F.arrowScrollOnHover&&(mt.bind("mouseover.jsp",h(-1,0,mt)),gt.bind("mouseover.jsp",h(1,0,gt))),d(ht,F.horizontalArrowPositions,mt,gt)),tt.hover(function(){tt.addClass("jspHover")},function(){tt.removeClass("jspHover")}).bind("mousedown.jsp",function(t){e("html").bind("dragstart.jsp selectstart.jsp",N),tt.addClass("jspActive");var n=t.pageX-tt.position().left;return e("html").bind("mousemove.jsp",function(e){b(e.pageX-n,!1)}).bind("mouseup.jsp mouseleave.jsp",g),!1}),pt=z.innerWidth(),c())}function c(){z.find(">.jspHorizontalBar>.jspCap:visible,>.jspHorizontalBar>.jspArrow").each(function(){pt-=e(this).outerWidth()}),ht.width(pt+"px"),it=0}function u(){if(Q&&X){var t=ht.outerHeight(),n=ot.outerWidth();at-=t,e(dt).find(">.jspCap:visible,>.jspArrow").each(function(){pt+=e(this).outerWidth()}),pt-=n,W-=n,U-=t,ht.parent().append(e('<div class="jspCorner" />').css("width",t+"px")),a(),c()}Q&&q.width(z.outerWidth()-bt+"px"),G=q.outerHeight(),Y=G/W,Q&&(ft=Math.ceil(1/J*pt),ft>F.horizontalDragMaxWidth?ft=F.horizontalDragMaxWidth:F.horizontalDragMinWidth>ft&&(ft=F.horizontalDragMinWidth),tt.width(ft+"px"),nt=pt-ft,_(it)),X&&(lt=Math.ceil(1/Y*at),lt>F.verticalDragMaxHeight?lt=F.verticalDragMaxHeight:F.verticalDragMinHeight>lt&&(lt=F.verticalDragMinHeight),K.height(lt+"px"),Z=at-lt,y(et))}function d(e,t,n,i){var s,o="before",r="after";"os"==t&&(t=/Mac/.test(navigator.platform)?"after":"split"),t==o?r=t:t==r&&(o=t,s=n,n=i,i=s),e[o](n)[r](i)}function h(e,t,n){return function(){return p(e,t,this,n),this.blur(),!1}}function p(t,n,i,s){i=e(i).addClass("jspActive");var o,r,a=!0,l=function(){0!==t&&Tt.scrollByX(t*F.arrowButtonSpeed),0!==n&&Tt.scrollByY(n*F.arrowButtonSpeed),r=setTimeout(l,a?F.initialDelay:F.arrowRepeatFreq),a=!1};l(),o=s?"mouseout.jsp":"mouseup.jsp",s=s||e("html"),s.bind(o,function(){i.removeClass("jspActive"),r&&clearTimeout(r),r=null,s.unbind(o)})}function f(){m(),X&&ot.bind("mousedown.jsp",function(t){if(t.originalTarget===n||t.originalTarget==t.currentTarget){var i,s=e(this),o=s.offset(),r=t.pageY-o.top-et,a=!0,l=function(){var e=s.offset(),n=t.pageY-e.top-lt/2,o=W*F.scrollPagePercent,u=Z*o/(G-W);if(0>r)et-u>n?Tt.scrollByY(-o):v(n);else{if(!(r>0))return c(),void 0;n>et+u?Tt.scrollByY(o):v(n)}i=setTimeout(l,a?F.initialDelay:F.trackClickRepeatFreq),a=!1},c=function(){i&&clearTimeout(i),i=null,e(document).unbind("mouseup.jsp",c)};return l(),e(document).bind("mouseup.jsp",c),!1}}),Q&&ht.bind("mousedown.jsp",function(t){if(t.originalTarget===n||t.originalTarget==t.currentTarget){var i,s=e(this),o=s.offset(),r=t.pageX-o.left-it,a=!0,l=function(){var e=s.offset(),n=t.pageX-e.left-ft/2,o=U*F.scrollPagePercent,u=nt*o/(V-U);if(0>r)it-u>n?Tt.scrollByX(-o):b(n);else{if(!(r>0))return c(),void 0;n>it+u?Tt.scrollByX(o):b(n)}i=setTimeout(l,a?F.initialDelay:F.trackClickRepeatFreq),a=!1},c=function(){i&&clearTimeout(i),i=null,e(document).unbind("mouseup.jsp",c)};return l(),e(document).bind("mouseup.jsp",c),!1}})}function m(){ht&&ht.unbind("mousedown.jsp"),ot&&ot.unbind("mousedown.jsp")}function g(){e("html").unbind("dragstart.jsp selectstart.jsp mousemove.jsp mouseup.jsp mouseleave.jsp"),K&&K.removeClass("jspActive"),tt&&tt.removeClass("jspActive")}function v(e,t){X&&(0>e?e=0:e>Z&&(e=Z),t===n&&(t=F.animateScroll),t?Tt.animate(K,"top",e,y):(K.css("top",e),y(e)))}function y(e){e===n&&(e=K.position().top),z.scrollTop(0),et=e;var t=0===et,s=et==Z,o=e/Z,r=-o*(G-W);(Ct!=t||Et!=s)&&(Ct=t,Et=s,i.trigger("jsp-arrow-change",[Ct,Et,wt,Ot])),T(t,s),q.css("top",r),i.trigger("jsp-scroll-y",[-r,t,s]).trigger("scroll")}function b(e,t){Q&&(0>e?e=0:e>nt&&(e=nt),t===n&&(t=F.animateScroll),t?Tt.animate(tt,"left",e,_):(tt.css("left",e),_(e)))}function _(e){e===n&&(e=tt.position().left),z.scrollTop(0),it=e;var t=0===it,s=it==nt,o=e/nt,r=-o*(V-U);(wt!=t||Ot!=s)&&(wt=t,Ot=s,i.trigger("jsp-arrow-change",[Ct,Et,wt,Ot])),C(t,s),q.css("left",r),i.trigger("jsp-scroll-x",[-r,t,s]).trigger("scroll")}function T(e,t){F.showArrows&&(ct[e?"addClass":"removeClass"]("jspDisabled"),ut[t?"addClass":"removeClass"]("jspDisabled"))}function C(e,t){F.showArrows&&(mt[e?"addClass":"removeClass"]("jspDisabled"),gt[t?"addClass":"removeClass"]("jspDisabled"))}function w(e,t){var n=e/(G-W);v(n*Z,t)}function E(e,t){var n=e/(V-U);b(n*nt,t)}function O(t,n,i){var s,o,r,a,l,c,u,d,h,p=0,f=0;try{s=e(t)}catch(m){return}for(o=s.outerHeight(),r=s.outerWidth(),z.scrollTop(0),z.scrollLeft(0);!s.is(".jspPane");)if(p+=s.position().top,f+=s.position().left,s=s.offsetParent(),/^body|html$/i.test(s[0].nodeName))return;a=x(),c=a+W,a>p||n?d=p-F.verticalGutter:p+o>c&&(d=p-W+o+F.verticalGutter),d&&w(d,i),l=S(),u=l+U,l>f||n?h=f-F.horizontalGutter:f+r>u&&(h=f-U+r+F.horizontalGutter),h&&E(h,i)}function S(){return-q.position().left}function x(){return-q.position().top}function k(){var e=G-W;return e>20&&10>e-x()}function A(){var e=V-U;return e>20&&10>e-S()}function D(){z.unbind(xt).bind(xt,function(e,t,n,i){var s=it,o=et;return Tt.scrollBy(n*F.mouseWheelSpeed,-i*F.mouseWheelSpeed,!1),s==it&&o==et})}function I(){z.unbind(xt)}function N(){return!1}function M(){q.find(":input,a").unbind("focus.jsp").bind("focus.jsp",function(e){O(e.target,!1)})}function j(){q.find(":input,a").unbind("focus.jsp")}function P(){function t(){var e=it,t=et;switch(n){case 40:Tt.scrollByY(F.keyboardSpeed,!1);break;case 38:Tt.scrollByY(-F.keyboardSpeed,!1);break;case 34:case 32:Tt.scrollByY(W*F.scrollPagePercent,!1);break;case 33:Tt.scrollByY(-W*F.scrollPagePercent,!1);break;case 39:Tt.scrollByX(F.keyboardSpeed,!1);break;case 37:Tt.scrollByX(-F.keyboardSpeed,!1)}return s=e!=it||t!=et}var n,s,o=[];Q&&o.push(dt[0]),X&&o.push(st[0]),q.focus(function(){i.focus()}),i.attr("tabindex",0).unbind("keydown.jsp keypress.jsp").bind("keydown.jsp",function(i){if(i.target===this||o.length&&e(i.target).closest(o).length){var r=it,a=et;switch(i.keyCode){case 40:case 38:case 34:case 32:case 33:case 39:case 37:n=i.keyCode,t();break;case 35:w(G-W),n=null;break;case 36:w(0),n=null}return s=i.keyCode==n&&r!=it||a!=et,!s}}).bind("keypress.jsp",function(e){return e.keyCode==n&&t(),!s}),F.hideFocus?(i.css("outline","none"),"hideFocus"in z[0]&&i.attr("hideFocus",!0)):(i.css("outline",""),"hideFocus"in z[0]&&i.attr("hideFocus",!1))}function R(){i.attr("tabindex","-1").removeAttr("tabindex").unbind("keydown.jsp keypress.jsp")}function L(){if(location.hash&&location.hash.length>1){var t,n,i=escape(location.hash.substr(1));try{t=e("#"+i+', a[name="'+i+'"]')}catch(s){return}t.length&&q.find(i)&&(0===z.scrollTop()?n=setInterval(function(){z.scrollTop()>0&&(O(t,!0),e(document).scrollTop(z.position().top),clearInterval(n))},50):(O(t,!0),e(document).scrollTop(z.position().top)))}}function $(){e(document.body).data("jspHijack")||(e(document.body).data("jspHijack",!0),e(document.body).delegate("a[href*=#]","click",function(n){var i,s,o,r,a,l,c=this.href.substr(0,this.href.indexOf("#")),u=location.href;if(-1!==location.href.indexOf("#")&&(u=location.href.substr(0,location.href.indexOf("#"))),c===u){i=escape(this.href.substr(this.href.indexOf("#")+1));try{s=e("#"+i+', a[name="'+i+'"]')}catch(d){return}s.length&&(o=s.closest(".jspScrollable"),r=o.data("jsp"),r.scrollToElement(s,!0),o[0].scrollIntoView&&(a=e(t).scrollTop(),l=s.offset().top,(a>l||l>a+e(t).height())&&o[0].scrollIntoView()),n.preventDefault())}}))}function B(){var e,t,n,i,s,o=!1;z.unbind("touchstart.jsp touchmove.jsp touchend.jsp click.jsp-touchclick").bind("touchstart.jsp",function(r){var a=r.originalEvent.touches[0];e=S(),t=x(),n=a.pageX,i=a.pageY,s=!1,o=!0}).bind("touchmove.jsp",function(r){if(o){var a=r.originalEvent.touches[0],l=it,c=et;return Tt.scrollTo(e+n-a.pageX,t+i-a.pageY),s=s||Math.abs(n-a.pageX)>5||Math.abs(i-a.pageY)>5,l==it&&c==et}}).bind("touchend.jsp",function(){o=!1}).bind("click.jsp-touchclick",function(){return s?(s=!1,!1):void 0})}function H(){var e=x(),t=S();i.removeClass("jspScrollable").unbind(".jsp"),i.replaceWith(St.append(q.children())),St.scrollTop(e),St.scrollLeft(t),vt&&clearInterval(vt)}var F,q,U,W,z,V,G,J,Y,X,Q,K,Z,et,tt,nt,it,st,ot,rt,at,lt,ct,ut,dt,ht,pt,ft,mt,gt,vt,yt,bt,_t,Tt=this,Ct=!0,wt=!0,Et=!1,Ot=!1,St=i.clone(!1,!1).empty(),xt=e.fn.mwheelIntent?"mwheelIntent.jsp":"mousewheel.jsp";yt=i.css("paddingTop")+" "+i.css("paddingRight")+" "+i.css("paddingBottom")+" "+i.css("paddingLeft"),bt=(parseInt(i.css("paddingLeft"),10)||0)+(parseInt(i.css("paddingRight"),10)||0),e.extend(Tt,{reinitialise:function(t){t=e.extend({},F,t),o(t)},scrollToElement:function(e,t,n){O(e,t,n)},scrollTo:function(e,t,n){E(e,n),w(t,n)},scrollToX:function(e,t){E(e,t)},scrollToY:function(e,t){w(e,t)},scrollToPercentX:function(e,t){E(e*(V-U),t)},scrollToPercentY:function(e,t){w(e*(G-W),t)},scrollBy:function(e,t,n){Tt.scrollByX(e,n),Tt.scrollByY(t,n)},scrollByX:function(e,t){var n=S()+Math[0>e?"floor":"ceil"](e),i=n/(V-U);b(i*nt,t)},scrollByY:function(e,t){var n=x()+Math[0>e?"floor":"ceil"](e),i=n/(G-W);v(i*Z,t)},positionDragX:function(e,t){b(e,t)},positionDragY:function(e,t){v(e,t)},animate:function(e,t,n,i){var s={};s[t]=n,e.animate(s,{duration:F.animateDuration,easing:F.animateEase,queue:!1,step:i})},getContentPositionX:function(){return S()},getContentPositionY:function(){return x()},getContentWidth:function(){return V},getContentHeight:function(){return G},getPercentScrolledX:function(){return S()/(V-U)},getPercentScrolledY:function(){return x()/(G-W)},getIsScrollableH:function(){return Q},getIsScrollableV:function(){return X},getContentPane:function(){return q},scrollToBottom:function(e){v(Z,e)},hijackInternalLinks:e.noop,destroy:function(){H()}}),o(s)}return i=e.extend({},e.fn.jScrollPane.defaults,i),e.each(["mouseWheelSpeed","arrowButtonSpeed","trackClickSpeed","keyboardSpeed"],function(){i[this]=i[this]||i.speed}),this.each(function(){var t=e(this),n=t.data("jsp");n?n.reinitialise(i):(e("script",t).filter('[type="text/javascript"],:not([type])').remove(),n=new s(t,i),t.data("jsp",n))})},e.fn.jScrollPane.defaults={showArrows:!1,maintainPosition:!0,stickToBottom:!1,stickToRight:!1,clickOnTrack:!0,autoReinitialise:!1,autoReinitialiseDelay:500,verticalDragMinHeight:0,verticalDragMaxHeight:99999,horizontalDragMinWidth:0,horizontalDragMaxWidth:99999,contentWidth:n,animateScroll:!1,animateDuration:300,animateEase:"linear",hijackInternalLinks:!1,verticalGutter:4,horizontalGutter:4,mouseWheelSpeed:0,arrowButtonSpeed:0,arrowRepeatFreq:50,arrowScrollOnHover:!1,trackClickSpeed:0,trackClickRepeatFreq:70,verticalArrowPositions:"split",horizontalArrowPositions:"split",enableKeyboardNavigation:!0,hideFocus:!1,keyboardSpeed:0,initialDelay:300,speed:30,scrollPagePercent:.8}}(jQuery,this),function(e){window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)}),e.fn.item=function(){var t=e(this).tmplItem().data;return e.isFunction(t.reload)?t.reload():null},e.fn.forItem=function(t){return this.filter(function(){var n=e(this).tmplItem().data;return t.eql&&t.eql(n)||t===n?!0:void 0})},e.fn.autolink=function(){return this.each(function(){var t=/((http|https|ftp):\/\/[\w?=&.\/-;#~%-]+(?![\w\s?&.\/;#~%"=-]*>))/g;e(this).html(e(this).html().replace(t,'<a href="$1">$1</a> '))})},e.fn.mailto=function(){return this.each(function(){var t=/(([a-z0-9*._+]){1,}\@(([a-z0-9]+[-]?){1,}[a-z0-9]+\.){1,}([a-z]{2,4}|museum)(?![\w\s?&.\/;#~%"=-]*>))/g;e(this).html(e(this).html().replace(t,'<a href="mailto:$1">$1</a>'))})},e.fn.imagesLoaded=function(e){function t(){e.call(o,i)}function n(){0>=--s&&this.src!==r&&(setTimeout(t),i.unbind("load error",n))}var i=this.find("img"),s=i.length,o=this,r="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return s||t(),i.bind("load error",n).each(function(){if(this.complete||void 0===this.complete){var e=this.src;this.src=r,this.src=e}}),this},e.fn.addScrollExtension=function(){var t=this.jScrollPane({verticalGutter:-9}),n={extPluginOpts:{mouseLeaveFadeSpeed:500,hovertimeout_t:1e3,useTimeout:!1,deviceWidth:980},hovertimeout:null,isScrollbarHover:!1,elementtimeout:null,isScrolling:!1,addHoverFunc:function(){if(e(window).width()<=this.extPluginOpts.deviceWidth)return!1;var n=this;e.fn.jspmouseenter=e.fn.show,e.fn.jspmouseleave=e.fn.fadeOut;var i=this.getContentPane().siblings(".jspVerticalBar").hide();t.bind("mouseenter.jsp",function(){return i.stop(!0,!0).jspmouseenter(),n.extPluginOpts.useTimeout?(clearTimeout(n.hovertimeout),n.hovertimeout=setTimeout(function(){n.isScrolling||i.stop(!0,!0).jspmouseleave(n.extPluginOpts.mouseLeaveFadeSpeed||0)},n.extPluginOpts.hovertimeout_t),void 0):!1}).bind("mouseleave.jsp",function(){n.extPluginOpts.useTimeout?(clearTimeout(n.elementtimeout),n.isScrolling||i.stop(!0,!0).jspmouseleave(n.extPluginOpts.mouseLeaveFadeSpeed||0)):i.stop(!0,!0).jspmouseleave(n.extPluginOpts.mouseLeaveFadeSpeed||0)}),this.extPluginOpts.useTimeout&&(t.bind("scrollstart.jsp",function(){clearTimeout(n.hovertimeout),n.isScrolling=!0,i.stop(!0,!0).jspmouseenter()}).bind("scrollstop.jsp",function(){clearTimeout(n.hovertimeout),n.isScrolling=!1,n.hovertimeout=setTimeout(function(){n.isScrollbarHover||i.stop(!0,!0).jspmouseleave(n.extPluginOpts.mouseLeaveFadeSpeed||0)},n.extPluginOpts.hovertimeout_t)}),e("<div/>").css({position:"absolute",left:i.css("left"),top:i.css("top"),right:i.css("right"),bottom:i.css("bottom"),width:i.width(),height:i.height()}).bind("mouseenter.jsp",function(){clearTimeout(n.hovertimeout),clearTimeout(n.elementtimeout),n.isScrollbarHover=!0,n.elementtimeout=setTimeout(function(){i.stop(!0,!0).jspmouseenter()},100)}).bind("mouseleave.jsp",function(){clearTimeout(n.hovertimeout),n.isScrollbarHover=!1,n.hovertimeout=setTimeout(function(){n.isScrolling||i.stop(!0,!0).jspmouseleave(n.extPluginOpts.mouseLeaveFadeSpeed||0)},n.extPluginOpts.hovertimeout_t)}))}},i=t.data().jsp;return t.find(".jspVerticalBar").css({opacity:"0.8"}),e.extend(!0,i,n),i.addHoverFunc(),i}}(jQuery),function(e){e.ajaxTransport("+*",function(e){var t;return e.useXHR2?{send:function(n,s){t=e.xhr(),t.open(e.type,e.url,e.async),delete n["Content-Type"],n["X-Requested-With"]="XMLHttpRequest";for(i in n)t.setRequestHeader(i,n[i]);var o=function(){var e={xml:t.responseXML,text:t.responseText};s(t.status,t.statusText,e,t.getAllResponseHeaders())};t.addEventListener("load",o),t.addEventListener("error",o),e.progress&&t.addEventListener("progress",e.progress),e.upload&&e.upload.success&&t.upload.addEventListener("load",e.upload.load),e.upload&&e.upload.progress&&t.upload.addEventListener("progress",e.upload.progress),t.send(e.data)},abort:function(){t&&t.abort()}}:void 0});var t={processData:!1,contentType:!1,type:"POST",useXHR2:!0,upload:{}};e.upload=function(n,i,s){var o=new FormData;i instanceof File&&(i={file:i});for(var r in i)o.append(r,i[r]);return"function"==typeof s&&(s={success:s}),s.url=n,s.data=o,s=e.extend({},t,s),e.ajax(s)}}(jQuery),function(e){function t(t,n,i,s){var o={data:s||(n?n.data:{}),_wrap:n?n._wrap:null,tmpl:null,parent:n||null,nodes:[],calls:c,nest:u,wrap:d,html:h,update:p};return t&&e.extend(o,t,{nodes:[],parent:n}),i&&(o.tmpl=i,o._ctnt=o._ctnt||o.tmpl(e,o),o.key=++T,(w.length?b:y)[T]=o),o}function n(t,s,o){var r,a=o?e.map(o,function(e){return"string"==typeof e?t.key?e.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+g+'="'+t.key+'" $2'):e:n(e,t,e._ctnt)}):t;return s?a:(a=a.join(""),a.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,function(t,n,s,o){r=e(s).get(),l(r),n&&(r=i(n).concat(r)),o&&(r=r.concat(i(o)))}),r?r:i(a))}function i(t){var n=document.createElement("div");return n.innerHTML=t,e.makeArray(n.childNodes)}function s(t){return new Function("jQuery","$item","var $=jQuery,call,_=[],$data=$item.data;with($data){_.push('"+e.trim(t).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(t,n,i,s,o,a,l){var c,u,d,h=e.tmpl.tag[i];if(!h)throw"Template command not found: "+i;return c=h._default||[],a&&!/\w$/.test(o)&&(o+=a,a=""),o?(o=r(o),l=l?","+r(l)+")":a?")":"",u=a?o.indexOf(".")>-1?o+a:"("+o+").call($item"+l:o,d=a?u:"(typeof("+o+")==='function'?("+o+").call($item):("+o+"))"):d=u=c.$1||"null",s=r(s),"');"+h[n?"close":"open"].split("$notnull_1").join(o?"typeof("+o+")!=='undefined' && ("+o+")!=null":"true").split("$1a").join(d).split("$1").join(u).split("$2").join(s?s.replace(/\s*([^\(]+)\s*(\((.*?)\))?/g,function(e,t,n,i){return i=i?","+i+")":n?")":"",i?"("+t+").call($item"+i:e}):c.$2||"")+"_.push('"})+"');}return _;")}function o(t,i){t._wrap=n(t,!0,e.isArray(i)?i:[v.test(i)?i:e(i).html()]).join("")}function r(e){return e?e.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function a(e){var t=document.createElement("div");return t.appendChild(e.cloneNode(!0)),t.innerHTML}function l(n){function i(n){function i(e){e+=c,r=u[e]=u[e]||t(r,y[r.parent.key+c]||r.parent,null,!0)}var s,o,r,a,l=n;if(a=n.getAttribute(g)){for(;l.parentNode&&1===(l=l.parentNode).nodeType&&!(s=l.getAttribute(g)););s!==a&&(l=l.parentNode?11===l.nodeType?0:l.getAttribute(g)||0:0,(r=y[a])||(r=b[a],r=t(r,y[l]||b[l],null,!0),r.key=++T,y[T]=r),C&&i(a)),n.removeAttribute(g)}else C&&(r=e.data(n,"tmplItem"))&&(i(r.key),y[r.key]=r,l=e.data(n.parentNode,"tmplItem"),l=l?l.key:0);if(r){for(o=r;o&&o.key!=l;)o.nodes.push(n),o=o.parent;delete r._ctnt,delete r._wrap,e.data(n,"tmplItem",r)}}var s,o,r,a,l,c="_"+C,u={};for(r=0,a=n.length;a>r;r++)if(1===(s=n[r]).nodeType){for(o=s.getElementsByTagName("*"),l=o.length-1;l>=0;l--)i(o[l]);i(s)}}function c(e,t,n,i){return e?(w.push({_:e,tmpl:t,item:this,data:n,options:i}),void 0):w.pop()}function u(t,n,i){return e.tmpl(e.template(t),n,i,this)}function d(t,n){var i=t.options||{};return i.wrapped=n,e.tmpl(e.template(t.tmpl),t.data,i,t.item)}function h(t,n){var i=this._wrap;return e.map(e(e.isArray(i)?i.join(""):i).filter(t||"*"),function(e){return n?e.innerText||e.textContent:e.outerHTML||a(e)})}function p(){var t=this.nodes;e.tmpl(null,null,null,this).insertBefore(t[0]),e(t).remove()}var f,m=e.fn.domManip,g="_tmplitem",v=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,y={},b={},_={key:0,data:{}},T=0,C=0,w=[];e.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(t,n){e.fn[t]=function(i){var s,o,r,a,l=[],c=e(i),u=1===this.length&&this[0].parentNode;if(f=y||{},u&&11===u.nodeType&&1===u.childNodes.length&&1===c.length)c[n](this[0]),l=this;else{for(o=0,r=c.length;r>o;o++)C=o,s=(o>0?this.clone(!0):this).get(),e.fn[n].apply(e(c[o]),s),l=l.concat(s);C=0,l=this.pushStack(l,t,c.selector)}return a=f,f=null,e.tmpl.complete(a),l}}),e.fn.extend({tmpl:function(t,n,i){return e.tmpl(this[0],t,n,i)},tmplItem:function(){return e.tmplItem(this[0])},template:function(t){return e.template(t,this[0])},domManip:function(t,n,i){if(t[0]&&t[0].nodeType){for(var s,o=e.makeArray(arguments),r=t.length,a=0;r>a&&!(s=e.data(t[a++],"tmplItem")););r>1&&(o[0]=[e.makeArray(t)]),s&&C&&(o[2]=function(t){e.tmpl.afterManip(this,t,i)}),m.apply(this,o)}else m.apply(this,arguments);return C=0,!f&&e.tmpl.complete(y),this}}),e.extend({tmpl:function(i,s,r,a){var l,c=!a;if(c)a=_,i=e.template[i]||e.template(null,i),b={};else if(!i)return i=a.tmpl,y[a.key]=a,a.nodes=[],a.wrapped&&o(a,a.wrapped),e(n(a,null,a.tmpl(e,a)));return i?("function"==typeof s&&(s=s.call(a||{})),r&&r.wrapped&&o(r,r.wrapped),l=e.isArray(s)?e.map(s,function(e){return e?t(r,a,i,e):null}):[t(r,a,i,s)],c?e(n(a,null,l)):l):[]},tmplItem:function(t){var n;for(t instanceof e&&(t=t[0]);t&&1===t.nodeType&&!(n=e.data(t,"tmplItem"))&&(t=t.parentNode););return n||_},template:function(t,n){return n?("string"==typeof n?n=s(n):n instanceof e&&(n=n[0]||{}),n.nodeType&&(n=e.data(n,"tmpl")||e.data(n,"tmpl",s(n.innerHTML))),"string"==typeof t?e.template[t]=n:n):t?"string"!=typeof t?e.template(null,t):e.template[t]||e.template(null,v.test(t)?t:e(t)):null},encode:function(e){return(""+e).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")}}),e.extend(e.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){_=_.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(_,$1,$2);_=[];",close:"call=$item.calls();_=call._.concat($item.wrap(call,_));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){_.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){_.push($.encode($1a));}"},"!":{open:""}},complete:function(){y={}},afterManip:function(t,n,i){var s=11===n.nodeType?e.makeArray(n.childNodes):1===n.nodeType?[n]:[];i.call(t,n),l(s),C++}})}(jQuery),function(){var e;e="undefined"!=typeof exports?exports:this.Spine={},e.version="0.0.3";var t=e.$=this.jQuery||this.Zepto,n=e.makeArray=function(e){return Array.prototype.slice.call(e,0)},i=e.Events={bind:function(e,t){var n=e.split(" ");this._callbacks||(this._callbacks={});for(var i=0;n.length>i;i++)(this._callbacks[n[i]]||(this._callbacks[n[i]]=[])).push(t);return this},trigger:function(){var e,t,i,s,o=n(arguments),r=o.shift();if(!(t=this._callbacks))return this;if(!(e=this._callbacks[r]))return this;for(i=0,s=e.length;s>i;i++)if(e[i].apply(this,o)===!1)return!1;return this},unbind:function(e,t){if(!e)return this._callbacks={},this;var n,i,s,o;if(!(i=this._callbacks))return this;if(!(n=this._callbacks[e]))return this;for(s=0,o=n.length;o>s;s++)if(t===n[s]){n.splice(s,1);break}return this}},s=e.Log={trace:!0,logPrefix:"(App)",log:function(){if(this.trace&&"undefined"!=typeof console){var e=n(arguments);return this.logPrefix&&e.unshift(this.logPrefix),console.log.apply(console,e),this}}};"function"!=typeof Object.create&&(Object.create=function(e){function t(){}return t.prototype=e,new t});var o=["included","extended"],r=e.Class={inherited:function(){},created:function(){},prototype:{initializer:function(){},init:function(){}},create:function(e,t){var n=Object.create(this);return n.parent=this,n.prototype=n.fn=Object.create(this.prototype),e&&n.include(e),t&&n.extend(t),n.created(),this.inherited(n),n},init:function(){var e=Object.create(this.prototype);return e.parent=this,e.initializer.apply(e,arguments),e.init.apply(e,arguments),e},proxy:function(e){var t=this;return function(){return e.apply(t,arguments)}},proxyAll:function(){for(var e=n(arguments),t=0;e.length>t;t++)this[e[t]]=this.proxy(this[e[t]])},include:function(e){for(var t in e)-1==o.indexOf(t)&&(this.fn[t]=e[t]);var n=e.included;return n&&n.apply(this),this},extend:function(e){for(var t in e)-1==o.indexOf(t)&&(this[t]=e[t]);var n=e.extended;return n&&n.apply(this),this}};r.prototype.proxy=r.proxy,r.prototype.proxyAll=r.proxyAll,r.inst=r.init,e.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=0|16*Math.random(),n="x"==e?t:8|3&t;return n.toString(16)}).toUpperCase()};var a=e.Model=r.create();a.extend(i),a.createSub=a.create,a.setup=function(e,t){var n=a.createSub();return e&&(n.name=e),t&&(n.attributes=t),n},a.extend({created:function(){this.records={},this.attributes=[],this.bind("create",this.proxy(function(e){this.trigger("change","create",e)})),this.bind("update",this.proxy(function(e){this.trigger("change","update",e)})),this.bind("destroy",this.proxy(function(e){this.trigger("change","destroy",e)}))},find:function(e){var t=this.records[e];if(!t)throw"Unknown record";return t.dup()},exists:function(e){try{return this.find(e)}catch(t){return!1}},refresh:function(e){this.records={};for(var t=0,n=e.length;n>t;t++){var i=this.init(e[t]);i.newRecord=!1,this.records[i.id]=i}this.trigger("refresh")},select:function(e){var t=[];for(var n in this.records)e(this.records[n])&&t.push(this.records[n]);return this.dupArray(t)},findByAttribute:function(e,t){for(var n in this.records)if(this.records[n][e]==t)return this.records[n].dup()},findAllByAttribute:function(e,t){return this.select(function(n){return n[e]==t})},each:function(e){for(var t in this.records)e(this.records[t])},all:function(){return this.dupArray(this.recordsValues())},first:function(){var e=this.recordsValues()[0];return e&&e.dup()},last:function(){var e=this.recordsValues(),t=e[e.length-1];return t&&t.dup()},count:function(){return this.recordsValues().length},deleteAll:function(){for(var e in this.records)delete this.records[e]},destroyAll:function(){for(var e in this.records)this.records[e].destroy()},update:function(e,t){this.find(e).updateAttributes(t)},create:function(e){var t=this.init(e);return t.save(),t},destroy:function(e){this.find(e).destroy()},sync:function(e){this.bind("change",e)},fetch:function(e){e?this.bind("fetch",e):this.trigger("fetch")},toJSON:function(){return this.recordsValues()},recordsValues:function(){var e=[];for(var t in this.records)e.push(this.records[t]);return e},dupArray:function(e){for(var t=[],n=0;e.length>n;n++)t.push(e[n].dup());return t}}),a.include({model:!0,newRecord:!0,init:function(e){e&&this.load(e)},isNew:function(){return this.newRecord},validate:function(){},load:function(e){for(var t in e)this[t]=e[t]},attributes:function(){for(var e={},t=0;this.parent.attributes.length>t;t++){var n=this.parent.attributes[t];e[n]=this[n]}return e.id=this.id,e},eql:function(e){return e&&e.id===this.id&&e.parent===this.parent},save:function(){var e=this.validate();if(e&&!this.trigger("error",e))throw"Validation failed: "+e;this.trigger("beforeSave"),this.newRecord?this.create():this.update(),this.trigger("save")},updateAttribute:function(e,t){return this[e]=t,this.save()},updateAttributes:function(e){return this.load(e),this.save()},destroy:function(){this.trigger("beforeDestroy"),delete this.parent.records[this.id],this.trigger("destroy")},dup:function(){var e=this.parent.init(this.attributes());return e.newRecord=this.newRecord,e},reload:function(){return this.parent.find(this.id)},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent.records},update:function(){this.trigger("beforeUpdate"),this.parent.records[this.id]=this.dup(),this.trigger("update")},create:function(){this.trigger("beforeCreate"),this.id||(this.id=e.guid()),this.newRecord=!1,this.parent.records[this.id]=this.dup(),this.trigger("create")},bind:function(e,t){this.parent.bind(e,this.proxy(function(e){e&&this.eql(e)&&t.apply(this,arguments)}))},trigger:function(){var e=n(arguments);e.splice(1,0,this),this.parent.trigger.apply(this.parent,e)}});var l=/^(\w+)\s*(.*)$/,c=e.Controller=r.create({tag:"div",initializer:function(e){this.options=e;for(var n in this.options)this[n]=this.options[n];this.el||(this.el=document.createElement(this.tag)),this.el=t(this.el),this.events||(this.events=this.parent.events),this.elements||(this.elements=this.parent.elements),this.events&&this.delegateEvents(),this.elements&&this.refreshElements(),this.proxied&&this.proxyAll.apply(this,this.proxied)},$:function(e){return t(e,this.el)},delegateEvents:function(){for(var e in this.events){var t=this.events[e],n=this.proxy(this[t]),i=e.match(l),s=i[1],o=i[2];""===o?this.el.bind(s,n):this.el.delegate(o,s,n)}},refreshElements:function(){for(var e in this.elements)this[this.elements[e]]=this.$(e)},delay:function(e,t){setTimeout(this.proxy(e),t||0)}});c.include(i),c.include(s),e.App=c.create({create:function(e){return this.parent.include(e),this}}).init(),c.fn.App=e.App}();var BranchItem=Spine.Model.setup("IssueItem",["id","Branch_url","created_time_ago","created_at","name","icon_url","memberships_count","sub_tree_size","tree_id","latest","collection_url"]);BranchItem.extend({base_url:"http://localhost:3000/branches/all",get:function(e,t,n,i){$.ajax({type:"GET",url:e,contentType:"application/json",data:i,success:t,error:n})},fakeItem:function(){return{Branch_url:"",created_time_ago:"1 minute ago",memberships_count:"40",sub_tree_size:"0",latest_tip:"The Beginning of time",icon_url:"/assets/image_7.jpg",collection_url:"http://localhost:3000/trees/2/all_branches"}}}),/*!
 * OpenTok JavaScript Library v2.0.4
 * http://www.tokbox.com/
 *
 * Copyright (c) 2011 TokBox, Inc.
 *
 * Date: April 23 08:50:23 2013
 */
function(){var e=this,t=e._,n={},i=Array.prototype,s=Object.prototype,o=Function.prototype,r=i.push,a=i.slice,l=i.concat,c=s.toString,u=s.hasOwnProperty,d=i.forEach,h=i.map,p=i.reduce,f=i.reduceRight,m=i.filter,g=i.every,v=i.some,y=i.indexOf,b=i.lastIndexOf,_=Array.isArray,T=Object.keys,C=o.bind,w=function(e){return e instanceof w?e:this instanceof w?(this._wrapped=e,void 0):new w(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=w),exports._=w):e._=w,w.VERSION="1.4.4";var E=w.each=w.forEach=function(e,t,i){if(null!=e)if(d&&e.forEach===d)e.forEach(t,i);else if(e.length===+e.length){for(var s=0,o=e.length;o>s;s++)if(t.call(i,e[s],s,e)===n)return}else for(var r in e)if(w.has(e,r)&&t.call(i,e[r],r,e)===n)return};w.map=w.collect=function(e,t,n){var i=[];return null==e?i:h&&e.map===h?e.map(t,n):(E(e,function(e,s,o){i[i.length]=t.call(n,e,s,o)}),i)};var O="Reduce of empty array with no initial value";w.reduce=w.foldl=w.inject=function(e,t,n,i){var s=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return i&&(t=w.bind(t,i)),s?e.reduce(t,n):e.reduce(t);if(E(e,function(e,o,r){s?n=t.call(i,n,e,o,r):(n=e,s=!0)}),!s)throw new TypeError(O);return n},w.reduceRight=w.foldr=function(e,t,n,i){var s=arguments.length>2;if(null==e&&(e=[]),f&&e.reduceRight===f)return i&&(t=w.bind(t,i)),s?e.reduceRight(t,n):e.reduceRight(t);var o=e.length;if(o!==+o){var r=w.keys(e);o=r.length}if(E(e,function(a,l,c){l=r?r[--o]:--o,s?n=t.call(i,n,e[l],l,c):(n=e[l],s=!0)}),!s)throw new TypeError(O);return n},w.find=w.detect=function(e,t,n){var i;return S(e,function(e,s,o){return t.call(n,e,s,o)?(i=e,!0):void 0}),i},w.filter=w.select=function(e,t,n){var i=[];return null==e?i:m&&e.filter===m?e.filter(t,n):(E(e,function(e,s,o){t.call(n,e,s,o)&&(i[i.length]=e)}),i)},w.reject=function(e,t,n){return w.filter(e,function(e,i,s){return!t.call(n,e,i,s)},n)},w.every=w.all=function(e,t,i){t||(t=w.identity);var s=!0;return null==e?s:g&&e.every===g?e.every(t,i):(E(e,function(e,o,r){return(s=s&&t.call(i,e,o,r))?void 0:n}),!!s)};var S=w.some=w.any=function(e,t,i){t||(t=w.identity);var s=!1;return null==e?s:v&&e.some===v?e.some(t,i):(E(e,function(e,o,r){return s||(s=t.call(i,e,o,r))?n:void 0}),!!s)};w.contains=w.include=function(e,t){return null==e?!1:y&&e.indexOf===y?-1!=e.indexOf(t):S(e,function(e){return e===t})},w.invoke=function(e,t){var n=a.call(arguments,2),i=w.isFunction(t);return w.map(e,function(e){return(i?t:e[t]).apply(e,n)})},w.pluck=function(e,t){return w.map(e,function(e){return e[t]})},w.where=function(e,t,n){return w.isEmpty(t)?n?null:[]:w[n?"find":"filter"](e,function(e){for(var n in t)if(t[n]!==e[n])return!1;return!0})},w.findWhere=function(e,t){return w.where(e,t,!0)},w.max=function(e,t,n){if(!t&&w.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&w.isEmpty(e))return-1/0;var i={computed:-1/0,value:-1/0};return E(e,function(e,s,o){var r=t?t.call(n,e,s,o):e;r>=i.computed&&(i={value:e,computed:r})}),i.value},w.min=function(e,t,n){if(!t&&w.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&w.isEmpty(e))return 1/0;var i={computed:1/0,value:1/0};return E(e,function(e,s,o){var r=t?t.call(n,e,s,o):e;i.computed>r&&(i={value:e,computed:r})}),i.value},w.shuffle=function(e){var t,n=0,i=[];return E(e,function(e){t=w.random(n++),i[n-1]=i[t],i[t]=e}),i};var x=function(e){return w.isFunction(e)?e:function(t){return t[e]}};w.sortBy=function(e,t,n){var i=x(t);return w.pluck(w.map(e,function(e,t,s){return{value:e,index:t,criteria:i.call(n,e,t,s)}}).sort(function(e,t){var n=e.criteria,i=t.criteria;if(n!==i){if(n>i||void 0===n)return 1;if(i>n||void 0===i)return-1}return e.index<t.index?-1:1}),"value")};var k=function(e,t,n,i){var s={},o=x(t||w.identity);return E(e,function(t,r){var a=o.call(n,t,r,e);i(s,a,t)}),s};w.groupBy=function(e,t,n){return k(e,t,n,function(e,t,n){(w.has(e,t)?e[t]:e[t]=[]).push(n)})},w.countBy=function(e,t,n){return k(e,t,n,function(e,t){w.has(e,t)||(e[t]=0),e[t]++})},w.sortedIndex=function(e,t,n,i){n=null==n?w.identity:x(n);for(var s=n.call(i,t),o=0,r=e.length;r>o;){var a=o+r>>>1;s>n.call(i,e[a])?o=a+1:r=a}return o},w.toArray=function(e){return e?w.isArray(e)?a.call(e):e.length===+e.length?w.map(e,w.identity):w.values(e):[]},w.size=function(e){return null==e?0:e.length===+e.length?e.length:w.keys(e).length},w.first=w.head=w.take=function(e,t,n){return null==e?void 0:null==t||n?e[0]:a.call(e,0,t)},w.initial=function(e,t,n){return a.call(e,0,e.length-(null==t||n?1:t))},w.last=function(e,t,n){return null==e?void 0:null==t||n?e[e.length-1]:a.call(e,Math.max(e.length-t,0))},w.rest=w.tail=w.drop=function(e,t,n){return a.call(e,null==t||n?1:t)},w.compact=function(e){return w.filter(e,w.identity)};var A=function(e,t,n){return E(e,function(e){w.isArray(e)?t?r.apply(n,e):A(e,t,n):n.push(e)}),n};w.flatten=function(e,t){return A(e,t,[])},w.without=function(e){return w.difference(e,a.call(arguments,1))},w.uniq=w.unique=function(e,t,n,i){w.isFunction(t)&&(i=n,n=t,t=!1);var s=n?w.map(e,n,i):e,o=[],r=[];return E(s,function(n,i){(t?i&&r[r.length-1]===n:w.contains(r,n))||(r.push(n),o.push(e[i]))}),o},w.union=function(){return w.uniq(l.apply(i,arguments))},w.intersection=function(e){var t=a.call(arguments,1);return w.filter(w.uniq(e),function(e){return w.every(t,function(t){return w.indexOf(t,e)>=0})})},w.difference=function(e){var t=l.apply(i,a.call(arguments,1));return w.filter(e,function(e){return!w.contains(t,e)})},w.zip=function(){for(var e=a.call(arguments),t=w.max(w.pluck(e,"length")),n=new Array(t),i=0;t>i;i++)n[i]=w.pluck(e,""+i);return n},w.object=function(e,t){if(null==e)return{};for(var n={},i=0,s=e.length;s>i;i++)t?n[e[i]]=t[i]:n[e[i][0]]=e[i][1];return n},w.indexOf=function(e,t,n){if(null==e)return-1;var i=0,s=e.length;if(n){if("number"!=typeof n)return i=w.sortedIndex(e,t),e[i]===t?i:-1;i=0>n?Math.max(0,s+n):n}if(y&&e.indexOf===y)return e.indexOf(t,n);for(;s>i;i++)if(e[i]===t)return i;return-1},w.lastIndexOf=function(e,t,n){if(null==e)return-1;var i=null!=n;if(b&&e.lastIndexOf===b)return i?e.lastIndexOf(t,n):e.lastIndexOf(t);for(var s=i?n:e.length;s--;)if(e[s]===t)return s;return-1},w.range=function(e,t,n){1>=arguments.length&&(t=e||0,e=0),n=arguments[2]||1;for(var i=Math.max(Math.ceil((t-e)/n),0),s=0,o=new Array(i);i>s;)o[s++]=e,e+=n;return o},w.bind=function(e,t){if(e.bind===C&&C)return C.apply(e,a.call(arguments,1));var n=a.call(arguments,2);return function(){return e.apply(t,n.concat(a.call(arguments)))}},w.partial=function(e){var t=a.call(arguments,1);return function(){return e.apply(this,t.concat(a.call(arguments)))}},w.bindAll=function(e){var t=a.call(arguments,1);return 0===t.length&&(t=w.functions(e)),E(t,function(t){e[t]=w.bind(e[t],e)}),e},w.memoize=function(e,t){var n={};return t||(t=w.identity),function(){var i=t.apply(this,arguments);return w.has(n,i)?n[i]:n[i]=e.apply(this,arguments)}},w.delay=function(e,t){var n=a.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},w.defer=function(e){return w.delay.apply(w,[e,1].concat(a.call(arguments,1)))},w.throttle=function(e,t){var n,i,s,o,r=0,a=function(){r=new Date,s=null,o=e.apply(n,i)};return function(){var l=new Date,c=t-(l-r);return n=this,i=arguments,0>=c?(clearTimeout(s),s=null,r=l,o=e.apply(n,i)):s||(s=setTimeout(a,c)),o}},w.debounce=function(e,t,n){var i,s;return function(){var o=this,r=arguments,a=function(){i=null,n||(s=e.apply(o,r))},l=n&&!i;return clearTimeout(i),i=setTimeout(a,t),l&&(s=e.apply(o,r)),s}},w.once=function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}},w.wrap=function(e,t){return function(){var n=[e];return r.apply(n,arguments),t.apply(this,n)}},w.compose=function(){var e=arguments;return function(){for(var t=arguments,n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},w.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},w.keys=T||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)w.has(e,n)&&(t[t.length]=n);return t},w.values=function(e){var t=[];for(var n in e)w.has(e,n)&&t.push(e[n]);return t},w.pairs=function(e){var t=[];for(var n in e)w.has(e,n)&&t.push([n,e[n]]);return t},w.invert=function(e){var t={};for(var n in e)w.has(e,n)&&(t[e[n]]=n);return t},w.functions=w.methods=function(e){var t=[];for(var n in e)w.isFunction(e[n])&&t.push(n);return t.sort()},w.extend=function(e){return E(a.call(arguments,1),function(t){if(t)for(var n in t)e[n]=t[n]}),e},w.pick=function(e){var t={},n=l.apply(i,a.call(arguments,1));return E(n,function(n){n in e&&(t[n]=e[n])}),t},w.omit=function(e){var t={},n=l.apply(i,a.call(arguments,1));for(var s in e)w.contains(n,s)||(t[s]=e[s]);return t},w.defaults=function(e){return E(a.call(arguments,1),function(t){if(t)for(var n in t)null==e[n]&&(e[n]=t[n])}),e},w.clone=function(e){return w.isObject(e)?w.isArray(e)?e.slice():w.extend({},e):e},w.tap=function(e,t){return t(e),e};var D=function(e,t,n,i){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof w&&(e=e._wrapped),t instanceof w&&(t=t._wrapped);var s=c.call(e);if(s!=c.call(t))return!1;switch(s){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var o=n.length;o--;)if(n[o]==e)return i[o]==t;n.push(e),i.push(t);var r=0,a=!0;if("[object Array]"==s){if(r=e.length,a=r==t.length)for(;r--&&(a=D(e[r],t[r],n,i)););}else{var l=e.constructor,u=t.constructor;if(l!==u&&!(w.isFunction(l)&&l instanceof l&&w.isFunction(u)&&u instanceof u))return!1;for(var d in e)if(w.has(e,d)&&(r++,!(a=w.has(t,d)&&D(e[d],t[d],n,i))))break;if(a){for(d in t)if(w.has(t,d)&&!r--)break;a=!r}}return n.pop(),i.pop(),a};w.isEqual=function(e,t){return D(e,t,[],[])},w.isEmpty=function(e){if(null==e)return!0;if(w.isArray(e)||w.isString(e))return 0===e.length;for(var t in e)if(w.has(e,t))return!1;return!0},w.isElement=function(e){return!(!e||1!==e.nodeType)},w.isArray=_||function(e){return"[object Array]"==c.call(e)},w.isObject=function(e){return e===Object(e)},E(["Arguments","Function","String","Number","Date","RegExp"],function(e){w["is"+e]=function(t){return c.call(t)=="[object "+e+"]"}}),w.isArguments(arguments)||(w.isArguments=function(e){return!(!e||!w.has(e,"callee"))}),w.isFunction=function(e){return"function"==typeof e},w.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},w.isNaN=function(e){return w.isNumber(e)&&e!=+e},w.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==c.call(e)},w.isNull=function(e){return null===e},w.isUndefined=function(e){return void 0===e},w.has=function(e,t){return u.call(e,t)},w.noConflict=function(){return e._=t,this},w.identity=function(e){return e},w.times=function(e,t,n){for(var i=Array(e),s=0;e>s;s++)i[s]=t.call(n,s);return i},w.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var I={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};I.unescape=w.invert(I.escape);var N={escape:new RegExp("["+w.keys(I.escape).join("")+"]","g"),unescape:new RegExp("("+w.keys(I.unescape).join("|")+")","g")};w.each(["escape","unescape"],function(e){w[e]=function(t){return null==t?"":(""+t).replace(N[e],function(t){return I[e][t]})}}),w.result=function(e,t){if(null==e)return null;var n=e[t];return w.isFunction(n)?n.call(e):n},w.mixin=function(e){E(w.functions(e),function(t){var n=w[t]=e[t];w.prototype[t]=function(){var e=[this._wrapped];return r.apply(e,arguments),L.call(this,n.apply(w,e))}})};var M=0;w.uniqueId=function(e){var t=++M+"";return e?e+t:t},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var j=/(.)^/,P={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},R=/\\|'|\r|\n|\t|\u2028|\u2029/g;w.template=function(e,t,n){var i;n=w.defaults({},n,w.templateSettings);var s=new RegExp([(n.escape||j).source,(n.interpolate||j).source,(n.evaluate||j).source].join("|")+"|$","g"),o=0,r="__p+='";e.replace(s,function(t,n,i,s,a){return r+=e.slice(o,a).replace(R,function(e){return"\\"+P[e]}),n&&(r+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),i&&(r+="'+\n((__t=("+i+"))==null?'':__t)+\n'"),s&&(r+="';\n"+s+"\n__p+='"),o=a+t.length,t}),r+="';\n",n.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+r+"return __p;\n";try{i=new Function(n.variable||"obj","_",r)}catch(a){throw a.source=r,a}if(t)return i(t,w);var l=function(e){return i.call(this,e,w)};return l.source="function("+(n.variable||"obj")+"){\n"+r+"}",l},w.chain=function(e){return w(e).chain()};var L=function(e){return this._chain?w(e).chain():e};w.mixin(w),E(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=i[e];w.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!=e&&"splice"!=e||0!==n.length||delete n[0],L.call(this,n)}}),E(["concat","join","slice"],function(e){var t=i[e];w.prototype[e]=function(){return L.call(this,t.apply(this._wrapped,arguments))}}),w.extend(w.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this),/*
 *  This is a modified version of Robert Kieffer awesome uuid.js library.
 *  The only modifications we've made are to remove the Node.js specific
 *  parts of the code and the UUID version 1 generator (which we don't
 *  use). The original copyright notice is below.
 *
 *     node-uuid/uuid.js
 *
 *     Copyright (c) 2010 Robert Kieffer
 *     Dual licensed under the MIT and GPL licenses.
 *     Documentation and details at https://github.com/broofa/node-uuid
 */
function(){function e(e,t,n){var i=t&&n||0,s=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){16>s&&(t[i+s++]=d[e])});16>s;)t[i+s++]=0;return t}function t(e,t){var n=t||0,i=u;return i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]}function n(e,n,i){var s=n&&i||0;"string"==typeof e&&(n="binary"==e?new c(16):null,e=null),e=e||{};var o=e.random||(e.rng||l)();if(o[6]=64|15&o[6],o[8]=128|63&o[8],n)for(var r=0;16>r;r++)n[s+r]=o[r];return n||t(o)}var i,s,o=this,r=new Array(16);if(i=function(){var e,t=r,n=0;for(n=0;16>n;n++)0===(3&n)&&(e=4294967296*Math.random()),t[n]=255&e>>>((3&n)<<3);return t},o.crypto&&crypto.getRandomValues){var a=new Uint32Array(4);s=function(){crypto.getRandomValues(a);for(var e=0;16>e;e++)r[e]=255&a[e>>2]>>>8*(3&e);return r}}for(var l=s||i,c="function"==typeof Buffer?Buffer:Array,u=[],d={},h=0;256>h;h++)u[h]=(h+256).toString(16).substr(1),d[u[h]]=h;var p=n;p.v4=n,p.parse=e,p.unparse=t,p.BufferClass=c,p.mathRNG=i,p.whatwgRNG=s;var f=o.uuid;p.noConflict=function(){return o.uuid=f,p},o.uuid=p}(),function(e){"file:"===location.protocol&&alert("You cannot test a page using WebRTC through the file system due to browser permissions. You must run it over a web server."),!e.URL&&e.webkitURL&&(e.URL=e.webkitURL);var t,n=document.location.hash,i={initSession:function(e){return this.sessions[e]||(this.sessions[e]=new i.Session(e)),this.sessions[e]},initPublisher:function(e,t,n){i.debug("TB.initPublisher("+t+")");var s=new i.rtc.Publisher;return s.publish(t,n),s},checkSystemRequirements:function(){i.debug("TB.checkSystemRequirements()");var e=i.$.supportsWebSockets()&&i.$.supportsWebRTC()?this.HAS_REQUIREMENTS:this.NOT_HAS_REQUIREMENTS;return i.checkSystemRequirements=function(){return i.debug("TB.checkSystemRequirements()"),e},e},upgradeSystemRequirements:function(){i.onLoad(function(){for(var e=!1,s=document.getElementsByTagName("meta"),o=0;s.length>o;o++){var r=s[o].httpEquiv,a=s[o].content;if(r&&"x-ua-compatible"==r.toLowerCase()&&a&&a.toLowerCase().indexOf("chrome=1")>-1){e=!0;break}}var l="_upgradeFlash";document.body.appendChild(function(){var t=document.createElement("iframe");t.id=l,t.style.position="absolute",t.style.position="fixed",t.style.height="100%",t.style.width="100%",t.style.top="0px",t.style.left="0px",t.style.right="0px",t.style.bottom="0px",t.style.zIndex=1e3;try{t.style.backgroundColor="rgba(0,0,0,0.2)"}catch(n){t.style.backgroundColor="transparent",t.setAttribute("allowTransparency","true")}return t.setAttribute("frameBorder","0"),t.frameBorder="0",t.scrolling="no",t.setAttribute("scrolling","no"),t.src=i.BUILD_PROPERTIES.widgetURL+"/html/upgradeFlash.html"+(e?"?cf=1":"")+"#"+encodeURIComponent(document.location.href),t}()),t&&clearInterval(t),t=setInterval(function(){var e=document.location.hash,t=/^#?\d+&/;e!==n&&t.test(e)&&(n=e,"close_window"===e.replace(t,"")?(document.body.removeChild(document.getElementById(l)),document.location.hash=""):"installed_gcf"===e.replace(t,"")&&(document.location.hash="",document.location.href=document.location.href.replace("#","")))},100)})},reportIssue:function(){i.warn("ToDo: haven't yet implemented TB.reportIssue")},components:{},sessions:{},rtc:{},behaviours:{},APIKEY:function(){var e=function(){var e=document.getElementsByTagName("script");return e=e[e.length-1],e=e.getAttribute("src")||e.src}(),t=e.match(/[\?\&]apikey=([^&]+)/i);return t?t[1]:""}(),HAS_REQUIREMENTS:1,NOT_HAS_REQUIREMENTS:0};i._=_.noConflict(),e.OT=i,e.TB=i}(window),OT.BUILD_PROPERTIES={baseURL:"http://www.tokbox.com",apiURL:"http://anvil.opentok.com",messagingServer:"staging.tokbox.com",loggingURL:"http://hlg.tokbox.com/prod",widgetURL:"http://static.opentok.com/webrtc/v2.0.4",version:"v2.0.4",debug:!1},window.location.protocol.indexOf("https")>=0&&(OT.BUILD_PROPERTIES.widgetURL="https://swww.tokbox.com/webrtc/v2.0.4",OT.BUILD_PROPERTIES.loggingURL="https://api.opentok.com/hl",OT.BUILD_PROPERTIES.apiURL="https://anvil.opentok.com"),OT.BUILD_PROPERTIES.configURL=OT.BUILD_PROPERTIES.widgetURL+"/js/dynamic_config.min.js",OT.BUILD_PROPERTIES.cssURL=OT.BUILD_PROPERTIES.widgetURL+"/css",function(e){OT.$=function(e){return document.getElementById(e)},OT.$.noop=function(){},OT.$.supportsWebSockets=function(){return"WebSocket"in e},OT.$.now=function(){var t=e.performance||{},n=t.now||t.mozNow||t.msNow||t.oNow||t.webkitNow;return n?n.bind(t):function(){return(new Date).getTime()}}(),OT.$.browser=function(){var t,n=e.navigator.userAgent.toLowerCase(),i="Unknown";return n.indexOf("firefox")>-1&&(i="Firefox"),n.indexOf("opera")>-1?i="Opera":n.indexOf("msie")>-1?i="IE":n.indexOf("chrome")>-1&&(i="Chrome"),(t=e.navigator.vendor)&&t.toLowerCase().indexOf("apple")>-1&&(i="Safari"),n=null,OT.$.browser=function(){return i},i},OT.$.moreInfoLink=function(e){var t=e?e.apiKey:OT.APIKEY,n=["http://www.tokbox.com/opentok/info"];return n[0]+="?guid=a80c00ad22a3e7dcee262f5f7c549c94c794d663",e&&(n.push("session_id="+e.id),e.connected&&n.push("connection_id="+e.connection.id)),n.push("partner_id="+t),n.push("utm_source="+t),n.push("utm_medium="+OT.$.browser()),OT.BUILD_PROPERTIES.widgetURL.indexOf("static")>-1?n.push("utm_campaign=static"):n.push("utm_campaign=staging"),n.join("&")},OT.$.deepClone=function(e){if(!OT._.isObject(e))return e;var t=OT._.isArray(e)?[]:{};for(var n in e)e.hasOwnProperty(n)&&(t[n]=OT._.isObject(e[n])?this.deepClone(e[n]):e[n]);return t},OT.$.JSONify=e.JSON&&e.JSON.stringify?e.JSON.stringify:function(e){var t="{ ";for(var n in e)t+="boolean"==typeof e[n]?'"'+n+'":'+e[n]+", ":'"'+n+'":"'+e[n].toString()+'", ';return t=t.length>1?t.substring(0,t.length-2)+" }":"{}"},OT.$.tbAlert=function(e,t){var n=new OT.Modal(e,"<div>"+t+"</div>");OT.$.addClass(n.el,"OT_tbalert");var i=OT.$.createElement("input",{className:"OT_closeButton",type:"button",value:"close"});n.el.appendChild(i),i.onclick=function(){n&&n.close(),n=null}},OT.$.canDefineProperty=!0;try{Object.defineProperty({},"x",{})}catch(t){OT.$.canDefineProperty=!1}Object.create||(Object.create=function(e){function t(){}if(arguments.length>1)throw new Error("Object.create implementation only accepts the first parameter.");return t.prototype=e,new t})}(window),function(){OT.eventing=function(e){function t(e,t){e&&e.apply(null,t.slice())}function n(e,n,i,s){if(e&&0!==e.length){var o=e.length,r=o;OT._.forEach(e,function(e){setTimeout(function(){try{e.apply(null,n)}finally{r--,0===r&&t(s,n)}},1)})}}function i(e){s[e]&&delete s[e]}var s={};return e.dispatchEvent=function(e,i){if(!e.type)throw OT.error("OT.Eventing.dispatchEvent: Event has no type"),OT.error(e),new Error("OT.Eventing.dispatchEvent: Event has no type");return e.target||(e.target=this),s[e.type]&&0!==s[e.type].length?(n(s[e.type],[e],e.type,i),this):(t(i,[e]),void 0)},e.trigger=function(e){if(s[e]&&0!==s[e].length){var t=Array.prototype.slice.call(arguments);return t.shift(),n(s[e],t,e),this}},e.on=function(e,t){if("string"==typeof e&&t)this.addEventListener(e,t);else for(var n in e)e.hasOwnProperty(n)&&this.addEventListener(n,e[n]);return this},e.off=function(e,t){if("string"==typeof e)t?this.removeEventListener(e,t):i(e);else for(var n in e)e.hasOwnProperty(n)&&this.removeEventListener(n,e[n]);return this},e.addEventListener=function(e,t){s[e]||(s[e]=[]),s[e].push(t)},e.removeEventListener=function(e,t){s[e]&&(s[e]=OT._.without(s[e],t))},e},OT.eventing(OT)}(window),function(){OT.Event=function(e,t){this.type=e,this.cancelable=void 0!==t?t:!0;var n=!1,i=null;this.preventDefault=function(){this.cancelable?n=!0:OT.warn("Event.preventDefault :: Trying to preventDefault on an Event that isn't cancelable")},this.isDefaultPrevented=function(){return n},OT.$.canDefineProperty&&Object.defineProperty(this,"target",{set:function(e){i=e},get:function(){return i}})},OT.Event.names={ACTIVE:"active",INACTIVE:"inactive",UNKNOWN:"unknown",PER_SESSION:"perSession",PER_STREAM:"perStream",EXCEPTION:"exception",ISSUE_REPORTED:"issueReported",SESSION_CONNECTED:"sessionConnected",SESSION_DISCONNECTED:"sessionDisconnected",STREAM_CREATED:"streamCreated",STREAM_DESTROYED:"streamDestroyed",CONNECTION_CREATED:"connectionCreated",CONNECTION_DESTROYED:"connectionDestroyed",SIGNAL_RECEIVED:"signalReceived",STREAM_PROPERTY_CHANGED:"streamPropertyChanged",MICROPHONE_LEVEL_CHANGED:"microphoneLevelChanged",ARCHIVE_CREATED:"archiveCreated",ARCHIVE_CLOSED:"archiveClosed",ARCHIVE_LOADED:"archiveLoaded",ARCHIVE_SAVED:"archiveSaved",SESSION_RECORDING_STARTED:"sessionRecordingStarted",SESSION_RECORDING_STOPPED:"sessionRecordingStopped",SESSION_RECORDING_IN_PROGRESS:"sessionRecordingInProgress",STREAM_RECORDING_IN_PROGRESS:"streamRecordingInProgress",SESSION_NOT_RECORDING:"sessionNotRecording",STREAM_NOT_RECORDING:"streamNotRecording",STREAM_RECORDING_STARTED:"streamRecordingStarted",STREAM_RECORDING_STOPPED:"streamRecordingStopped",PLAYBACK_STARTED:"playbackStarted",PLAYBACK_PAUSED:"playbackPaused",PLAYBACK_STOPPED:"playbackStopped",RECORDING_STARTED:"recordingStarted",RECORDING_STOPPED:"recordingStopped",RESIZE:"resize",SETTINGS_BUTTON_CLICK:"settingsButtonClick",DEVICE_INACTIVE:"deviceInactive",INVALID_DEVICE_NAME:"invalidDeviceName",ACCESS_ALLOWED:"accessAllowed",ACCESS_DENIED:"accessDenied",ACCESS_DIALOG_OPENED:"accessDialogOpened",ACCESS_DIALOG_CLOSED:"accessDialogClosed",ECHO_CANCELLATION_MODE_CHANGED:"echoCancellationModeChanged",DEVICES_DETECTED:"devicesDetected",DEVICES_SELECTED:"devicesSelected",CLOSE_BUTTON_CLICK:"closeButtonClick",MICLEVEL:"microphoneActivityLevel",MICGAINCHANGED:"microphoneGainChanged",DYNAMIC_CONFIG_CHANGED:"dynamicConfigChanged",DYNAMIC_CONFIG_LOAD_FAILED:"dynamicConfigLoadFailed",ENV_LOADED:"envLoaded"},OT.ValueEvent=function(e,t){OT.Event.call(this,e),this.value=t},OT.ExceptionCodes={JS_EXCEPTION:2e3,AUTHENTICATION_ERROR:1004,INVALID_SESSION_ID:1005,CONNECT_FAILED:1006,CONNECT_REJECTED:1007,CONNECTION_TIMEOUT:1008,P2P_CONNECTION_FAILED:1013,API_RESPONSE_FAILURE:1014,UNABLE_TO_PUBLISH:1500,UNABLE_TO_SIGNAL:1510,UNABLE_TO_FORCE_DISCONNECT:1520,UNABLE_TO_FORCE_UNPUBLISH:1530},OT.ExceptionEvent=function(e,t,n,i,s){OT.Event.call(this,e),this.message=t,this.title=n,this.code=i,this.component=s},OT.IssueReportedEvent=function(e,t){OT.Event.call(this,e),this.issueId=t},OT.EnvLoadedEvent=function(e){OT.Event.call(this,e)},OT.DynamicConfigChangedEvent=function(e){OT.Event.call(this,e)},OT.DynamicConfigLoadFailedEvent=function(e){OT.Event.call(this,e)},OT.ConnectionEvent=function(e,t,n){OT.Event.call(this,e),this.connections=t,this.reason=n},OT.StreamEvent=function(e,t,n,i){OT.Event.call(this,e,i),this.streams=t,this.reason=n},OT.SessionConnectEvent=function(e,t,n,i){OT.Event.call(this,e),this.connections=t,this.streams=n,this.archives=i,this.groups=[]},OT.SessionDisconnectEvent=function(e,t,n){OT.Event.call(this,e,n),this.reason=t},OT.VolumeEvent=function(e,t,n){OT.Event.call(this,e),this.streamId=t,this.volume=n},OT.DeviceEvent=function(e,t,n){OT.Event.call(this,e),this.camera=t,this.microphone=n},OT.DeviceStatusEvent=function(e,t,n,i,s){OT.Event.call(this,e),this.cameras=t,this.microphones=n,this.selectedCamera=i,this.selectedMicrophone=s},OT.ResizeEvent=function(e,t,n,i,s){OT.Event.call(this,e),this.widthFrom=t,this.widthTo=n,this.heightFrom=i,this.heightTo=s},OT.StreamPropertyChangedEvent=function(e,t,n,i,s){OT.Event.call(this,e),this.type=e,this.stream=t,this.changedProperty=n,this.oldValue=i,this.newValue=s},OT.ArchiveEvent=function(e,t){OT.Event.call(this,e),this.archives=t},OT.ArchiveStreamEvent=function(e,t,n){OT.Event.call(this,e),this.archive=t,this.streams=n},OT.StateChangedEvent=function(e,t){OT.Event.call(this,e),this.changedValues=t},OT.ChangeFailedEvent=function(e,t,n,i){OT.Event.call(this,e),this.reasonCode=t,this.reason=n,this.failedValues=i}}(window),function(){OT.Config=function(){var e,t,n=4e3,i=!1,s={},o={},r=document.head||document.getElementsByTagName("head")[0],a=function(){t&&(clearTimeout(t),t=null)},l=function(){a(),e&&(e.onload=e.onreadystatechange=null,r&&e.parentNode&&r.removeChild(e),e=void 0)},c=function(){(!e.readyState||/loaded|complete/.test(e.readyState))&&(a(),i||d._onLoadTimeout())},u=function(e,t){return t&&o[t]&&o[t][e]?o[t][e]:s[e]},d={load:function(){i=!1,setTimeout(function(){e=document.createElement("script"),e.async="async",e.src=OT.BUILD_PROPERTIES.configURL,e.onload=e.onreadystatechange=OT._.bind(c,this),r.appendChild(e)},1),t=setTimeout(function(){d._onLoadTimeout()},n)},_onLoadTimeout:function(){l(),OT.warn("TB DynamicConfig failed to load in "+n+" ms"),this.dispatchEvent(new OT.DynamicConfigLoadFailedEvent(OT.Event.names.DYNAMIC_CONFIG_LOAD_FAILED))},isLoaded:function(){return i},reset:function(){l(),i=!1,s={},o={}},replaceWith:function(e){l(),e||(e={}),s=e.global||{},o=e.partners||{},i||(i=!0),this.dispatchEvent(new OT.DynamicConfigChangedEvent(OT.Event.names.DYNAMIC_CONFIG_CHANGED))},get:function(e,t,n){var i=u(e,n);return i?i[t]:null}};return OT.eventing(d),d}()}(window),function(){OT.WebSocketMessageType={CONNECTED_TO_WEBSOCKET_SERVER:1e3,CONNECT_TO_SESSION:1001,SIGNAL:1002,CONNECTION_CREATED:1003,CONNECTION_DESTROYED:1004,CONNECTION_COUNT_CHANGED:1005,STREAM_CREATED:1006,STREAM_MODIFIED:1007,STREAM_DESTROYED:1008,FORCE_DISCONNECT:1009,FORCE_UNPUBLISH:1010,JSEP_OFFER:1011,JSEP_ANSWER:1012,JSEP_PRANSWER:1013,JSEP_CANDIDATE:1014,JSEP_SUBSCRIBE:1015,JSEP_UNSUBSCRIBE:1016,WEBSOCKET_PING:1017,WEBSOCKET_PONG:1018,STREAM_REGISTERED:1019,SESSION_CONNECT_FAILED:1100,PUBLISH_FAILED:1101,SUBSCRIBE_FAILED:1102,FORCEDISCONNECT_FAILED:1103,FORCEUNPUBLISH_FAILED:1104}}(window),function(){OT.WebSocketMessage=function(e,t){this.type=e,this.payload=t,this.toString=function(){return JSON.stringify(this)}},OT.WebSocketMessage.connectToSessionMessage=function(e,t,n,i,s){return{type:OT.WebSocketMessageType.CONNECT_TO_SESSION,payload:{sessionId:e,apiKey:t,token:n,supportsWebRTC:OT.$.supportsWebRTC(),connectionObjects:i,p2pEnabled:s}}},OT.WebSocketMessage.signalMessage=function(e,t,n){return{type:OT.WebSocketMessageType.SIGNAL,payload:{fromAddress:e,toAddresses:t,messagePayload:n}}},OT.WebSocketMessage.createStream=function(e,t,n,i,s,o,r,a){var l={type:OT.WebSocketMessageType.STREAM_CREATED,payload:{publisherId:e,name:t,orientation:{videoOrientation:n,width:i,height:s},hasAudio:o,hasVideo:r,p2pEnabled:a}};return l},OT.WebSocketMessage.modifyStream=function(e,t,n){var i={type:OT.WebSocketMessageType.STREAM_MODIFIED,payload:{streamId:e,key:t,value:n}};return i},OT.WebSocketMessage.destroyStream=function(e){return{type:OT.WebSocketMessageType.STREAM_DESTROYED,payload:{streamId:e}}},OT.WebSocketMessage.jsepMessage=function(e,t,n,i){i.fromAddress=e,i.toAddresses=t;var s={type:n,payload:i};return s},OT.WebSocketMessage.forceDisconnect=function(e){return{type:OT.WebSocketMessageType.FORCE_DISCONNECT,payload:{connectionId:e}}},OT.WebSocketMessage.forceUnpublish=function(e){return{type:OT.WebSocketMessageType.FORCE_UNPUBLISH,payload:{streamId:e}}},OT.WebSocketMessage.pingMessage=function(e,t){return{type:OT.WebSocketMessageType.WEBSOCKET_PING,payload:{message:t,timestamp:(+Date.now()).toString()}}},OT.WebSocketMessage.pongMessage=function(e,t){return{type:OT.WebSocketMessageType.WEBSOCKET_PONG,payload:{message:e,timestamp:parseInt(t,10)}}}}(window),function(e){OT.Messenger=function(t,n){function i(){OT.debug("WebSocket connected"),clearTimeout(_),_=setTimeout(function(){x("Failure","reason","Connection to the server timed out waiting to receive connected message."),k.trigger("exception","Connection to the server timed out waiting to receive connected message.",OT.ExceptionCodes.CONNECTION_TIMEOUT)},15e3)}function s(){k.trigger("exception","TB.Socket Error :: The socket to "+t+" received an error.",OT.ExceptionCodes.CONNECT_FAILED)}function o(){clearTimeout(T),k.trigger("ConnectionClosed",{reason:C?"clientDisconnected":"networkDisconnected"})}function r(e){OT.warn("WebSocket message recieved: "+e.data),a(e.data)}function a(e){var t=JSON.parse(e);switch(t.type){case OT.WebSocketMessageType.CONNECTED_TO_WEBSOCKET_SERVER:h(t.payload);break;case OT.WebSocketMessageType.WEBSOCKET_PONG:S=+Date.now();break;case OT.WebSocketMessageType.CONNECT_TO_SESSION:clearTimeout(_),O=!0,d();default:if(p.hasOwnProperty(t.type)){var i=p[t.type].type;OT.debug("Received "+i),!O&&p[t.type].afterConnected?l(e):k.trigger(i,n.wrangle(t.payload))}else OT.debug("Message type "+t.type+" was not handled.");t.type===OT.WebSocketMessageType.CONNECT_TO_SESSION&&c()}}function l(e){E.push(e)}function c(){for(;E.length>0;)a(E.shift())}function u(){return S?+Date.now()-S>=g:!1}function d(){u()?(OT.error("We seem to have lost connectivity!"),o()):(k.sendMessage(OT.WebSocketMessage.pingMessage(k.connectionId,"ping!")),T=setTimeout(d,m))}function h(e){k.connectionId=e.connectionId,x("Success","webSocketServerUrl",_webSocketUrl,{connectionId:e.connectionId}),clearTimeout(_),_=setTimeout(function(){x("Failure","reason","Connection to the server timed out waiting to receive connected message."),k.trigger("exception","Connection to the server timed out fetching the session state.",OT.ExceptionCodes.CONNECTION_TIMEOUT)},15e3),k.sendMessage(OT.WebSocketMessage.connectToSessionMessage(v,OT.APIKEY,y,b.requireConnectionObjects,b.p2pEnabled))}var p={};p[OT.WebSocketMessageType.CONNECT_TO_SESSION]={type:"SessionConnected",afterConnected:!1},p[OT.WebSocketMessageType.SESSION_CONNECT_FAILED]={type:"SessionConnectFailed",afterConnected:!1},p[OT.WebSocketMessageType.CONNECTION_CREATED]={type:"ConnectionCreated",afterConnected:!0},p[OT.WebSocketMessageType.CONNECTION_DESTROYED]={type:"ConnectionDestroyed",afterConnected:!0},p[OT.WebSocketMessageType.STREAM_CREATED]={type:"StreamCreated",afterConnected:!0},p[OT.WebSocketMessageType.STREAM_MODIFIED]={type:"StreamModified",afterConnected:!0},p[OT.WebSocketMessageType.STREAM_DESTROYED]={type:"StreamDestroyed",afterConnected:!0},p[OT.WebSocketMessageType.STREAM_REGISTERED]={type:"StreamRegistered",afterConnected:!0},p[OT.WebSocketMessageType.JSEP_OFFER]={type:"JSEPMessageReceived",afterConnected:!0},p[OT.WebSocketMessageType.JSEP_ANSWER]={type:"JSEPMessageReceived",afterConnected:!0},p[OT.WebSocketMessageType.JSEP_PRANSWER]={type:"JSEPMessageReceived",afterConnected:!0},p[OT.WebSocketMessageType.JSEP_CANDIDATE]={type:"JSEPMessageReceived",afterConnected:!0},p[OT.WebSocketMessageType.JSEP_SUBSCRIBE]={type:"JSEPMessageReceived",afterConnected:!0},p[OT.WebSocketMessageType.JSEP_UNSUBSCRIBE]={type:"JSEPMessageReceived",afterConnected:!0},p[OT.WebSocketMessageType.SIGNAL]={type:"SignalReceived",afterConnected:!0};var f=8081,m=25e3,g=3*m-100;OT.eventing(this),this.onSessionConnected=null,this.onConnectionClosed=null,this.webSocket=null,this.connectionId=null;var v,y,b,_,T,C=!1,w=new OT.Analytics,E=[],O=!1,S=null,x=function(e,t,n,i){var s={action:"webSocketConnection",variation:e,payload_type:t,payload:n,session_id:v,partner_id:b.partnerId,widget_id:b.widgetId,widget_type:"Controller"};i&&(s=OT._.extend(i,s)),w.logEvent(s)};this.connect=function(n,a,l){v=n,y=a,b=l,_webSocketUrl="ws://"+t+":"+f+"/rumorwebsockets";var c=[_webSocketUrl,navigator.userAgent,OT.BUILD_PROPERTIES.version,e.externalHost?"yes":"no"];x("Attempt","webSocketServerUrl|userAgent|sdkVersion|chromeFrame",c.map(function(e){return e.replace("|","\\|")}).join("|")),this.webSocket=new WebSocket(_webSocketUrl),this.webSocket.onopen=i,this.webSocket.onclose=o,this.webSocket.onerror=s,this.webSocket.onmessage=r,_=setTimeout(function(){x("Failure","reason","Connection to the server timed out waiting to receive connected message."),k.trigger("exception","Connection to the server timed out.",OT.ExceptionCodes.CONNECTION_TIMEOUT)},15e3)},this.disconnect=function(){C=!0,this.webSocket&&(this.webSocket.close(),this.webSocket=null)},this.sendMessage=function(e){OT.warn("Sending WebSocket message: "+JSON.stringify(e)),this.webSocket.send(JSON.stringify(e))};var k=this}}(window),function(e){function t(t,i,o){return function(){if(n(i)){var r=e.console;r&&r[t]?r[t].apply||Function.prototype.bind?(r[t].apply||(r[t]=Function.prototype.bind.call(r[t],r)),r[t].apply(r,arguments)):r[t](Array.prototype.slice.apply(arguments).join(" ")):o&&o.apply(OT,arguments),s(t,arguments)}}}function n(e){return o>=e}function i(){var e=new Date;return e.toLocaleTimeString()+e.getMilliseconds()}function s(e,t){if(t){var n;try{n=OT.$.JSONify(t)}catch(s){n=t.toString()}2>=n.length||r.push([e,i(),n])}}OT.DEBUG=5,OT.LOG=4,OT.INFO=3,OT.WARN=2,OT.ERROR=1,OT.NONE=0;var o=OT.NONE,r=[],a=!1;OT.log=t("log",OT.LOG),OT.debug=t("debug",OT.DEBUG,OT.log),OT.info=t("info",OT.INFO,OT.log),OT.warn=t("warn",OT.WARN,OT.log),OT.error=t("error",OT.ERROR,OT.log),OT.setLogLevel=function(e){return o="number"==typeof e?e:0,n(OT.DEBUG)&&!a&&(OT.debug("OpenTok JavaScript library "+OT.BUILD_PROPERTIES.version),OT.debug("Release notes: "+OT.BUILD_PROPERTIES.baseURL+"/opentok/webrtc/docs/js/release-notes.html"),OT.debug("Known issues: "+OT.BUILD_PROPERTIES.baseURL+"/opentok/webrtc/docs/js/release-notes.html#knownIssues"),a=!0),OT.debug("TB.setLogLevel("+o+")"),o},OT.getLogs=function(){return r},OT.setLogLevel(OT.BUILD_PROPERTIES.debug?OT.DEBUG:OT.ERROR)}(window),function(){OT.$.castToBoolean=function(e,t){return void 0===e?t:"true"===e||e===!0}}(window),function(){OT.$.supportsClassList=function(){var e=typeof("undefined"!==document)&&"classList"in document.createElement("a");return OT.$.supportsClassList=function(){return e},e},OT.$.removeElement=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)},OT.$.removeElementById=function(e){this.removeElement(OT.$(e))},OT.$.removeElementsByType=function(e,t){if(e)for(var n=e.getElementsByTagName(t);n.length;)e.removeChild(n[0])},OT.$.emptyElement=function(e){for(;e.firstChild;)e.removeChild(e.firstChild);return e},OT.$.createElement=function(e,t,n){var i=document.createElement(e);for(var s in t)if("object"==typeof t[s]){i[s]||(i[s]={});var o=t[s];for(var r in o)i[s][r]=o[r]}else"className"===s?i.className=t[s]:i.setAttribute(s,t[s]);return n&&(i.innerHTML=n),i},OT.$.createButton=function(e,t,n){var i=OT.$.createElement("button",t,e);if(n){for(var s in n)n.hasOwnProperty(s)&&OT.$.on(i,s,n[s]);i._boundEvents=n}return i},OT.$.on=function(e,t,n){if(e.addEventListener)e.addEventListener(t,n,!1);else if(e.attachEvent)e.attachEvent("on"+t,n);else{var i=e["on"+t];e["on"+t]=function(){n.apply(this,arguments),i&&i.apply(this,arguments)}}}}(window),function(){OT.$.addClass=function(e,t){if(1===e.nodeType){var n,i=t.trim().split(/\s+/);if(!OT.$.supportsClassList()){if(e.className||1!==i.length){var s=" "+e.className+" ";for(n=0,l=i.length;l>n;++n)~s.indexOf(" "+i[n]+" ")||(s+=i[n]+" ");e.className=s.trim()}else e.className=t;return this}for(n=0,l=i.length;l>n;++n)e.classList.add(i[n])}},OT.$.removeClass=function(e,t){if(t&&1===e.nodeType){var n,i=t.trim().split(/\s+/);if(!OT.$.supportsClassList()){var s=(" "+e.className+" ").replace(/[\s+]/," ");for(n=0,l=i.length;l>n;++n)s=s.replace(" "+i[n]+" "," ");return e.className=s.trim(),this}for(n=0,l=i.length;l>n;++n)e.classList.remove(i[n])}};var e=function(e){return e.offsetWidth>0?e.offsetWidth+"px":OT.$.css(e,"width")},t=function(e){return e.offsetHeight>0?e.offsetHeight+"px":OT.$.css(e,"height")};OT.$.width=function(t){return 0!==t.offsetWidth?e(t):OT.$.makeVisibleAndYield(t,function(){return e(t)})},OT.$.height=function(e){return 0!==e.offsetHeight?t(e):OT.$.makeVisibleAndYield(e,function(){return t(e)})},OT.$.centerElement=function(e,t,n){t||(t=parseInt(OT.$.width(e),10)),n||(n=parseInt(OT.$.height(e),10));var i=-.5*t+"px",s=-.5*n+"px";OT.$.css(e,"margin",s+" 0 0 "+i),OT.$.addClass(e,"OT_centered")}}(window),function(){var e={};OT.$.show=function(t){var n=t.style.display;return(""===n||"none"===n)&&(t.style.display=e[t]||"",delete e[t]),this},OT.$.hide=function(t){return"none"!==t.style.display?(e[t]=OT.$.css(t,"display"),t.style.display="none",this):void 0},OT.$.css=function(e,t,n){if("string"!=typeof t){var i=e.style;for(var s in t)i[s]=t[s];return this}if(n)return e.style[t]=n,this;var o=t.replace(/([A-Z]|^ms)/g,"-$1").toLowerCase(),r=e.ownerDocument.defaultView.getComputedStyle(e,null),a=r.getPropertyValue(o);return""===a&&(a=e.style[o]),a},OT.$.applyCSS=function(e,t,n){var i,s,o={};for(i in t)t.hasOwnProperty(i)&&(o[i]=OT.$.css(e,i),OT.$.css(e,i,t[i]));s=n();for(i in t)t.hasOwnProperty(i)&&OT.$.css(e,i,o[i]);return s},OT.$.makeVisibleAndYield=function(e,t){return OT.$.applyCSS(e,{display:"block",visibility:"hidden"},t)}}(window),function(e){function t(e){Object.defineProperty(e.prototype,"firstElementChild",{get:function(){var e=this;for(e=e.firstChild;e&&1!=e.nodeType;)e=e.nextSibling;return e}}),Object.defineProperty(e.prototype,"lastElementChild",{get:function(){var e=this;for(e=e.lastChild;e&&1!=e.nodeType;)e=e.previousSibling;return e}}),Object.defineProperty(e.prototype,"nextElementSibling",{get:function(){for(var e=this;(e=e.nextSibling)&&1!=e.nodeType;);return e}}),Object.defineProperty(e.prototype,"previousElementSibling",{get:function(){for(var e=this;(e=e.previousSibling)&&1!=e.nodeType;);return e}})}OT.$.parseXML=function(n){var i,s;return e.DOMParser?s=(new DOMParser).parseFromString(n,"text/xml"):(s=new ActiveXObject("Microsoft.XMLDOM"),s.async="false",s.loadXML(n),t(s)),i=s.documentElement,i&&i.nodeName&&"parsererror"!==i.nodeName?s:null}}(window),function(){function e(e){if("string"==typeof e)return e;var t=[];for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&").replace(/\+/g,"%20")}OT.$.getXML=function(e,t){var n=t&&t.success,i=function(e){var t;return e?(t=e.documentElement,t&&t.nodeName&&"parsererror"!==t.nodeName?!0:!1):!1},s=function(e){var s=e.target.responseXML;i(s)?n&&n(s,e,e.target):t&&t.error&&t.error(e,e.target)},o=OT._.extend(t.headers||{},{"Content-Type":"application/xml"});OT.$.get(e,OT._.extend(t||{},{success:s,headers:o}))},OT.$.getJSON=function(e,t){var n=t&&t.success,i=function(e){var i;try{i=JSON.parse(e.target.responseText)}catch(s){return t&&t.error&&t.error(e,e.target),void 0}n&&n(i,e,e.target)};OT.$.get(e,OT._.extend(t||{},{success:i,headers:{"Content-Type":"application/json"}}))},OT.$.get=function(e,n){var i=new XMLHttpRequest,s=n||{};t(i,s.success,s.error),s.process&&i.addEventListener("progress",s.progress,!1),s.cancelled&&i.addEventListener("abort",s.cancelled,!1),i.open("GET",e,!0),s.headers||(s.headers={});for(var o in s.headers)i.setRequestHeader(o,s.headers[o]);i.send()},OT.$.post=function(n,i){var s=new XMLHttpRequest,o=i||{};t(s,o.success,o.error),o.process&&s.addEventListener("progress",o.progress,!1),o.cancelled&&s.addEventListener("abort",o.cancelled,!1),s.open("POST",n,!0),o.headers||(o.headers={});for(var r in o.headers)s.setRequestHeader(r,o.headers[r]);s.send(e(o.data))},OT.$.postFormData=function(e,t,n){if(!t)throw new Error("OT.$.postFormData must be passed a data options.");var i=new FormData;for(var s in t)i.append(s,t[s]);OT.$.post(e,OT._.extend(n||{},{data:i}))},OT.$.getJSONP=function(e,t){var n,i,s=3e4,o=document.head||document.getElementsByTagName("head")[0],r=e,a=OT._.extend(t||{},{callbackParameter:"callback"}),l=function(){i&&(clearTimeout(i),i=null)},c=function(){l(),n&&(n.onload=n.onreadystatechange=null,OT.$.removeElement(n),n=void 0)},u=function(){(!n.readyState||/loaded|complete/.test(n.readyState))&&l()},d=function(){return"jsonp_callback_"+ +new Date};a.callbackName=d(),this.jsonp_callbacks[a.callbackName]=function(e){c(),a.success&&a.success(e)},r+=(/\?/.test(r)?"&":"?")+a.callbackParameter+"="+a.callbackName,n=OT.$.createElement("script",{async:"async",src:r,onload:u,onreadystatechange:u}),o.appendChild(n),i=setTimeout(function(){_this._onLoadTimeout()},s)};var t=function(e,t,n){e.addEventListener("load",function(e){var i=e.target.status;i>=200&&300>i||304===i?t&&t.apply(null,arguments):n&&n(e)},!1),n&&e.addEventListener("error",n,!1)}}(window),function(){function e(e,n,i){n=n?parseInt(n,10):parseInt(OT.$.width(e.parentNode),10),i=i?parseInt(i,10):parseInt(OT.$.height(e.parentNode),10);var s,o,r,a,l=(n+0)/i;t==l?o=s="100%":l>t?(s="100",o=100*(l/t),a=(o-100)/2,r=0):(o="100%",s=100*(t/l),r=(s-100)/2,a=0),OT.$.css(e,{width:s+"%",height:o+"%",marginLeft:"-"+r+"%",marginTop:"-"+a+"%"})}var t=4/3;OT.$.getOrCreateWidgetContainerById=function(t,n){var i=OT.$(t),s=document.createElement("div");return i?OT.$.emptyElement(i):(i=OT.$.createElement("div",{id:t}),i.style.backgroundColor="#000000",document.body.appendChild(i)),n&&(width=n.width,height=n.height,width&&"number"==typeof width&&(width+="px"),height&&"number"==typeof height&&(height+="px"),i.style.width=width?width:"264px",i.style.height=height?height:"198px",i.style.overflow="hidden",(void 0===n.mirror||n.mirror)&&OT.$.addClass(i,"OT_mirrored")),n.classNames&&OT.$.addClass(i,n.classNames),OT.$.addClass(s,"OT_video-container"),s.style.width=i.style.width,s.style.height=i.style.height,i.appendChild(s),e(s,i.offsetWidth,i.offsetHeight),i.videoContainer=s,i}}(window),function(e){var t=function(){return navigator.getUserMedia?navigator.getUserMedia.bind(navigator):navigator.mozGetUserMedia?navigator.mozGetUserMedia.bind(navigator):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia.bind(navigator):void 0}();navigator.webkitGetUserMedia?(webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks}),webkitMediaStream.prototype.getAudioTracks||(webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams}),webkitRTCPeerConnection.prototype.getRemoteStreams||(webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):navigator.mozGetUserMedia&&(MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})),OT.$.supportsWebRTC=function(){var t=!1;if(navigator.webkitGetUserMedia)t="function"==typeof webkitRTCPeerConnection&&!!webkitRTCPeerConnection.prototype.addStream;else if(navigator.mozGetUserMedia){var n=e.navigator.userAgent.toLowerCase().match(/Firefox\/([0-9\.]+)/i);if(t="function"==typeof mozRTCPeerConnection&&null!==n&&parseFloat(n[1],10)>20)try{new mozRTCPeerConnection,t=!0}catch(i){t=!1}}return OT.$.supportsWebRTC=function(){return t},t},OT.$.supportedCryptoScheme=function(){if(!OT.$.supportsWebRTC())return"NONE";var t=e.navigator.userAgent.toLowerCase().match(/chrome\/([0-9\.]+)/i);return t&&25>parseFloat(t[1],10)?"SDES_SRTP":"DTLS_SRTP"},OT.$.getUserMedia=function(e,n,i,s,o){if(!e||OT._.all(e,function(e){return e===!1}))return OT.error("Couldn't get UserMedia: All constraints were false"),i({code:"NO_CONSTRAINTS"}),void 0;var r=null,a=function(){r?clearTimeout(r):o&&o()},l=function(){r=null,s&&s()},c=function(){a(),n.apply(null,arguments)},u=function(){a(),i.apply(null,arguments)};try{t(e,c,u)}catch(d){OT.error("Couldn't get UserMedia: "+d.toString()),u({})}-1===location.protocol.indexOf("https")?setTimeout(l,100):r=setTimeout(l,500)}}(window),function(){OT.Modal=function(e,t){var n="        <header>            <h1><%= title %></h1>        </header>        <div class='OT_dialog-body'>            <%= body %>        </div>    ";this.el=OT.$.createElement("section",{className:"OT_root OT_dialog OT_modal"},OT._.template(n,{title:e,body:t})),this.el.style.display="none",document.body.appendChild(this.el),OT.$.centerElement(this.el),OT.$.show(this.el),this.close=function(){return OT.$.removeElement(this.el),this.el=null,this}}}(window),function(){function e(){var e=!1,t=!1,n=function(){return t&&e},i=function(){n()&&OT.dispatchEvent(new OT.EnvLoadedEvent(OT.Event.names.ENV_LOADED))},s=function(){t=!0,OT.Config.load(),i()},o=function(){e=!0,OT.Config.off(OT.Event.names.DYNAMIC_CONFIG_CHANGED,o),OT.Config.off(OT.Event.names.DYNAMIC_CONFIG_LOAD_FAILED,r),i()},r=function(){o()};OT.Config.on(OT.Event.names.DYNAMIC_CONFIG_CHANGED,o),OT.Config.on(OT.Event.names.DYNAMIC_CONFIG_LOAD_FAILED,r),"complete"==document.readyState||"interactive"==document.readyState&&document.body?s():document.addEventListener?document.addEventListener("DOMContentLoaded",s,!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){"complete"==document.readyState&&s()}),this.onLoad=function(e){return n()?(e(),void 0):(OT.on(OT.Event.names.ENV_LOADED,e),void 0)}}var t=new e;OT.onLoad=function(e,n){n?t.onLoad(OT._.bind(e,n)):t.onLoad(e)}}(window),function(){function e(e,i,s,o){var r=n[s],a=o?OT._.clone(o):{};OT.error("TB.exception :: title: "+r+" ("+s+") msg: "+i),a.partnerId||(a.partnerId=OT.APIKEY);
try{t||(t=new OT.Analytics),t.logError(s,"tb.exception",r,{details:i},a),OT.dispatchEvent(new OT.ExceptionEvent(OT.Event.names.EXCEPTION,i,r,s,e))}catch(l){OT.error("TB.exception :: Failed to dispatch exception - "+l.toString())}}var t,n={1e3:"Failed To Load",1004:"Authentication error",1005:"Invalid Session ID",1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1012:"Peer-to-peer Stream Play Failed",1013:"Peer-to-peer Connection Failed",1014:"API Response Failure",1500:"Unable to Publish",1510:"Unable to Signal",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1540:"Unable to record archive",1550:"Unable to play back archive",1560:"Unable to create archive",1570:"Unable to load archive",2e3:"Internal Error",2001:"Embed Failed",3e3:"Archive load exception",3001:"Archive create exception",3002:"Playback stop exception",3003:"Playback start exception",3004:"Record start exception",3005:"Record stop exception",3006:"Archive load exception",3007:"Session recording in progress",3008:"Archive recording internal failure",4e3:"WebSocket Connection Failed",4001:"WebSocket Network Disconnected"};OT.handleJsException=function(t,n,i){i&&!i.target&&(i.target=null);var s,o=i.session;o?(s={sessionId:o.sessionId},o.connected&&(s.connectionId=o.connection.connectionId)):i.sessionId&&(s={sessionId:i.sessionId}),e(i.target,t,n,s)},OT.exceptionHandler=function(t,n,i,s,o){var r;t&&(r=OT.components[t],r||OT.warn("Could not find the component with component ID "+t)),e(r,n,s,o)}}(window),function(){OT.ConnectionCapabilities=function(e){var t=function(e){return e.supportsWebRTC=OT.$.castToBoolean(e.supportsWebRTC),e},n=t(e);this.supportsWebRTC=n.supportsWebRTC}}(window),function(){OT.Connection=function(e,t,n,i){this.id=this.connectionId=e,this.creationTime=Number(t),this.data=n,this.capabilities=new OT.ConnectionCapabilities(i),this.quality=null,OT.eventing(this)}}(window),function(){OT.Stream=function(e,t,n,i,s,o,r,a,l,c,u,d,h,p){this.id=this.streamId=e,this.sessionId=c,this.connection=t,this.name=n,this.data=i,this.type=s||"basic",this.creationTime=Number(o),this.hasAudio=OT.$.castToBoolean(r,!0),this.hasVideo=OT.$.castToBoolean(a,!0),this.orientation=l,this.peerId=u,this.quality=d,this.videoDimensions={width:h,height:p},OT.eventing(this),this.update=function(e,t){switch(e){case"hasAudio":case"hasVideo":this[e]=OT.$.castToBoolean(t,!0);break;case"quality":case"name":case"videoDimensions":case"orientation":this[e]=t}},this.startRecording=function(){throw OT.debug("OT.Stream.startRecording"),new Error("OT.Stream.startRecording: Is not implemented yet.")},this.stopRecording=function(){throw OT.debug("OT.Stream.stopRecording"),new Error("OT.Stream.stopRecording: Is not implemented yet.")}}}(window),function(){OT.DOMComponentCleanup=function(){var e={},t={},n=function(e){OT.$.on(e,"unload",function(){return i(e)})},i=function(e){t[e]&&0!==t[e].length&&(t[e].slice().forEach(function(e){e.destroy()}),delete t[e])};return{add:function(i){if(i.targetElement&&i.id){var s=i.targetElement.ownerDocument.defaultView;e[i.id]=s,t.hasOwnProperty(s)||(t[s]=[],n(s)),t[s].push(i)}},remove:function(n){if(n.id&&e[n.id]){var i,s=e[n.id];-1!=(i=OT._.indexOf(t[s],n))&&t[s].splice(i,1)}}}}()}(window),function(e){function t(e,t){var n=document.createElement("video");if(n.setAttribute("autoplay",""),n.innerHTML=e,t){t.muted===!0&&(delete t.muted,n.muted="true");for(var i in t)n.setAttribute(i,t[i])}return n}function n(e){return o[parseInt(e,10)]||"An unknown error occurred."}function i(t,n,i,s){navigator.mozGetUserMedia?t.mozSrcObject=n:t.src=e.URL.createObjectURL(n),t.play();var o,r=150,a=0;(function l(){a++,!navigator.mozGetUserMedia&&0===n.getVideoTracks().length&&0===n.getAudioTracks().length||t.currentTime>0?i():r>a?o=setTimeout(l,200):s("The video stream failed to connect. Please notify the site owner if this continues to happen.")})()}OT.VideoOrientation={ROTATED_NORMAL:"OTVideoOrientationRotatedNormal",ROTATED_LEFT:"OTVideoOrientationRotatedLeft",ROTATED_RIGHT:"OTVideoOrientationRotatedRight",ROTATED_UPSIDE_DOWN:"OTVideoOrientationRotatedUpsideDown"},OT.rtc.VideoElement=function(s){var o,r,a,l=!1,c=OT._.defaults(s||{},{fallbackText:"Sorry, Web RTC is not available in your browser"});OT.eventing(this);var u=OT._.bind(function(e){var t="There was an unexpected problem with the Video Stream: "+n(e.target.error.code);this.trigger("error",null,t,this)},this),d=OT._.bind(function(){l=!0,this.trigger("streamBound",this)},this),h=OT._.bind(function(e){this.trigger("error",OT.ExceptionCodes.P2P_CONNECTION_FAILED,e,this)},this);r=t(c.fallbackText,c.attributes),r.addEventListener("error",u,!1),Object.defineProperties(this,{stream:{get:function(){return o}},domElement:{get:function(){return r}},parentElement:{get:function(){return a}},isBoundToStream:{get:function(){return l}}}),this.appendTo=function(e){return a=e,a.appendChild(r),this},this.bindToStream=function(e){return l=!1,o=e,i(r,o,d,h),this},this.unbindStream=function(){return o?(r&&(navigator.mozGetUserMedia?r.mozSrcObject=null:e.URL.revokeObjectURL(r.src)),o=null,this):void 0},this.destroy=function(){return this.unbindStream(),r&&(OT.$.removeElement(r),r=null),a=null,void 0}},OT.$.canDefineProperty&&Object.defineProperty(OT.rtc.VideoElement.prototype,"imgData",{get:function(){var e=OT.$.createElement("canvas",{width:this.domElement.videoWidth,height:this.domElement.videoHeight,style:{display:"none"}});document.body.appendChild(e),e.getContext("2d").drawImage(this.domElement,0,0,e.width,e.height);var t=e.toDataURL("image/png");return OT.$.removeElement(e),t.replace("data:image/png;base64,","").trim()}});var s={OTVideoOrientationRotatedNormal:"rotate(0deg)",OTVideoOrientationRotatedLeft:"rotate(90deg)",OTVideoOrientationRotatedRight:"rotate(-90deg)",OTVideoOrientationRotatedUpsideDown:"rotate(180deg)"};OT.$.canDefineProperty&&Object.defineProperty(OT.rtc.VideoElement.prototype,"orientation",{set:function(e){var t=s[e]||s.ROTATED_NORMAL;switch(OT.$.browser()){case"Chrome":case"Safari":this.domElement.style.webkitTransform=t;break;case"IE":this.domElement.style.msTransform=t;break;default:this.domElement.style.transform=t}}});var o={};e.MediaError&&(o[e.MediaError.MEDIA_ERR_ABORTED]="The fetching process for the media resource was aborted by the user agent at the user's request.",o[e.MediaError.MEDIA_ERR_NETWORK]="A network error of some description caused the user agent to stop fetching the media resource, after the resource was established to be usable.",o[e.MediaError.MEDIA_ERR_DECODE]="An error of some description occurred while decoding the media resource, after the resource was established to be usable.",o[e.MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]="The media resource indicated by the src attribute was not suitable. ")}(window),function(e){var t=e.webkitRTCPeerConnection||e.mozRTCPeerConnection,n=e.mozRTCSessionDescription||e.RTCSessionDescription,i=e.mozRTCIceCandidate||e.RTCIceCandidate,s=function(e,t){return function(n){OT.debug("IceCandidateForwarder: Ice Candidate"),n.candidate?e(OT.WebSocketMessageType.JSEP_CANDIDATE,{candidate:n.candidate}):(OT.debug("IceCandidateForwarder: No more ICE candidates. PeerConnection Status: "+n.srcElement.readyState+", Ice Status: "+n.srcElement.iceState),t())}},o=function(){var e=[],t=null;Object.defineProperty(this,"peerConnection",{set:function(e){t=e}}),this.process=function(n){var s=new i(n.candidate);t?t.addIceCandidate(s):e.push(s)},this.processPending=function(){for(;e.length;)t.addIceCandidate(e.shift())}},r=function(e,t,n,i){var s=function(e){return function(t){i&&i(e,t)}},o=function(t){e.setLocalDescription(t,function(){n(t)},s("Error while setting LocalDescription"))},r=function(){e.createAnswer(o,s("Error while setting createAnswer"),null,!1)};if(-1===t.sdp.indexOf("a=crypto")){var a="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\\r\\n";t.sdp=t.sdp.replace(/^c=IN(.*)$/gim,"c=IN$1\r\n"+a)}e.setRemoteDescription(t,r,s("Error while setting RemoteDescription"))},a=function(e,t,n){var i={mandatory:{},optional:[]},s=function(e){return function(t){n&&n(e,t)}},o=function(n){e.setLocalDescription(n,function(){t(n)},s("Error while setting LocalDescription"))};navigator.mozGetUserMedia&&(i.mandatory.MozDontOfferDataChannel=!0),e.createOffer(o,s("Error while creating Offer"),i)};OT.rtc.PeerConnection=function(e){var i,l,c,u=new o,d="new",h=[];OT.eventing(this),navigator.mozGetUserMedia&&(e.iceServers=[]);var p=OT._.bind(function(e,t){h.length&&h[0](e,t)},this),f=OT._.bind(function(){if(!i){try{OT.debug('Creating peer connection config "'+JSON.stringify(e)+'".'),i=new t(e,{optional:[{DtlsSrtpKeyAgreement:!0}]})}catch(n){return OT.error("Failed to create PeerConnection, exception: "+n.message),null}u.peerConnection=i,i.onicecandidate=s(p,OT._.bind(function(){this.trigger("open")},this)),i.onaddstream=OT._.bind(v,this),i.onremovestream=OT._.bind(y,this),void 0!==i.onsignalingstatechange?i.onsignalingstatechange=OT._.bind(m,this):void 0!==i.onstatechange&&(i.onstatechange=OT._.bind(m,this))}return i},this),m=function(e){var t=e.target.signalingState||e.target.readyState;if(t&&t.toLowerCase()!==d)switch(d=t.toLowerCase(),OT.debug("PeerConnection.stateChange: "+d),d){case"closed":u&&(u.peerConnection=null),i=null,this.trigger("close")}},g=function(){var e;if(i.getRemoteStreams)e=i.getRemoteStreams();else{if(!i.remoteStreams)throw new Error("Invalid Peer Connection object implements no method for retrieving remote streams");e=i.remoteStreams}return Array.prototype.slice.call(e)},v=function(e){var t="audio"===e.type||"video"===e.type?e.type:"merged";this.trigger("streamAdded",e.stream,t)},y=function(e){var t="audio"===e.type||"video"===e.type?e.type:"merged";this.trigger("streamRemoved",e.stream,t)},b=function(e,t){p(e,{sdp:t})},_=function(e){var t=new n(e.sdp),s=function(e){b(OT.WebSocketMessageType.JSEP_ANSWER,e)},o=function(e,t){w("PeerConnection.offerProcessor "+e+": "+t)};f(),_remoteDescriptionType=t.type,_remoteDescription=t,r(i,t,s,o)},T=function(e){return e.sdp?(c=new n(e.sdp),_remoteDescriptionType=c.type,_remoteDescription=c,i.setRemoteDescription(c),u.processPending(),void 0):(OT.error("PeerConnection.processMessage: Weird message, no SDP."),void 0)},C=function(){OT.debug("PeerConnection.processSubscribe: Sending offer to subscriber."),f(),a(i,function(e){l=e,b(OT.WebSocketMessageType.JSEP_OFFER,l)},function(e,t){w("PeerConnection.suscribeProcessor "+e+": "+t)})},w=OT._.bind(function(e){OT.error(e),this.trigger("error",e)},this);this.addLocalStream=function(e){f(),i.addStream(e)},this.disconnect=function(){if(u=null,i){var e=i.signalingState||i.readyState;e&&"closed"!==e.toLowerCase()&&i.close(),i=null}},this.processMessage=function(e,t){switch(OT.debug("PeerConnection.processMessage: Received "+e+" from "+t.fromAddress),OT.debug(t),e){case OT.WebSocketMessageType.JSEP_SUBSCRIBE:C.call(this,t);break;case OT.WebSocketMessageType.JSEP_OFFER:_.call(this,t);break;case OT.WebSocketMessageType.JSEP_ANSWER:T.call(this,t);break;case OT.WebSocketMessageType.JSEP_CANDIDATE:u.process(t);break;default:OT.debug("PeerConnection.processMessage: Received an unexpected message of type "+e+" from "+t.fromAddress+": "+JSON.stringify(t))}return this},this.registerMessageDelegate=function(e){h.push(e)},this.unregisterMessageDelegate=function(e){OT._.without(h,e)},Object.defineProperty(this,"remoteStreams",{get:function(){return i?g():[]}})}}(window),function(){var e={};OT.rtc.PeerConnections={add:function(t,n,i){var s=t.id+"_"+n.id,o=e[s];return o||(o=e[s]={count:0,pc:new OT.rtc.PeerConnection(i)}),o.count+=1,o.pc},remove:function(t,n){var i=t.id+"_"+n.id,s=e[i];s&&(s.count-=1,0===s.count&&(s.pc.disconnect(),delete e[i]))}}}(window),function(){OT.rtc.PublisherPeerConnection=function(e,t,n,i){var s,o=!1,r=function(){this.trigger("connected",this)},a=function(){this.destroy(),this.trigger("disconnected",this)},l=function(e){this.trigger("error",null,e,this),this.destroy()},c=function(i,s){o||i!==OT.WebSocketMessageType.JSEP_CANDIDATE||(o=-1!==s.candidate.candidate.indexOf("relay")),t.sendJSEPMessage(e,i,OT._.extend(s,{streamId:n.id}))};OT.eventing(this),this.destroy=function(){s&&OT.rtc.PeerConnections.remove(e,n),s=null},this.processMessage=function(e,t){s.processMessage(e,t)};var u;u=t.sessionInfo.iceServers?t.sessionInfo.iceServers:[{url:"stun:stun.l.google.com:19302"}],s=OT.rtc.PeerConnections.add(e,n,{iceServers:u}),s.on({open:OT._.bind(r,this),close:OT._.bind(a,this),error:OT._.bind(l,this)}),s.registerMessageDelegate(c),s.addLocalStream(i),Object.defineProperty(this,"remoteConnection",{value:e}),Object.defineProperty(this,"hasRelayCandidates",{get:function(){return o}})}}(window),function(){OT.rtc.SubscriberPeerConnection=function(e,t,n){var i,s={},o=!1,r=!1,a=function(){o=!0,this.trigger("connected",this)},l=function(){o=!1,this.destroy(),this.trigger("disconnected",this)},c=function(e,t){s[t]=e,this.trigger("remoteStreamAdded",s[t],t,this)},u=function(e,t){delete s[t],this.trigger("remoteStreamRemoved",e,t,this)},d=function(e){o=!1,this.trigger("error",null,e,this)},h=function(i,s){r||i!==OT.WebSocketMessageType.JSEP_CANDIDATE||(r=-1!==s.candidate.candidate.indexOf("relay")),t.sendJSEPMessage(e,i,OT._.extend(s,{streamId:n.id}))},p=function(e){var t="get"+(e?"Video":"Audio")+"Tracks";return function(e){var n,s,o=i.remoteStreams;if(0!==o.length&&o[0][t])for(var r=0,a=o.length;a>r;++r){s=o[r],n=s[t]();for(var l=0,c=n.length;c>l;++l)n[l].enabled=e}}};OT.eventing(this),this.destroy=function(){t&&t.connected&&n&&t.sendJSEPMessage(n.connection,OT.WebSocketMessageType.JSEP_UNSUBSCRIBE,{streamId:n.id}),i&&(this.subscribeToAudio(!1),OT.rtc.PeerConnections.remove(e,n)),s={},o=!1,i=null},this.processMessage=function(e,t){i.processMessage(e,t)},this.subscribeToAudio=p(!1),this.subscribeToVideo=p(!0),Object.defineProperty(this,"connected",{get:function(){return o}}),Object.defineProperty(this,"hasRelayCandidates",{get:function(){return r}});var f;f=t.sessionInfo.iceServers?t.sessionInfo.iceServers:[{url:"stun:stun.l.google.com:19302"}],i=OT.rtc.PeerConnections.add(e,n,{iceServers:f}),i.on({open:OT._.bind(a,this),close:OT._.bind(l,this),streamAdded:OT._.bind(c,this),streamRemoved:OT._.bind(u,this),error:OT._.bind(d,this)}),i.registerMessageDelegate(h),i.remoteStreams.length>0?i.remoteStreams.forEach(c,this):t.sendJSEPMessage(e,OT.WebSocketMessageType.JSEP_SUBSCRIBE,{streamId:n.id,keyManagemenMethod:OT.$.supportedCryptoScheme()})}}(window),function(){OT.Chrome=function(e){var t=!1,n={},i=function(t,i){i.parent=this,i.appendTo(e.parent),n[t]=i,Object.defineProperty(this,t,{get:function(){return n[t]}})};e.parent&&(OT.eventing(this),this.destroy=function(){this.hide();for(var e in n)n[e].destroy()},this.show=function(){t=!0;for(var e in n)n[e].show()},this.hide=function(){t=!1;for(var e in n)n[e].hide()},this.set=function(e,t){if("string"==typeof e&&t)i.call(this,e,t);else for(var n in e)e.hasOwnProperty(n)&&i.call(this,n,e[n]);return this})}}(window),function(){OT.Chrome.Behaviour||(OT.Chrome.Behaviour={}),OT.Chrome.Behaviour.Widget=function(e,t){var n,i,s=t||{};e.setDisplayMode=function(e){var t=e||"auto";n!==t&&(OT.$.removeClass(this.domElement,"OT_mode-"+n),OT.$.addClass(this.domElement,"OT_mode-"+t),i=n,n=t)},e.show=function(){return this.setDisplayMode(i),s.onShow&&s.onShow(),this},e.hide=function(){return this.setDisplayMode("off"),s.onHide&&s.onHide(),this},e.destroy=function(){return s.onDestroy&&s.onDestroy(this.domElement),this.domElement&&OT.$.removeElement(this.domElement),e},e.appendTo=function(t){return this.domElement=OT.$.createElement(s.nodeName||"div",s.htmlAttributes,s.htmlContent),s.onCreate&&s.onCreate(this.domElement),e.setDisplayMode("on"),t.appendChild(this.domElement),setTimeout(function(){e.setDisplayMode(s.mode)},2e3),e}}}(window),function(){OT.Chrome.NamePanel=function(e){var t=e.name;t&&""!==t.trim().length||(t=null,e.mode="off");var n;this.__defineGetter__("domElement",function(){return n}),this.__defineSetter__("domElement",function(e){n=e}),OT.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"h1",htmlContent:t,htmlAttributes:{className:"OT_name"}}),this.__defineSetter__("name",OT._.bind(function(e){t||this.setDisplayMode("auto"),t=e,n.innerHTML=t},this))}}(window),function(){OT.Chrome.MuteButton=function(e){var t,n,i=e.muted||!1;this.__defineGetter__("domElement",function(){return n}),this.__defineSetter__("domElement",function(e){n=e});var s=function(e){t=OT._.bind(r,this),e.addEventListener("click",t,!1)},o=function(e){t=null,e.removeEventListener("click",t,!1)},r=function(){return i=!i,i?(OT.$.addClass(n,"OT_active"),this.parent.trigger("muted",this)):(OT.$.removeClass(n,"OT_active"),this.parent.trigger("unmuted",this)),!1},a=i?"OT_mute OT_active":"OT_mute";OT.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:a},onCreate:OT._.bind(s,this),onDestroy:OT._.bind(o,this)})}}(window),function(){OT.Chrome.MicVolume=function(e){var t,n,i=e.muted||!1;this.__defineGetter__("domElement",function(){return n}),this.__defineSetter__("domElement",function(e){n=e});var s=function(e){t=OT._.bind(r,this),e.addEventListener("click",t,!1)},o=function(e){t=null,e.removeEventListener("click",t,!1)},r=function(){return i=!i,i?(OT.$.addClass(n,"active"),this.parent.trigger("muted",this)):(OT.$.removeClass(n,"active"),this.parent.trigger("unmuted",this)),!1};OT.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:"OT_mic-volume"},onCreate:OT._.bind(s,this),onDestroy:OT._.bind(o,this)})}}(window),function(){OT.Chrome.SettingsPanelButton=function(e){var t,n,i=function(e){t=OT._.bind(o,this),e.addEventListener("click",t,!1)},s=function(e){t=null,e.removeEventListener("click",t,!1)},o=function(){return this.parent.trigger("SettingsPanel:open",this),!1};this.__defineGetter__("domElement",function(){return n}),this.__defineSetter__("domElement",function(e){n=e}),OT.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"button",htmlContent:"Settings",htmlAttributes:{className:"OT_settings-panel"},onCreate:OT._.bind(i,this),onDestroy:OT._.bind(s,this)})}}(window),function(){OT.Chrome.SettingsPanel=function(e){if(e.stream){var t,n=e.stream;this.__defineGetter__("domElement",function(){return t}),this.__defineSetter__("domElement",function(e){t=e});var i=function(){var e=n.getVideoTracks().length?n.getVideoTracks()[0].label:"None",i=n.getAudioTracks().length?n.getAudioTracks()[0].label:"None";t.innerHTML="<dl>                                        <dt>Cam</dt>                                        <dd>"+e+"</dd>                                        <dt>Mic</dt>                                        <dd>"+i+"</dd>                                    </dl>";var s=OT.$.createButton("Close",{className:"OT_close"},{click:OT._.bind(o,this)});t.appendChild(s)},s=function(){i.call(this)},o=function(){return this.parent.trigger("SettingsPanel:close",this),!1};OT.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"section",htmlContent:"Settings",htmlAttributes:{className:"OT_settings-panel"},onCreate:OT._.bind(i,this),onShow:OT._.bind(s,this)})}}}(window),function(){OT.Chrome.OpenTokButton=function(e){if(!e||!e.infoHref)return!1;var t;this.__defineGetter__("domElement",function(){return t}),this.__defineSetter__("domElement",function(e){t=e}),OT.Chrome.Behaviour.Widget(this,{mode:e?e.mode:null,nodeName:"a",htmlContent:"OpenTok",htmlAttributes:{className:"OT_opentok",title:"more info",href:e.infoHref,target:"_blank"}}),this.__defineSetter__("infoHref",function(n){e.infoHref=n,t.setAttribute("href",n)})}}(window),function(){OT.rtc.StylableComponent=function(t,n){if(!t.trigger)throw new Error("OT.rtc.StylableComponent is dependent on the mixin OT.eventing. Ensure that this is included in the object before StylableComponent.");var i=function(e,n,i){i?t.trigger("styleValueChanged",e,n,i):t.trigger("styleValueChanged",e,n)},s=new e(n,i);t.getStyle=function(e){return s.get(e)},t.setStyle=function(e,t,n){return"string"!=typeof e?s.setAll(e,n):s.set(e,t),this}};var e=function(e,t){var n=["showMicButton","showSpeakerButton","showSettingsButton","showCameraToggleButton","nameDisplayMode","buttonDisplayMode","showSaveButton","showRecordButton","showRecordStopButton","showReRecordButton","showPauseButton","showPlayButton","showPlayStopButton","showStopButton","backgroundImageURI","showControlPanel","showRecordCounter","showPlayCounter","showControlBar","showPreviewTime"],i={buttonDisplayMode:["auto","off","on"],nameDisplayMode:["auto","off","on"],showSettingsButton:[!0,!1],showMicButton:[!0,!1],showCameraToggleButton:[!0,!1],showSaveButton:[!0,!1],backgroundImageURI:null,showControlBar:[!0,!1],showPlayCounter:[!0,!1],showRecordCounter:[!0,!1],showPreviewTime:[!0,!1]},s={},o=function(e,t){return"backgroundImageURI"===e||i.hasOwnProperty(e)&&OT._.include(i[e],t)},r=function(e){switch(e){case"true":return!0;case"false":return!1;default:return e}};this.getAll=function(){var e=OT._.clone(s);for(var t in e)0>n.indexOf(t)&&delete e[t];return e},this.get=function(e){return e?s[e]:this.getAll()},this.setAll=function(e,n){var i,a;for(var l in e)a=r(e[l]),o(l,a)?(i=s[l],a!==i&&(s[l]=a,n||t(l,a,i))):OT.warn("Style.setAll::Invalid style property passed "+l+" : "+a);return this},this.set=function(e,n){OT.debug("Publisher.setStyle: "+e.toString());var i,a=r(n);return o(e,a)?(i=s[e],a!==i&&(s[e]=a,t(e,n,i)),this):(OT.warn("Style.set::Invalid style property passed "+e+" : "+a),this)},e&&this.setAll(e,!0)}}(window),function(){OT.Microphone=function(e,t){var n,i=50;Object.defineProperty(this,"muted",{get:function(){return n},set:function(t){if(n!==t){n=t;for(var i=e.getAudioTracks(),s=0,o=i.length;o>s;++s)i[s].enabled=!n}}}),Object.defineProperty(this,"gain",{get:function(){return i},set:function(e){OT.warn("OT.Microphone.gain IS NOT YET IMPLEMENTED"),i=e}}),this.muted=void 0!==t?t===!0:e.getAudioTracks().length?!e.getAudioTracks()[0].enabled:!1}}(window),function(){OT.rtc.Publisher=function(){if(!OT.checkSystemRequirements())return OT.upgradeSystemRequirements(),void 0;var e,t,n,i,s,o,r,a,l,c,u,d=OT.rtc.Publisher.nextId(),h={},p=!1,f=!1,m=new OT.Analytics;OT.eventing(this),OT.rtc.StylableComponent(this,{showMicButton:!0,showSettingsButton:!0,showCameraToggleButton:!0,nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null});var g=function(e,t,n,s){m.logEvent({action:e,variation:t,payload_type:n,payload:s,session_id:o?o.sessionId:null,connection_id:o&&o.connected?o.connection.connectionId:null,partner_id:o?o.apiKey:OT.APIKEY,streamId:i?i.id:null,widget_id:d,widget_type:"Publisher"})},v=function(){OT.debug("OT.rtc.Publisher.onLoaded"),g("publish","Success","streamType","WebRTC"),OT.$.removeClass(t,"loading"),D.call(this),p=!0,this.trigger("loaded",this)},y=function(e){g("publish","Failure","reason","Publisher PeerConnection Error: "+e),OT.handleJsException("Publisher PeerConnection Error: "+e,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:o,target:this})},b=function(e){OT.debug("OT.rtc.Publisher.onStreamAvailable"),this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_ALLOWED,!1)),S(),s=e,l=new OT.Microphone(s,!r.publishAudio),this.publishVideo(r.publishVideo),n=new OT.rtc.VideoElement({attributes:{muted:!0}}),n.on({streamBound:OT._.bind(v,this),timeout:OT._.bind(y,this),error:OT._.bind(w,this)}).bindToStream(s).appendTo(t.videoContainer),OT.DOMComponentCleanup.add(this,n)},_=function(e){var n=function(e,t){OT.error("OT.rtc.Publisher.onStreamAvailableError "+e),g("publish","Failure","reason","Publisher failed to access camera/mic: "+e),OT.handleJsException("Publisher failed to access camera/mic: "+e,2e3,{session:o,target:t})};switch(e.code){case 1:OT.error("OT.rtc.Publisher.onStreamAvailableError Permission Denied"),g("publish","Failure","reason","Publisher Access Denied: Permission Denied ("+e.code+")");var i=new OT.Event(OT.Event.names.ACCESS_DENIED),s=function(){!i.isDefaultPrevented()&&t&&OT.$.removeElement(t)};this.dispatchEvent(i,s);break;case"NO_CONSTRAINTS":t&&OT.$.removeElement(t),n("No constaints were provided",this);break;default:t&&OT.$.removeElement(t),n("Unknown Reason ("+e.code+")",this)}},T=function(){g("accessDialog","Opened","",""),this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_OPENED,!1))},C=function(){g("accessDialog","Closed","",""),this.dispatchEvent(new OT.Event(OT.Event.names.ACCESS_DIALOG_CLOSED,!1))},w=function(e,t){OT.error("OT.rtc.Publisher.onVideoError");var n=t+(e?" ("+e+")":"");g("stream",null,"reason","Publisher while playing stream: "+n),OT.handleJsException("Publisher error playing stream: "+n,2e3,{session:o,target:this})},E=function(e){OT.debug("OT.rtc.Subscriber has been disconnected from the Publisher's PeerConnection"),this.cleanupSubscriber(e.remoteConnection.id)},O=function(e,t,n){g("publish","Failure","reason|hasRelayCandidates",["Publisher PeerConnection with connection "+n.remoteConnection.id+" failed: "+t,n.hasRelayCandidates].join("|")),OT.handleJsException("Publisher PeerConnection Error: "+t,2e3,{session:o,target:this}),delete h[n.remoteConnection.id]},S=function(){s&&(s.stop(),s=null)},x=function(e){var t=h[e.id];if(!t){var n=OT.$.now();g("createPeerConnection","Attempt","",""),t=h[e.id]=new OT.rtc.PublisherPeerConnection(e,o,i,s),t.on({connected:function(){g("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(OT.$.now()-n,10),t.hasRelayCandidates].join("|"))},disconnected:OT._.bind(E,this),error:OT._.bind(O,this)})}return t},k=function(e){if(e===!1)return"off";var t=this.getStyle("buttonDisplayMode");return t===!1?"on":t},A=function(e,t){if(c)switch(e){case"nameDisplayMode":c.name.setDisplayMode(t);break;case"buttonDisplayMode":case"showMicButton":case"showSettingsButton":}},D=function(){c=new OT.Chrome({parent:t}).set({name:new OT.Chrome.NamePanel({name:r.name,mode:this.getStyle("nameDisplayMode")}),muteButton:new OT.Chrome.MuteButton({muted:r.publishAudio===!1,mode:k.call(this,this.getStyle("showMicButton"))}),opentokButton:new OT.Chrome.OpenTokButton({infoHref:OT.$.moreInfoLink(o)})}).on({muted:OT._.bind(function(){this.publishAudio(!1)},this),unmuted:OT._.bind(function(){this.publishAudio(!0)},this)})};this.publish=function(n,i){return OT.debug("OT.rtc.Publisher: publish"),e&&this.unpublish(),e=n||uuid(),r=OT._.defaults(i||{},{publishAudio:!0,publishVideo:!0,mirror:!0}),r.style&&this.setStyle(r.style,null,!0),r.name&&(r.name=r.name.toString()),r.classNames="OT_root OT_publisher OT_loading",OT.onLoad(function(){t=OT.$.getOrCreateWidgetContainerById(e,r),OT.$.getUserMedia({audio:!0,video:!0},OT._.bind(b,this),OT._.bind(_,this),OT._.bind(T,this),OT._.bind(C,this))},this),this},this.publishAudio=function(e){r.publishAudio=e,l.muted=!e,o&&i&&o.sendMessage(OT.WebSocketMessage.modifyStream(i.streamId,"hasAudio",e))},this.publishVideo=function(e){var t=r.publishVideo;r.publishVideo=e,o&&i&&r.publishVideo!==t&&o.sendMessage(OT.WebSocketMessage.modifyStream(i.streamId,"hasVideo",e));for(var n=s.getVideoTracks(),a=0,l=n.length;l>a;++a)n[a].enabled=e},this.recordQOS=function(){m.logQOS({widget_type:"Publisher",stream_type:"WebRTC",sessionId:o?o.sessionId:null,connectionId:o&&o.connected?o.connection.connectionId:null,partnerId:o?o.apiKey:OT.APIKEY,streamId:i?i.id:null,widgetId:d,version:OT.BUILD_PROPERTIES.version,media_server_name:o.sessionInfo.messagingServer,duration:(new Date).getTime()-a.getTime()})},this.destroy=function(){return OT.DOMComponentCleanup.remove(this),c&&(c.destroy(),c=null),this.disconnect(),l=null,n&&(n.destroy(),n=null),S(),t&&(OT.$.removeElement(t),t=null),this.session&&this._.unpublishFromSession(this.session),f=!1,u&&clearInterval(u),e=null,i=null,p=!1,o=null,_properties=null,this.trigger("destroyed",this),this},this.disconnect=function(){for(var e in h)this.cleanupSubscriber(e)},this.cleanupSubscriber=function(e){var t=h[e];t&&(t.destroy(),delete h[e],g("disconnect","PeerConnection","subscriberConnection",e))},this.processMessage=function(e,t,n){switch(OT.debug("OT.rtc.Publisher.processMessage: Received "+e+" from "+t.id),OT.debug(n),e){case OT.WebSocketMessageType.JSEP_UNSUBSCRIBE:this.cleanupSubscriber(t.id);break;default:var i=x.call(this,t);i.processMessage(e,n)}},this.getImgData=function(){return p?n.imgData:(OT.error("OT.rtc.Publisher.getImgData: Cannot getImgData before the Publisher is publishing."),null)},this._={publishToSession:OT._.bind(function(e){this.session=e,c&&(c.opentokButton.infoHref=OT.$.moreInfoLink(o));var t=function(){e.sendMessage(OT.WebSocketMessage.createStream(this.guid,r&&r.name?r.name:"",OT.VideoOrientation.ROTATED_NORMAL,640,480,r.publishAudio,r.publishVideo,this.session.sessionInfo.p2pEnabled))};return p?t.call(this):this.on("loaded",OT._.bind(t,this)),g("publish","Attempt","streamType","WebRTC"),this},this),unpublishFromSession:OT._.bind(function(e){return this.session&&e.id===this.session.id?(e.connected&&this.stream&&e.sendMessage(OT.WebSocketMessage.destroyStream(this.stream.id)),this.disconnect(),this.session=null,g("unpublish","Success","sessionId",e.id),this):(OT.warn("The publisher "+this.guid+" is trying to unpublish from a session "+e.id+" it is not attached to"),this)},this),publishedToSessionHandler:OT._.bind(function(){a=new Date,f=!0,u=setInterval(this.recordQOS,3e4)},this)},this.detectDevices=function(){OT.warn("Fixme: Haven't implemented detectDevices")},this.detectMicActivity=function(){OT.warn("Fixme: Haven't implemented detectMicActivity")},this.getEchoCancellationMode=function(){return OT.warn("Fixme: Haven't implemented getEchoCancellationMode"),"fullDuplex"},this.setMicrophoneGain=function(){OT.warn("Fixme: Haven't implemented setMicrophoneGain")},this.getMicrophoneGain=function(){return OT.warn("Fixme: Haven't implemented getMicrophoneGain"),.5},this.setCamera=function(){OT.warn("Fixme: Haven't implemented setCamera")},this.setMicrophone=function(){OT.warn("Fixme: Haven't implemented setMicrophone")},this.on("styleValueChanged",OT._.bind(A,this)),this.__defineGetter__("id",function(){return e}),this.__defineGetter__("guid",function(){return d}),this.__defineGetter__("stream",function(){return i}),this.__defineSetter__("stream",function(e){i=e}),this.__defineGetter__("streamId",function(){return i?i.id:null}),this.__defineGetter__("targetElement",function(){return n.domeElement}),this.__defineGetter__("domId",function(){return e}),this.__defineGetter__("session",function(){return o}),this.__defineSetter__("session",function(e){o=e}),this.__defineGetter__("isWebRTC",function(){return!0}),Object.defineProperty(this._,"webRtcStream",{get:function(){return s}})},OT.rtc.Publisher.nextId=uuid}(window),function(){OT.rtc.Subscriber=function(e,t){var n,i,s,o,r,a,l,c=uuid(),u=e||c,d={},h=t.session,p=!1,f=OT._.clone(t),m=new OT.Analytics;if(!h)return OT.handleJsException("Subscriber must be passed a session option",2e3,{session:h,target:this}),void 0;OT.eventing(this),OT.rtc.StylableComponent(this,{nameDisplayMode:"auto",buttonDisplayMode:"auto",backgroundImageURI:null});var g=function(e,t,n,i){m.logEvent({action:e,variation:t,payload_type:n,payload:i,stream_id:s?s.id:null,session_id:h?h.sessionId:null,connection_id:h&&h.connected?h.connection.connectionId:null,partner_id:h&&h.connected?h.sessionInfo.partnerId:null,widget_id:c,widget_type:"Subscriber"})},v=function(){return d.merged||d.video},y=function(){if(!p&&0!==d.length){var e=OT._.every(d.values,function(e){return e.isBoundToStream});o&&o.connected&&(g("createPeerConnection","Opened","",""),e&&g("createPeerConnection","StreamAdded","","")),!e||o&&!o.connected||(OT.debug("OT.rtc.Subscriber.onLoaded"),p=!0,r=OT.$.now(),g("createPeerConnection","Success","pcc|hasRelayCandidates",[parseInt(r-a,10),o&&o.hasRelayCandidates].join("|")),l=setInterval(this.recordQOS,3e4),OT.$.removeClass(n,"loading"),E.call(this),this.trigger("loaded",this),g("subscribe","Success","streamId",s.id))}},b=function(){OT.debug("OT.rtc.Subscriber has been disconnected from the Publisher's PeerConnection"),this.disconnect()},_=function(e,t){p||g("createPeerConnection","Failure","reason|hasRelayCandidates",["Subscriber PeerConnection Error: "+t,o&&o.hasRelayCandidates].join("|")),this.disconnect(),g("subscribe","Failure","reason","Subscriber PeerConnection Error: "+t),OT.handleJsException("Subscriber PeerConnection Error: "+t,OT.ExceptionCodes.P2P_CONNECTION_FAILED,{session:h,target:this}),O.call(this,t)},T=function(e,t){OT.debug("OT.rtc.Subscriber.onRemoteStreamAdded"),this.subscribeToAudio(f.subscribeToAudio),this.subscribeToVideo(f.subscribeToVideo);var i=new OT.rtc.VideoElement;i.on({streamBound:OT._.bind(y,this),timeout:OT._.bind(_,this),error:OT._.bind(_,this)}),"audio"===t&&OT.$.addClass(i.domElement,"OT_hidden-audio"),i.bindToStream(e).appendTo(n.videoContainer),OT.DOMComponentCleanup.add(this,i),d[t]=i,"audio"!==t&&this.streamOrientationDidChange(s.orientation.width,s.orientation.height,s.orientation.videoOrientation),this.trigger("streamAdded",this)
},C=function(e){OT.debug("OT.rtc.Subscriber.onStreamRemoved");for(var t in d)d[t].stream==e&&(d[t].destroy(),delete d[t]);this.trigger("streamRemoved",this)},w=function(e,t){if(i)switch(e){case"nameDisplayMode":i.name.setDisplayMode(t);break;case"buttonDisplayMode":}},E=function(){i=new OT.Chrome({parent:n}).set({name:new OT.Chrome.NamePanel({name:f.name,mode:this.getStyle("nameDisplayMode")}),opentokButton:new OT.Chrome.OpenTokButton({infoHref:OT.$.moreInfoLink(h)})}).on({muted:function(){},unmuted:function(){}})},O=function(e){n&&(n.innerHTML="<p>"+e+"<p>"),OT.$.addClass(n,"OT_subscriber_error")};this.recordQOS=function(){p&&h&&h.connected&&m.logQOS({widget_type:"Subscriber",stream_type:"WebRTC",session_id:h.sessionId,connectionId:h.connection.connectionId,media_server_name:h.sessionInfo.messagingServer,partner_id:h.apiKey,stream_id:s.id,widget_id:c,version:OT.BUILD_PROPERTIES.version,duration:parseInt(OT.$.now()-r,10)})},this.subscribe=function(t){return OT.debug("OT.rtc.Subscriber: subscribe to "+t.id),p?(OT.error("OT.rtc.Subscriber.Subscribe: Cannot subscribe, already subscribing."),!1):t?s?(OT.error("OT.rtc.Subscriber: Already subscribed"),!1):(s=t,u=e||uuid(),f.name=s.name,f.classNames="OT_root OT_subscriber OT_loading",f.style&&this.setStyle(f.style,null,!0),f.subscribeToAudio=OT.$.castToBoolean(f.subscribeToAudio,!0),f.subscribeToVideo=OT.$.castToBoolean(f.subscribeToVideo,!0),n=OT.$.getOrCreateWidgetContainerById(u,f),a=OT.$.now(),s.connection.id!==h.connection.id?(g("createPeerConnection","Attempt","",""),o=new OT.rtc.SubscriberPeerConnection(s.connection,h,s),o.on({connected:OT._.bind(y,this),disconnected:OT._.bind(b,this),error:OT._.bind(_,this),remoteStreamAdded:OT._.bind(T,this),remoteStreamRemoved:OT._.bind(C,this)})):(T.call(this,h.getPublisherForStream(s)._.webRtcStream,"merged"),y.call(this)),g("subscribe","Attempt","streamId",s.id),this):(OT.error("OT.rtc.Subscriber: No stream parameter."),!1)},this.destroy=function(){OT.DOMComponentCleanup.remove(this),this.disconnect(),i&&(i.destroy(),i=null);for(var e in d)d[e].destroy(),d[e].off("streamBound"),d[e].off("timeout"),d[e].off("error");return d={},n&&(OT.$.removeElement(n),n=null),s&&g("unsubscribe",null,"streamId",s.id),u=null,s=null,clearInterval(l),h=null,f=null,this.trigger("destroyed",this),this},this.disconnect=function(){p=!1,o&&(o.destroy(),o=null,g("disconnect","PeerConnection","streamId",s.id))},this.processMessage=function(e,t,n){OT.debug("OT.rtc.Subscriber.processMessage: Received "+e+" message from "+t.id),OT.debug(n),o&&o.processMessage(e,n)},this.getImgData=function(){return this.subscribing?v().imgData:(OT.error("OT.rtc.Subscriber.getImgData: Cannot getImgData before the Subscriber is subscribing."),null)},this.setAudioVolume=function(){OT.warn("Fixme: Haven't implemented setAudioVolume")},this.getAudioVolume=function(){return OT.warn("Fixme: Haven't implemented getAudioVolume"),.5},this.subscribeToAudio=function(e){f.subscribeToAudio=OT.$.castToBoolean(e,!0),o&&o.subscribeToAudio(e)},this.subscribeToVideo=function(e){f.subscribeToVideo=OT.$.castToBoolean(e,!0),o&&o.subscribeToVideo(e)},this.streamOrientationDidChange=function(e,t,n){v().orientation=n},this.on("styleValueChanged",OT._.bind(w,this)),this.__defineGetter__("id",function(){return u}),this.__defineGetter__("stream",function(){return s}),this.__defineGetter__("targetElement",function(){return v()?v().domElement:null}),this.__defineGetter__("subscribing",function(){return p}),this.__defineGetter__("isWebRTC",function(){return!0})}}(window),function(){OT.TokenPermissions=function(e){var t=null;if(this.sessionId=null,this.partnerId=null,this.connectionData="",this.validToken=!0,this.capabilities={forceUnpublish:0,playback:0,publish:0,publishH264:0,record:0,subscribe:0},e.documentElement&&null!==e.documentElement.firstElementChild&&(t=e.documentElement.firstElementChild),OT.log("ValidateTokenResponse:"),OT.log(e),null!==t&&"token"==t.localName.toLowerCase()){var n=t.firstElementChild;do switch(n.localName){case"session_id":this.sessionId=n.textContent;break;case"partner_id":this.partnerId=n.textContent;break;case"permissions":var i=n.firstElementChild;do switch(i.tagName){case"forceunpublish":this.capabilities.forceUnpublish=1;break;case"forcedisconnect":this.capabilities.forceDisconnect=1;break;case"playback":this.capabilities.playback=1;break;case"publish":this.capabilities.publish=1;break;case"publishH264":this.capabilities.publishH264=1;break;case"record":this.capabilities.record=1;break;case"subscribe":this.capabilities.subscribe=1}while(i=i.nextElementSibling);OT.debug("Capabilities:"+JSON.stringify(this.capabilities));break;case"connection_data":this.connectionData=n.textContent,OT.log("ConnectionData: "+this.connectionData);break;case"invalid":OT.error("Token Invalid "+n.firstChild.textContent),this.validToken=!1;break;default:}while(n=n.nextElementSibling)}else this.validToken=!1}}(window),function(){OT.SessionInfo=function(e){var t=null;this.sessionId=null,this.partnerId=null,this.sessionStatus=null,this.p2pEnabled=!1,this.messagingServer=null,this.iceServers=null,OT.log("SessionInfo Response:"),OT.log(e),e&&e.documentElement&&null!==e.documentElement.firstElementChild&&(t=e.documentElement.firstElementChild);var n=t.firstElementChild;do switch(n.localName){case"session_id":this.sessionId=n.textContent;break;case"partner_id":this.partnerId=n.textContent;break;case"session_status":this.sessionStatus=n.textContent;break;case"messaging_server_url":this.messagingServer=n.textContent;break;case"ice_servers":this.iceServers=[];for(var i,s,o=n.childNodes,r=0,a=o.length;a>r;++r)"ice_server"===o[r].localName&&(s=o[r].attributes,i={url:s.getNamedItem("url").nodeValue},s.getNamedItem("credential")&&s.getNamedItem("credential").nodeValue.length&&(i.credential=s.getNamedItem("credential").nodeValue),this.iceServers.push(i));break;case"properties":var l=n.firstElementChild;if(l)do if("p2p"===l.localName&&null!==l.firstElementChild){this.p2pEnabled="enabled"===l.firstElementChild.textContent;break}while(l=l.nextElementSibling);break;default:}while(n=n.nextElementSibling);t=null},OT.SessionInfo.get=function(e,t,n){var i=OT.BUILD_PROPERTIES.apiURL+"/session/"+e.id+"?extended=true",s=OT.$.now(),o=function(i){e.logEvent("Instrumentation",null,"gsi",OT.$.now()-s);var o=parseErrorFromXMLDocument(i);o===!1?onGetResponseCallback(e,t,i):onGetErrorCallback(e,n,o)};e.logEvent("getSessionInfo","Attempt","api_url",OT.BUILD_PROPERTIES.apiURL),OT.$.getXML(i,{headers:{"X-TB-TOKEN-AUTH":e.token,"X-TB-VERSION":1},success:o,error:function(t){onGetErrorCallback(e,n,parseErrorFromXMLDocument(t.target.responseXML))}})};var e={};e["404"]=OT.ExceptionCodes.INVALID_SESSION_ID,e["403"]=OT.ExceptionCodes.AUTHENTICATION_ERROR,parseErrorFromXMLDocument=function(e){if(e&&e.documentElement&&null!==e.documentElement.firstElementChild){var t=e.evaluate("//error",e.documentElement,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),n=t.snapshotLength;if(0===n)return!1;for(var i=0;n>i;++i){var s=t.snapshotItem(i);return{code:s.getAttribute("code"),message:s.firstElementChild.getAttribute("message")}}}return{code:null,message:"Unknown error: getSessionInfo XML response was badly formed"}},onGetResponseCallback=function(e,t,n){e.logEvent("getSessionInfo","Success","api_url",OT.BUILD_PROPERTIES.apiURL),t(new OT.SessionInfo(n))},onGetErrorCallback=function(t,n,i){TB.handleJsException("TB.SessionInfoError :: Unable to get session info "+i.message,e[i.code],{session:t}),t.logEvent("getSessionInfo","Failure","errorMessage","TB.SessionInfoError :: Unable to get session info "+i.message),n(i,event)}}(window),function(){OT.Capabilities=function(e){this.publish=OT._.contains(e,"publish")?1:0,this.subscribe=OT._.contains(e,"subscribe")?1:0,this.forceUnpublish=OT._.contains(e,"forceunpublish")?1:0,this.forceDisconnect=OT._.contains(e,"forcedisconnect")?1:0,this.supportsWebRTC=OT.$.supportsWebRTC()?1:0}}(window),function(e){var t=[],n=!1;OT.Analytics=function(){var i=OT.BUILD_PROPERTIES.loggingURL+"/logging/ClientEvent",s=OT.BUILD_PROPERTIES.loggingURL+"/logging/ClientQos",o={},r={payloadType:"payload_type",streamId:"stream_id",sessionId:"session_id",connectionId:"connection_id",widgetType:"widget_type",widgetId:"widget_id"},a=function(e,t,n,o){OT.$.post(t?s:i,{success:n,error:o,data:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}})},l=function(){if(!n&&t.length>0){n=!0;var e=t[0],i=function(){t.shift(),n=!1,l()};e&&a(e.data,e.isQos,function(){e.onComplete(),setTimeout(i,50)},function(){OT.debug("Failed to send ClientEvent, moving on to the next item."),setTimeout(i,50)})}},c=function(e,n,i){t.push({data:e,onComplete:n,isQos:i}),l()},u=function(e,t,n){if(!n)return!1;var i=[n,t,e].join("_"),s=100;return null===s||void 0===s?!1:s>=(o[i]||0)};this.logError=function(e,t,n,i,s){s||(s={});var r=s.partnerId;if(OT.Config.get("exceptionLogging","enabled",r)===!0&&!u(e,t,r)){var a=[r,t,e].join("_"),l=this.escapePayload(OT._.extend(i||{},{message:l,userAgent:navigator.userAgent}));return o[a]="undefined"!=typeof o[a]?o[a]+1:1,this.logEvent(OT._.extend(s,{action:t+"."+e,payloadType:l[0],payload:l[1]}))}},this.logEvent=function(t){var n=t.partnerId;t||(t={});var i=OT._.extend({variation:"",guid:t.connectionId||"",widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:n,source:e.location.href,section:"",build:""},t),s=function(){};for(var o in r)r.hasOwnProperty(o)&&i[o]&&(i[r[o]]=i[o],delete i[o]);c(i,s,!1)},this.logQOS=function(t){var n=t.partnerId;t||(t={});var i=OT._.extend({guid:t.connectionId,widget_id:"",session_id:"",connection_id:"",stream_id:"",partner_id:n,source:e.location.href,build:"",duration:0},t),s=function(){};for(var o in r)r.hasOwnProperty(o)&&i[o]&&(i[r[o]]=i[o],delete i[o]);c(i,s,!0)},this.escapePayload=function(e){var t=[],n=[];for(var i in e)e.hasOwnProperty(i)&&null!==e[i]&&void 0!==e[i]&&(t.push(e[i]?e[i].toString().replace("|","\\|"):""),n.push(i.toString().replace("|","\\|")));return[n.join("|"),t.join("|")]}}}(window),function(){OT.Session=function(e){function t(e){for(var t in m){var n=m[t];if(e===n.streamId)return n}return null}function n(e){return e.connection&&f[e.connection.connectionId]?!0:(OT.warn("Received a stream for a connection that doesn't exist"),OT.debug(e),!1)}function i(e){return v[e]}function s(e){e.forEach(o)}function o(e){v[e.id]=e}function r(e){delete v[e]}function a(e,t,n){var s=i(e),o=s[t];return s.update(t,n),o}if(!OT.checkSystemRequirements())return OT.upgradeSystemRequirements(),void 0;var l,c,u,d,h=!1,p=!1,f={},m={},g={},v={},y=e,b=!1,_={},T=uuid(),C={},w=new OT.Analytics;OT.eventing(this);var E=function(e){h=!0,p=!1,l=e.connectionId,_=new OT.Capabilities(e.permissions),e.connections.forEach(function(e){f[e.connectionId]=e}),e.streams=OT._.filter(e.streams,function(e){return n(e)}),s(e.streams),this.dispatchEvent(new OT.SessionConnectEvent(OT.Event.names.SESSION_CONNECTED,e.connections,e.streams,e.archives))},O=function(e){switch(h=!1,p=!1,OT.error(e.reason),this.trigger("sessionConnectFailed",e.reason),e.code){case 409:TB.handleJsException("TB.SessionConnectionFailed :: The P2P session already has two participants.",OT.ExceptionCodes.CONNECT_REJECTED,{session:this});break;case 410:TB.handleJsException("TB.SessionConnectionFailed :: The session already has four participants.",OT.ExceptionCodes.CONNECT_REJECTED,{session:this});break;default:TB.handleJsException("TB.SessionConnectionFailed :: The session failed to connect.",OT.ExceptionCodes.CONNECT_FAILED,{session:this})}},S=function(e,t){TB.handleJsException(e,t,{session:this})},x=function(e){var t=new OT.SessionDisconnectEvent("sessionDisconnected",e.reason);R.call(this),L.call(this);var n=function(){t.isDefaultPrevented()||B.call(this)};this.dispatchEvent(t,OT._.bind(n,this))},k=function(e){f[e.connection.connectionId]=e.connection,e.connections=[e.connection],delete e.connection,this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_CREATED,e.connections))},A=function(e){l!==e.connection.connectionId&&delete f[e.connection.connectionId];for(var t in m)m[t].cleanupSubscriber(e.connection.connectionId);e.connections=[e.connection],delete e.connection,this.dispatchEvent(new OT.ConnectionEvent(OT.Event.names.CONNECTION_DESTROYED,e.connections,e.reason))},D=function(e){if(OT.debug(e.streams),0!==e.streams.length){s(e.streams);var t;e.streams.forEach(function(e){e.publisherId?(t=m[e.publisherId],delete e.publisherId):t=this.getPublisherForStream(e.id),t&&(t.stream=e)})}},I=function(e){e.streams=OT._.filter(e.streams,n),OT.debug(e.streams),e.streams.length>0&&(s(e.streams),e.streams.forEach(function(e){var n=t(e.id);n&&n._.publishedToSessionHandler()}),this.dispatchEvent(new OT.StreamEvent(OT.Event.names.STREAM_CREATED,e.streams,e.reason)))},N=function(e){OT.debug(e);var t,n,s,o={orientation:"videoDimensions",hasAudio:"hasAudio",hasVideo:"hasVideo"},r=e.key.split("/"),l=i(e.streamId),c=e.value;return r=r.length>0?r[r.length-1]:null,r&&o[r]?(n=o[r],s=a(e.streamId,n,e.value),"orientation"===r&&(t=g[e.streamId],t&&t.streamOrientationDidChange(e.value.width,e.value.height,e.value.videoOrientation),c={width:c.width,height:c.height}),this.dispatchEvent(new OT.StreamPropertyChangedEvent(OT.Event.names.STREAM_PROPERTY_CHANGED,l,n,s,c)),void 0):(OT.warn("Unknown stream property was modified."),void 0)},M=function(e){if(!(0>=e.streams.length)){e.streams=OT._.filter(e.streams,function(e){return n(e)});var i=new OT.StreamEvent("streamDestroyed",e.streams,e.reason),s=function(){var n=!i.isDefaultPrevented();e.streams.forEach(function(e){var i=t(e.id);i&&(i.disconnect(),n&&$(i),delete m[i.guid]);for(var s in g)if(s===e.id){var o=g[s];o.disconnect(),n&&this.unsubscribe(o),delete g[s]}r(e.id)},this)};this.dispatchEvent(i,OT._.bind(s,this))}},j=function(e){if(OT.log("jsepMessageHandler: "+JSON.stringify(e)),f[e.fromAddress]||(OT.warn("OT.Session.onMessage: Received peerConnectionData from an unknown connection."),f[e.fromAddress]=new OT.Connection(e.fromAddress,new Date,null,{supportsWebRTC:!0})),e.hasOwnProperty("streamId")){var n=null;if(n=e.type==OT.WebSocketMessageType.JSEP_SUBSCRIBE||e.type==OT.WebSocketMessageType.JSEP_UNSUBSCRIBE?t(e.streamId,!0):t(e.streamId,!0)||g[e.streamId],!n)return OT.warn("OT.Session.onMessage: Received peerConnectionData for an unknown publisher."),void 0;n.processMessage(e.type,f[e.fromAddress],e)}},P=function(e){var t=new OT.SignalEvent("signalReceived",f[e.fromAddress]);this.dispatchEvent(t)},R=function(){c=null,u=null,l=null,h=!1,_=null,f={},v={}},L=function(){for(var e in m)m[e].disconnect();for(var t in g)g[t].disconnect()},$=function(e){C[e.guid]&&(e.off("destroyed",C[e.guid]),delete C[e.guid]),e.destroy()},B=function(){for(var e in m)$(m[e]);m={},C={};for(var t in g)g[t].destroy();g={}},H=function(e){C[e.guid]=OT._.bind(function(){this.unpublish(e)},this),e.on("destroyed",C[e.guid])},F=function(){TB.log("connectToMessenger"),this.properties={requireConnectionObjects:!0};var e=function(e){return function(t){return function(){return t.apply(e,arguments)}}}(this);d=new OT.Messenger(this.sessionInfo.messagingServer,new OT.SessionMessageWrangler(this)).on({SessionConnected:e(E),SessionConnectFailed:e(O),ConnectionClosed:e(x),ConnectionCreated:e(k),ConnectionDestroyed:e(A),StreamRegistered:e(D),StreamCreated:e(I),StreamModified:e(N),StreamDestroyed:e(M),JSEPMessageReceived:e(j),SignalReceived:e(P),exception:e(S)}),d.connect(y,u,{requireConnectionObjects:this.properties.requireConnectionObjects,p2pEnabled:this.sessionInfo.p2pEnabled,widgetId:T,partnerId:c})},q=function(){p&&OT.SessionInfo.get(this,OT._.bind(U,this),function(){p=!1})},U=function(e){p&&(this.sessionInfo=e,this.sessionInfo.partnerId&&(c=this.sessionInfo.partnerId),F.call(this))},W=function(e){return 1===_[e]};this.logEvent=function(e,t,n,i){w.logEvent({action:e,variation:t,payload_type:n,payload:i,session_id:y,partner_id:c,widget_id:T,widget_type:"Controller"})},this.connect=function(e,t){return h?(OT.warn("OT.Session: Cannot connect, already connected."),void 0):p?(OT.warn("OT.Session: Cannot connect, already connecting."),void 0):(p=!0,R.call(this),c=e.toString(),0===OT.APIKEY.length&&(OT.APIKEY=c),u=t,q.call(this),void 0)},this.disconnect=function(){p=!1,d&&(d.disconnect(),d=null,b=!1)},this.publish=function(e,t){var n;if(!h)throw w.logError(1010,"tb.exception","We need to be connected before you can publish",null,{action:"publish",variation:"Failure",payload_type:"reason",payload:"We need to be connected before you can publish",session_id:y,partner_id:c,widgetId:T,widget_type:"Controller"}),n="We need to be connected before you can publish",OT.error(n),new Error(n);if(!W("publish"))return w.logEvent({action:"publish",variation:"Failure",payload_type:"reason",payload:"This token does not allow publishing. The role must be at least `publisher` to enable this functionality",session_id:y,partner_id:c,widgetId:T,widget_type:"Controller"}),TB.handleJsException("This token does not allow publishing. The role must be at least `publisher` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_PUBLISH,{session:this}),null;if(e&&"string"!=typeof e){if(!(e instanceof OT.rtc.Publisher||e instanceof OT.flash.Publisher))throw n="Session.publish :: First parameter passed in is neither a string nor an instance of the Publisher",OT.error(n),new Error(n);"session"in e&&e.session&&"sessionId"in e.session&&(e.session.sessionId===this.sessionId?OT.warn("Cannot publish "+e.guid+" again to "+this.sessionId+". Please call session.unpublish(publisher) first."):OT.warn("Cannot publish "+e.guid+" publisher already attached to "+e.session.sessionId+". Please call session.unpublish(publisher) first."))}else e=OT.initPublisher(this.apiKey,e,t);return m[e.guid]=e,e._.publishToSession(this),H.call(this,e),e},this.unpublish=function(e){return e?(e._.unpublishFromSession(this),void 0):(OT.error("OT.Session.unpublish: publisher parameter missing."),void 0)},this.modifyStream=function(e,t,n){e&&t&&n||OT.error("OT.Session.modifyStream: must provide streamId, key and value to modify a stream property."),d.sendMessage(OT.WebSocketMessage.modifyStream(e,t,n))},this.subscribe=function(e,t,n){var i;if(!this.connection||!this.connection.connectionId)throw i="Session.subscribe :: Connection required to subscribe",OT.error(i),new Error(i);if(!e)throw i="Session.subscribe :: stream cannot be null",OT.error(i),new Error(i);if(!e.hasOwnProperty("streamId"))throw i="Session.subscribe :: invalid stream object",OT.error(i),new Error(i);var s=new OT.rtc.Subscriber(t,OT._.extend(n||{},{session:this}));return g[e.streamId]=s,s.subscribe(e),s},this.unsubscribe=function(e){if(!e){var t="OT.Session.unsubscribe: subscriber cannot be null";throw OT.error(t),new Error(t)}return e.stream?(OT.debug("OT.Session.unsubscribe: subscriber "+e.id),delete g[e.stream.id],e.destroy(),!0):(OT.warn("OT.Session.unsubscribe:: tried to unsubscribe a subscriber that had no stream"),!1)},this.getSubscribersForStream=function(e){return[g[e.id]]},this.getPublisherForStream=function(e){var n;if("string"==typeof e)n=e;else{if("object"!=typeof e||!e||!e.hasOwnProperty("id"))throw errorMsg="Session.getPublisherForStream :: Invalid stream type",OT.error(errorMsg),new Error(errorMsg);n=e.id}return t(n)},this.sendMessage=function(){return d.sendMessage.apply(d,arguments)},this.sendJSEPMessage=function(e,t,n){d&&d.connectionId?d.sendMessage(OT.WebSocketMessage.jsepMessage(d.connectionId,e.connectionId,t,n)):OT.warn("Session.sendJSEPMessage :: Tried to send a message without a _messenger")},this.forceDisconnect=function(e){if(W("forceDisconnect")){var t="string"==typeof e?e:e.id;d.sendMessage(OT.WebSocketMessage.forceDisconnect(t))}else TB.handleJsException("This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,{session:this})},this.forceUnpublish=function(e){if(W("forceUnpublish")){var t="string"==typeof e?e:e.id;d.sendMessage(OT.WebSocketMessage.forceUnpublish(t))}else TB.handleJsException("This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality",OT.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,{session:this})},this.getStateManager=function(){OT.warn("Fixme: Have not implemented session.getStateManager")},this.__defineGetter__("apiKey",function(){return c}),this.__defineGetter__("token",function(){return u}),this.__defineGetter__("connected",function(){return h}),this.__defineGetter__("connection",function(){return f[l]}),this.__defineSetter__("connection",function(e){e.hasOwnProperty("connectionId")&&(l=e.connectionId,f[l]=e)}),this.__defineGetter__("capabilities",function(){return _}),this.__defineGetter__("sessionId",function(){return y}),this.__defineGetter__("id",function(){return y}),this.__defineGetter__("connections",function(){return f}),this.__defineGetter__("publishers",function(){return m})}}(window),function(){OT.SessionMessageWrangler=function(e){var t=function(e){return new OT.Connection(e.connectionId,e.creationTime,e.data,{supportsWebRTC:e.supportsWebRTC})},n=function(e){return Object.keys(e).map(function(n){return t(e[n])})},i=function(t,n){function i(i){if(e.connections[t.connection.connectionId])return e.connections[t.connection.connectionId];if(n)for(var s=0,o=n.length;o>s;++s)if(i===n[s].id)return n[s];return null}var s=new OT.Stream(t.streamId,i(t.connection.connectionId),t.name,t.streamData,t.type,t.creationTime,t.hasAudio,t.hasVideo,t.orientation?t.orientation:{videoOrientation:OT.VideoOrientation.ROTATED_NORMAL,width:640,height:480},e.id,t.peerId,t.quality,t.orientation?t.orientation.width:640,t.orientation?t.orientation.height:480);return t.publisherId&&(s.publisherId=t.publisherId),s},s=function(e,t){var n=[];for(var s in e)if(e.hasOwnProperty(s)){var o=i(e[s],t);o&&n.push(o)}return n};this.wrangle=function(e){return e.sessionState?(e.sessionState.CONNECTIONS&&(e.connections=n(e.sessionState.CONNECTIONS)),e.sessionState.STREAMS&&(e.streams=s(e.sessionState.STREAMS,e.connections))):(e.streams&&(e.streams=s(e.streams,e.connections)),e.connection&&(e.connection=t(e.connection))),e}}}(window),function(){OT.onLoad(function(){var e=document.createElement("link");e.type="text/css",e.media="screen",e.rel="stylesheet",e.href=OT.BUILD_PROPERTIES.cssURL+"/ot.css";var t=document.head||document.getElementsByTagName("head")[0];t.appendChild(e)})}(window),jQuery(function(e){window.BrowsePhoto=Spine.Controller.create({elements:{},events:{},proxied:["activate","deactivate","onMouseOver","change"],template:function(){},init:function(){this.input=e("<input type='file'  multiple accept='image/*'>"),this.input.css({position:"fixed","z-index":1060,cursor:"pointer","-moz-opacity":"0",filter:"alpha(opacity: 0)",opacity:"0"}),this.input.mouseover(this.proxy(function(){this.el.addClass("upload_btn-hover")})),this.input.mouseout(this.proxy(function(){this.el.removeClass("upload_btn-hover"),this.input.detach()})),this.input.focus(this.proxy(function(){this.el.addClass("upload_btn-focus")})),this.input.blur(this.proxy(function(){this.el.removeClass("upload_btn-focus")})),console.log(this.el)},deActivate:function(){this.input.off("change"),this.el.off("mouseover"),console.log("deActivate")},activate:function(){console.log("input",this.input),this.input.on("change",this.change),this.el.on("mouseover",this.onMouseOver),console.log("activate")},change:function(e){return console.log("change"),this.onChange&&this.onChange.call(null,e),!1},onMouseOver:function(){return this.input.offset(this.el.offset()),this.input.width(this.el.outerWidth()),this.input.height(this.el.outerHeight()),e("body").append(this.input),!1}})}),jQuery(function(e){window.ProfilePhotoUpload=Spine.Controller.create({elements:{" .status":"progressStatus",".progress  .bar":"progressBar"},events:{},proxied:["upload","onUpload","uploadProgress","uploadError","uploadSuccess"],template:function(){},init:function(){},show:function(){this.el.html(this.render()),this.status=this.el.find(".status"),this.progressBar=this.el.find(".bar")},render:function(){return e("#post-upload-progress-tmpl").tmpl("")},upload:function(t,n,i,s){console.log("upload",n[0]),this.files=n,this.succCallback=i,this.errorCallback=s,this.show(),e.upload(t,{photo:n[0]},{contentType:"JSON",upload:{progress:this.uploadProgress,load:this.onUpload},error:this.uploadError,success:this.uploadSuccess})},uploadSuccess:function(e){console.log("success",e),this.succCallback&&this.succCallback.call(null,e),this.el.empty()},uploadError:function(e){this.showError(),this.errorCallback&&this.errorCallback.call(null,e)},uploadProgress:function(e){percentage=Math.round(100*(e.position/e.total)),console.log("progress",e),this.status&&this.status.text("uploading..."+percentage+"%"),this.progressBar&&this.progressBar.css({width:percentage+"%"})},onUpload:function(e){console.log("load",e)},uploadPhoto:function(){this.uploadPhotos.show()},showError:function(){this.el.html(e("#post-upload-error-tmpl").tmpl(""))}})}),jQuery(function($){window.TipList=Spine.Controller.create({elements:{".items":"itemsEl",".items .item":"handler",".grid-item":"gridHandler",".progress":"progress",".load":"load"},events:{},proxied:["render","addOne","show","addAll","prefetchComplete","onError","refresh","scroll","initGrid","update"],init:function(){this.items=[],this.params=this.params||{},console.log("params",this.params),this.handler.each(this.proxy(function(e){TipItemController.init({el:this.handler[e]})})),$(document).on("scroll",this.scroll),$("#tips").on("tips:refresh",this.refresh),$("#tips").on("tips:addOne",this.addOne)},initGrid:function(){this.gridHandler=this.el.find(".grid-item"),this.gridHandler.wookmark(this.gridOptions)},clearGrid:function(){this.gridHandler.wookmarkClear()},update:function(){this.clearGrid(),this.initGrid(),console.log("refresh")},addOne:function(e){console.log("item",e.data("collection_url"));try{if(url=e.data("collection_url"),!this.checkUrl(url))return;console.log("item",e),TipItemController.init({el:e}),this.itemsEl.append(e),this.refresh()}catch(t){console.log(t)}},refresh:function(){this.handler=this.itemsEl.find(".item"),console.log("refresh")},hideProgress:function(){this.progress&&this.progress.remove()},showProgress:function(e){this.hideProgress(),this.progress=$("#progress-tmpl").tmpl(e),this.progress.appendTo(this.el)},loadMore:function(){this.prefetching||this.prefetch()},addAll:function(e){$.each(e,this.proxy(function(t){this.addOne($(e[t]))}))},prefetch:function(){this.prefetching||(this.prefetching=!0,$.ajax({type:"GET",url:this.itemCollectionUrl,contentType:"application/json",data:this.params,success:this.prefetchComplete,error:this.onError}))},prefetchComplete:function(data){return data=eval(data),console.log(data),this.prefetching=!1,this.params=data.params,this.remaining=data.remaining,this.empty=data.empty,this.empty?(this.showEmptyMessage(),void 0):(this.addAll($(data.tips)),void 0)},checkUrl:function(e){return this.itemCollectionUrl===e},onError:function(e){console.log("error",e),this.hideProgress(),this.hideLoadProgress(),this.prefetching=!1},shouldScroll:function(){return $(window).scrollTop()+$(window).height()>$(document).height()-100},scroll:function(){var e=this.shouldScroll();console.log("shouldScroll",e),e&&this.loadMore()},doAction:function(e){return this.currentAnchor=$(e.currentTarget),this.itemsEl.find("li.item .actions li.active").removeClass("active"),this.current=$(e.currentTarget).closest("li"),this.current.addClass("active"),action=this.currentAnchor.data("action"),console.log("action",action),this.App.trigger(action,this.currentAnchor.attr("data-url"),this.current),this.currentAnchor.closest(".actions").removeClass("open"),!1}})}),jQuery(function(e){window.TipItemController=Spine.Controller.create({elements:{".ops-trigger":"opsTrigger"},events:{"click .ops-trigger":"onOpsTrigger","click .op":"doAction"},proxied:["remove","render","update"],template:function(t){return e("#tip-item-tmpl").tmpl(t)},init:function(){},update:function(){this.render()},render:function(e){e&&(this.item=e);var t=this.template(this.item);return this.el.replaceWith(t),this.el=t,this},remove:function(){this.el.remove()},doAction:function(t){this.currentAnchor=e(t.currentTarget),this.current=e(t.currentTarget).closest("li"),action=this.currentAnchor.data("action"),console.log("action",action)},onOpsTrigger:function(){return console.log("onOpsTrigger"),this.opsTrigger.hasClass("loading")?!1:(parent=this.opsTrigger.parent(),parent.hasClass("open")?parent.removeClass("open"):parent.addClass("open"),!1)}})}),jQuery(function(){window.Tips=Spine.Controller.create({elements:{"#tips":"tipsEl"},events:{},proxied:[],init:function(){this.tipsUrl=this.tipsEl.data("collection_url"),this.params={page:this.tipsEl.data("page"),per_page:this.tipsEl.data("per_page")},console.log("collection_url",this.tipsUrl),this.tips=TipList.init({el:this.tipsEl,itemCollectionUrl:this.tipsUrl,params:this.params,empty:this.tipsEl.data("empty"),remaining:this.tipsEl.data("remaining")}),this.currentController=this.tips}})});var Base64=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t={encode:function(t){var n,i,s,o,r,a,l,c="",u=0;do n=t.charCodeAt(u++),i=t.charCodeAt(u++),s=t.charCodeAt(u++),o=n>>2,r=(3&n)<<4|i>>4,a=(15&i)<<2|s>>6,l=63&s,isNaN(i)?a=l=64:isNaN(s)&&(l=64),c=c+e.charAt(o)+e.charAt(r)+e.charAt(a)+e.charAt(l);while(t.length>u);return c},decode:function(t){var n,i,s,o,r,a,l,c="",u=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do o=e.indexOf(t.charAt(u++)),r=e.indexOf(t.charAt(u++)),a=e.indexOf(t.charAt(u++)),l=e.indexOf(t.charAt(u++)),n=o<<2|r>>4,i=(15&r)<<4|a>>2,s=(3&a)<<6|l,c+=String.fromCharCode(n),64!=a&&(c+=String.fromCharCode(i)),64!=l&&(c+=String.fromCharCode(s));while(t.length>u);return c}};return t}(),MD5=function(){var e=0,t="",n=8,i=function(e,t){var n=(65535&e)+(65535&t),i=(e>>16)+(t>>16)+(n>>16);return i<<16|65535&n},s=function(e,t){return e<<t|e>>>32-t},o=function(e){for(var t=[],i=(1<<n)-1,s=0;e.length*n>s;s+=n)t[s>>5]|=(e.charCodeAt(s/n)&i)<<s%32;return t},r=function(e){for(var t="",i=(1<<n)-1,s=0;32*e.length>s;s+=n)t+=String.fromCharCode(e[s>>5]>>>s%32&i);return t},a=function(t){for(var n=e?"0123456789ABCDEF":"0123456789abcdef",i="",s=0;4*t.length>s;s++)i+=n.charAt(15&t[s>>2]>>8*(s%4)+4)+n.charAt(15&t[s>>2]>>8*(s%4));return i},l=function(e){for(var n,i,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="",r=0;4*e.length>r;r+=3)for(n=(255&e[r>>2]>>8*(r%4))<<16|(255&e[r+1>>2]>>8*((r+1)%4))<<8|255&e[r+2>>2]>>8*((r+2)%4),i=0;4>i;i++)o+=8*r+6*i>32*e.length?t:s.charAt(63&n>>6*(3-i));return o},c=function(e,t,n,o,r,a){return i(s(i(i(t,e),i(o,a)),r),n)},u=function(e,t,n,i,s,o,r){return c(t&n|~t&i,e,t,s,o,r)},d=function(e,t,n,i,s,o,r){return c(t&i|n&~i,e,t,s,o,r)},h=function(e,t,n,i,s,o,r){return c(t^n^i,e,t,s,o,r)},p=function(e,t,n,i,s,o,r){return c(n^(t|~i),e,t,s,o,r)},f=function(e,t){e[t>>5]|=128<<t%32,e[(t+64>>>9<<4)+14]=t;for(var n,s,o,r,a=1732584193,l=-271733879,c=-1732584194,f=271733878,m=0;e.length>m;m+=16)n=a,s=l,o=c,r=f,a=u(a,l,c,f,e[m+0],7,-680876936),f=u(f,a,l,c,e[m+1],12,-389564586),c=u(c,f,a,l,e[m+2],17,606105819),l=u(l,c,f,a,e[m+3],22,-1044525330),a=u(a,l,c,f,e[m+4],7,-176418897),f=u(f,a,l,c,e[m+5],12,1200080426),c=u(c,f,a,l,e[m+6],17,-1473231341),l=u(l,c,f,a,e[m+7],22,-45705983),a=u(a,l,c,f,e[m+8],7,1770035416),f=u(f,a,l,c,e[m+9],12,-1958414417),c=u(c,f,a,l,e[m+10],17,-42063),l=u(l,c,f,a,e[m+11],22,-1990404162),a=u(a,l,c,f,e[m+12],7,1804603682),f=u(f,a,l,c,e[m+13],12,-40341101),c=u(c,f,a,l,e[m+14],17,-1502002290),l=u(l,c,f,a,e[m+15],22,1236535329),a=d(a,l,c,f,e[m+1],5,-165796510),f=d(f,a,l,c,e[m+6],9,-1069501632),c=d(c,f,a,l,e[m+11],14,643717713),l=d(l,c,f,a,e[m+0],20,-373897302),a=d(a,l,c,f,e[m+5],5,-701558691),f=d(f,a,l,c,e[m+10],9,38016083),c=d(c,f,a,l,e[m+15],14,-660478335),l=d(l,c,f,a,e[m+4],20,-405537848),a=d(a,l,c,f,e[m+9],5,568446438),f=d(f,a,l,c,e[m+14],9,-1019803690),c=d(c,f,a,l,e[m+3],14,-187363961),l=d(l,c,f,a,e[m+8],20,1163531501),a=d(a,l,c,f,e[m+13],5,-1444681467),f=d(f,a,l,c,e[m+2],9,-51403784),c=d(c,f,a,l,e[m+7],14,1735328473),l=d(l,c,f,a,e[m+12],20,-1926607734),a=h(a,l,c,f,e[m+5],4,-378558),f=h(f,a,l,c,e[m+8],11,-2022574463),c=h(c,f,a,l,e[m+11],16,1839030562),l=h(l,c,f,a,e[m+14],23,-35309556),a=h(a,l,c,f,e[m+1],4,-1530992060),f=h(f,a,l,c,e[m+4],11,1272893353),c=h(c,f,a,l,e[m+7],16,-155497632),l=h(l,c,f,a,e[m+10],23,-1094730640),a=h(a,l,c,f,e[m+13],4,681279174),f=h(f,a,l,c,e[m+0],11,-358537222),c=h(c,f,a,l,e[m+3],16,-722521979),l=h(l,c,f,a,e[m+6],23,76029189),a=h(a,l,c,f,e[m+9],4,-640364487),f=h(f,a,l,c,e[m+12],11,-421815835),c=h(c,f,a,l,e[m+15],16,530742520),l=h(l,c,f,a,e[m+2],23,-995338651),a=p(a,l,c,f,e[m+0],6,-198630844),f=p(f,a,l,c,e[m+7],10,1126891415),c=p(c,f,a,l,e[m+14],15,-1416354905),l=p(l,c,f,a,e[m+5],21,-57434055),a=p(a,l,c,f,e[m+12],6,1700485571),f=p(f,a,l,c,e[m+3],10,-1894986606),c=p(c,f,a,l,e[m+10],15,-1051523),l=p(l,c,f,a,e[m+1],21,-2054922799),a=p(a,l,c,f,e[m+8],6,1873313359),f=p(f,a,l,c,e[m+15],10,-30611744),c=p(c,f,a,l,e[m+6],15,-1560198380),l=p(l,c,f,a,e[m+13],21,1309151649),a=p(a,l,c,f,e[m+4],6,-145523070),f=p(f,a,l,c,e[m+11],10,-1120210379),c=p(c,f,a,l,e[m+2],15,718787259),l=p(l,c,f,a,e[m+9],21,-343485551),a=i(a,n),l=i(l,s),c=i(c,o),f=i(f,r);
return[a,l,c,f]},m=function(e,t){var i=o(e);i.length>16&&(i=f(i,e.length*n));for(var s=new Array(16),r=new Array(16),a=0;16>a;a++)s[a]=909522486^i[a],r[a]=1549556828^i[a];var l=f(s.concat(o(t)),512+t.length*n);return f(r.concat(l),640)},g={hexdigest:function(e){return a(f(o(e),e.length*n))},b64digest:function(e){return l(f(o(e),e.length*n))},hash:function(e){return r(f(o(e),e.length*n))},hmac_hexdigest:function(e,t){return a(m(e,t))},hmac_b64digest:function(e,t){return l(m(e,t))},hmac_hash:function(e,t){return r(m(e,t))},test:function(){return"900150983cd24fb0d6963f7d28e17f72"===MD5.hexdigest("abc")}};return g}();/*
    This program is distributed under the terms of the MIT license.
    Please see the LICENSE file for details.

    Copyright 2006-2008, OGG, LLC
*/
Function.prototype.bind||(Function.prototype.bind=function(e){var t=this,n=Array.prototype.slice,i=Array.prototype.concat,s=n.call(arguments,1);return function(){return t.apply(e?e:this,i.call(s,n.call(arguments,0)))}}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for(n=0>n?Math.ceil(n):Math.floor(n),0>n&&(n+=t);t>n;n++)if(n in this&&this[n]===e)return n;return-1}),function(e){function t(e,t){return new o.Builder(e,t)}function n(e){return new o.Builder("message",e)}function i(e){return new o.Builder("iq",e)}function s(e){return new o.Builder("presence",e)}var o;o={VERSION:"@VERSION@",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(e,t){o.NS[e]=t},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,forEachChild:function(e,t,n){var i,s;for(i=0;e.childNodes.length>i;i++)s=e.childNodes[i],s.nodeType!=o.ElementType.NORMAL||t&&!this.isTagEqual(s,t)||n(s)},isTagEqual:function(e,t){return e.tagName.toLowerCase()==t.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var e;return window.ActiveXObject?(e=this._getIEXmlDom(),e.appendChild(e.createElement("strophe"))):e=document.implementation.createDocument("jabber:client","strophe",null),e},xmlGenerator:function(){return o._xmlGenerator||(o._xmlGenerator=o._makeGenerator()),o._xmlGenerator},_getIEXmlDom:function(){for(var e=null,t=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],n=0;t.length>n&&null===e;n++)try{e=new ActiveXObject(t[n])}catch(i){e=null}return e},xmlElement:function(e){if(!e)return null;var t,n,i,s=o.xmlGenerator().createElement(e);for(t=1;arguments.length>t;t++)if(arguments[t])if("string"==typeof arguments[t]||"number"==typeof arguments[t])s.appendChild(o.xmlTextNode(arguments[t]));else if("object"==typeof arguments[t]&&"function"==typeof arguments[t].sort)for(n=0;arguments[t].length>n;n++)"object"==typeof arguments[t][n]&&"function"==typeof arguments[t][n].sort&&s.setAttribute(arguments[t][n][0],arguments[t][n][1]);else if("object"==typeof arguments[t])for(i in arguments[t])arguments[t].hasOwnProperty(i)&&s.setAttribute(i,arguments[t][i]);return s},xmlescape:function(e){return e=e.replace(/\&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;")},xmlTextNode:function(e){return e=o.xmlescape(e),o.xmlGenerator().createTextNode(e)},getText:function(e){if(!e)return null;var t="";0===e.childNodes.length&&e.nodeType==o.ElementType.TEXT&&(t+=e.nodeValue);for(var n=0;e.childNodes.length>n;n++)e.childNodes[n].nodeType==o.ElementType.TEXT&&(t+=e.childNodes[n].nodeValue);return t},copyElement:function(e){var t,n;if(e.nodeType==o.ElementType.NORMAL){for(n=o.xmlElement(e.tagName),t=0;e.attributes.length>t;t++)n.setAttribute(e.attributes[t].nodeName.toLowerCase(),e.attributes[t].value);for(t=0;e.childNodes.length>t;t++)n.appendChild(o.copyElement(e.childNodes[t]))}else e.nodeType==o.ElementType.TEXT&&(n=o.xmlTextNode(e.nodeValue));return n},escapeNode:function(e){return e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){return 0>e.indexOf("@")?null:e.split("@")[0]},getDomainFromJid:function(e){var t=o.getBareJidFromJid(e);if(0>t.indexOf("@"))return t;var n=t.split("@");return n.splice(0,1),n.join("@")},getResourceFromJid:function(e){var t=e.split("/");return 2>t.length?null:(t.splice(0,1),t.join("/"))},getBareJidFromJid:function(e){return e?e.split("/")[0]:null},log:function(){},debug:function(e){this.log(this.LogLevel.DEBUG,e)},info:function(e){this.log(this.LogLevel.INFO,e)},warn:function(e){this.log(this.LogLevel.WARN,e)},error:function(e){this.log(this.LogLevel.ERROR,e)},fatal:function(e){this.log(this.LogLevel.FATAL,e)},serialize:function(e){var t;if(!e)return null;"function"==typeof e.tree&&(e=e.tree());var n,i,s=e.nodeName;for(e.getAttribute("_realname")&&(s=e.getAttribute("_realname")),t="<"+s,n=0;e.attributes.length>n;n++)"_realname"!=e.attributes[n].nodeName&&(t+=" "+e.attributes[n].nodeName.toLowerCase()+"='"+e.attributes[n].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'");if(e.childNodes.length>0){for(t+=">",n=0;e.childNodes.length>n;n++)i=e.childNodes[n],i.nodeType==o.ElementType.NORMAL?t+=o.serialize(i):i.nodeType==o.ElementType.TEXT&&(t+=i.nodeValue);t+="</"+s+">"}else t+="/>";return t},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){o._connectionPlugins[e]=t}},o.Builder=function(e,t){("presence"==e||"message"==e||"iq"==e)&&(t&&!t.xmlns?t.xmlns=o.NS.CLIENT:t||(t={xmlns:o.NS.CLIENT})),this.nodeTree=o.xmlElement(e,t),this.node=this.nodeTree},o.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return o.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},attrs:function(e){for(var t in e)e.hasOwnProperty(t)&&this.node.setAttribute(t,e[t]);return this},c:function(e,t){var n=o.xmlElement(e,t);return this.node.appendChild(n),this.node=n,this},cnode:function(e){var t=o.xmlGenerator(),n=t.importNode?t.importNode(e,!0):o.copyElement(e);return this.node.appendChild(n),this.node=n,this},t:function(e){var t=o.xmlTextNode(e);return this.node.appendChild(t),this}},o.Handler=function(e,t,n,i,s,r,a){this.handler=e,this.ns=t,this.name=n,this.type=i,this.id=s,this.options=a||{matchbare:!1},this.options.matchBare||(this.options.matchBare=!1),this.from=this.options.matchBare?r?o.getBareJidFromJid(r):null:r,this.user=!0},o.Handler.prototype={isMatch:function(e){var t,n=null;if(n=this.options.matchBare?o.getBareJidFromJid(e.getAttribute("from")):e.getAttribute("from"),t=!1,this.ns){var i=this;o.forEachChild(e,null,function(e){e.getAttribute("xmlns")==i.ns&&(t=!0)}),t=t||e.getAttribute("xmlns")==this.ns}else t=!0;return!t||this.name&&!o.isTagEqual(e,this.name)||this.type&&e.getAttribute("type")!=this.type||this.id&&e.getAttribute("id")!=this.id||this.from&&n!=this.from?!1:!0},run:function(e){var t=null;try{t=this.handler(e)}catch(n){throw n.sourceURL?o.fatal("error: "+this.handler+" "+n.sourceURL+":"+n.line+" - "+n.name+": "+n.message):n.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",n,n.message)),o.fatal("error: "+this.handler+" "+n.fileName+":"+n.lineNumber+" - "+n.name+": "+n.message)):o.fatal("error: "+this.handler),n}return t},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},o.TimedHandler=function(e,t){this.period=e,this.handler=t,this.lastCalled=(new Date).getTime(),this.user=!0},o.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},o.Request=function(e,t,n,i){this.id=++o._requestId,this.xmlData=e,this.data=o.serialize(e),this.origFunc=t,this.func=t,this.rid=n,this.date=0/0,this.sends=i||0,this.abort=!1,this.dead=null,this.age=function(){if(!this.date)return 0;var e=new Date;return(e-this.date)/1e3},this.timeDead=function(){if(!this.dead)return 0;var e=new Date;return(e-this.dead)/1e3},this.xhr=this._newXHR()},o.Request.prototype={getResponse:function(){var e=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(e=this.xhr.responseXML.documentElement,"parsererror"==e.tagName)throw o.error("invalid response received"),o.error("responseText: "+this.xhr.responseText),o.error("responseXML: "+o.serialize(this.xhr.responseXML)),"parsererror"}else this.xhr.responseText&&(o.error("invalid response received"),o.error("responseText: "+this.xhr.responseText),o.error("responseXML: "+o.serialize(this.xhr.responseXML)));return e},_newXHR:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("text/xml")):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=this.func.bind(null,this),e}},o.Connection=function(e){this.service=e,this.jid="",this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.streamId=null,this.features=null,this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this.paused=!1,this.hold=1,this.wait=60,this.window=5,this._data=[],this._requests=[],this._uniqueId=Math.round(1e4*Math.random()),this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var t in o._connectionPlugins)if(o._connectionPlugins.hasOwnProperty(t)){var n=o._connectionPlugins[t],i=function(){};i.prototype=n,this[t]=new i,this[t].init(this)}},o.Connection.prototype={reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.streamId=null,this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this._requests=[],this._uniqueId=Math.round(1e4*Math.random())},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(e){return"string"==typeof e||"number"==typeof e?++this._uniqueId+":"+e:++this._uniqueId+""},connect:function(e,t,n,i,s){this.jid=e,this.pass=t,this.connect_callback=n,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.errors=0,this.wait=i||this.wait,this.hold=s||this.hold,this.domain=o.getDomainFromJid(this.jid);var r=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":o.NS.BOSH});this._changeConnectStatus(o.Status.CONNECTING,null),this._requests.push(new o.Request(r.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),r.tree().getAttribute("rid"))),this._throttledRequestHandler()},attach:function(e,t,n,i,s,r,a){this.jid=e,this.sid=t,this.rid=n,this.connect_callback=i,this.domain=o.getDomainFromJid(this.jid),this.authenticated=!0,this.connected=!0,this.wait=s||this.wait,this.hold=r||this.hold,this.window=a||this.window,this._changeConnectStatus(o.Status.ATTACHED,null)},xmlInput:function(){},xmlOutput:function(){},rawInput:function(){},rawOutput:function(){},send:function(e){if(null!==e){if("function"==typeof e.sort)for(var t=0;e.length>t;t++)this._queueData(e[t]);else"function"==typeof e.tree?this._queueData(e.tree()):this._queueData(e);this._throttledRequestHandler(),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendIQ:function(e,t,n,i){var s=null,o=this;"function"==typeof e.tree&&(e=e.tree());var r=e.getAttribute("id");r||(r=this.getUniqueId("sendIQ"),e.setAttribute("id",r));var a=this.addHandler(function(e){s&&o.deleteTimedHandler(s);var i=e.getAttribute("type");if("result"==i)t&&t(e);else{if("error"!=i)throw{name:"StropheError",message:"Got bad IQ type of "+i};n&&n(e)}},null,"iq",null,r);return i&&(s=this.addTimedHandler(i,function(){return o.deleteHandler(a),n&&n(null),!1})),this.send(e),r},_queueData:function(e){if(null===e||!e.tagName||!e.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(e)},_sendRestart:function(){this._data.push("restart"),this._throttledRequestHandler(),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(e,t){var n=new o.TimedHandler(e,t);return this.addTimeds.push(n),n},deleteTimedHandler:function(e){this.removeTimeds.push(e)},addHandler:function(e,t,n,i,s,r,a){var l=new o.Handler(e,t,n,i,s,r,a);return this.addHandlers.push(l),l},deleteHandler:function(e){this.removeHandlers.push(e)},disconnect:function(e){this._changeConnectStatus(o.Status.DISCONNECTING,e),o.info("Disconnect was called because: "+e),this.connected&&(this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._sendTerminate())},_changeConnectStatus:function(e,t){for(var n in o._connectionPlugins)if(o._connectionPlugins.hasOwnProperty(n)){var i=this[n];if(i.statusChanged)try{i.statusChanged(e,t)}catch(s){o.error(""+n+" plugin caused an exception "+"changing status: "+s)}}if(this.connect_callback)try{this.connect_callback(e,t)}catch(r){o.error("User connection callback caused an exception: "+r)}},_buildBody:function(){var e=t("body",{rid:this.rid++,xmlns:o.NS.HTTPBIND});return null!==this.sid&&e.attrs({sid:this.sid}),e},_removeRequest:function(e){o.debug("removing requests");var t;for(t=this._requests.length-1;t>=0;t--)e==this._requests[t]&&this._requests.splice(t,1);e.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(e){var t=this._requests[e];null===t.dead&&(t.dead=new Date),this._processRequest(e)},_processRequest:function(e){var t=this._requests[e],n=-1;try{4==t.xhr.readyState&&(n=t.xhr.status)}catch(i){o.error("caught an error in _requests["+e+"], reqStatus: "+n)}if("undefined"==typeof n&&(n=-1),t.sends>5)return this._onDisconnectTimeout(),void 0;var s=t.age(),r=!isNaN(s)&&s>Math.floor(o.TIMEOUT*this.wait),a=null!==t.dead&&t.timeDead()>Math.floor(o.SECONDARY_TIMEOUT*this.wait),l=4==t.xhr.readyState&&(1>n||n>=500);if((r||a||l)&&(a&&o.error("Request "+this._requests[e].id+" timed out (secondary), restarting"),t.abort=!0,t.xhr.abort(),t.xhr.onreadystatechange=function(){},this._requests[e]=new o.Request(t.xmlData,t.origFunc,t.rid,t.sends),t=this._requests[e]),0===t.xhr.readyState){o.debug("requests id "+t.id+"."+t.sends+" posting"),t.date=new Date;try{t.xhr.open("POST",this.service,!0)}catch(c){return o.error("XHR open failed."),this.connected||this._changeConnectStatus(o.Status.CONNFAIL,"bad-service"),this.disconnect(),void 0}var u=function(){t.xhr.send(t.data)};if(t.sends>1){var d=1e3*Math.pow(t.sends,3);setTimeout(u,d)}else u();t.sends++,this.xmlOutput(t.xmlData),this.rawOutput(t.data)}else o.debug("_processRequest: "+(0===e?"first":"second")+" requests has readyState of "+t.xhr.readyState)},_throttledRequestHandler:function(){this._requests?o.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):o.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))},_onRequestStateChange:function(e,t){if(o.debug("requests id "+t.id+"."+t.sends+" state changed to "+t.xhr.readyState),t.abort)return t.abort=!1,void 0;var n;if(4==t.xhr.readyState){n=0;try{n=t.xhr.status}catch(i){}if("undefined"==typeof n&&(n=0),this.disconnecting&&n>=400)return this._hitError(n),void 0;var s=this._requests[0]==t,r=this._requests[1]==t;(n>0&&500>n||t.sends>5)&&(this._removeRequest(t),o.debug("requests id "+t.id+" should now be removed")),200==n?((r||s&&this._requests.length>0&&this._requests[0].age()>Math.floor(o.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),o.debug("requests id "+t.id+"."+t.sends+" got 200"),e(t),this.errors=0):(o.error("requests id "+t.id+"."+t.sends+" error "+n+" happened"),(0===n||n>=400&&600>n||n>=12e3)&&(this._hitError(n),n>=400&&500>n&&(this._changeConnectStatus(o.Status.DISCONNECTING,null),this._doDisconnect()))),n>0&&500>n||t.sends>5||this._throttledRequestHandler()}},_hitError:function(e){this.errors++,o.warn("requests errored, status: "+e+", number of errors: "+this.errors),this.errors>4&&this._onDisconnectTimeout()},_doDisconnect:function(){o.info("_doDisconnect was called"),this.authenticated=!1,this.disconnecting=!1,this.sid=null,this.streamId=null,this.rid=Math.floor(4294967295*Math.random()),this.connected&&(this._changeConnectStatus(o.Status.DISCONNECTED,null),this.connected=!1),this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[]},_dataRecv:function(e){try{var t=e.getResponse()}catch(n){if("parsererror"!=n)throw n;this.disconnect("strophe-parsererror")}if(null!==t){this.xmlInput(t),this.rawInput(o.serialize(t));for(var i,s;this.removeHandlers.length>0;)s=this.removeHandlers.pop(),i=this.handlers.indexOf(s),i>=0&&this.handlers.splice(i,1);for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&0===this._requests.length)return this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this._doDisconnect(),void 0;var r,a,l=t.getAttribute("type");if(null!==l&&"terminate"==l){if(this.disconnecting)return;return r=t.getAttribute("condition"),a=t.getElementsByTagName("conflict"),null!==r?("remote-stream-error"==r&&a.length>0&&(r="conflict"),this._changeConnectStatus(o.Status.CONNFAIL,r)):this._changeConnectStatus(o.Status.CONNFAIL,"unknown"),this.disconnect(),void 0}var c=this;o.forEachChild(t,null,function(e){var t,n;for(n=c.handlers,c.handlers=[],t=0;n.length>t;t++){var i=n[t];!i.isMatch(e)||!c.authenticated&&i.user?c.handlers.push(i):i.run(e)&&c.handlers.push(i)}})}},_sendTerminate:function(){o.info("_sendTerminate was called");var e=this._buildBody().attrs({type:"terminate"});this.authenticated&&e.c("presence",{xmlns:o.NS.CLIENT,type:"unavailable"}),this.disconnecting=!0;var t=new o.Request(e.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),e.tree().getAttribute("rid"));this._requests.push(t),this._throttledRequestHandler()},_connect_cb:function(e){o.info("_connect_cb was called"),this.connected=!0;var n=e.getResponse();if(n){this.xmlInput(n),this.rawInput(o.serialize(n));var s,r,a=n.getAttribute("type");if(null!==a&&"terminate"==a)return s=n.getAttribute("condition"),r=n.getElementsByTagName("conflict"),null!==s?("remote-stream-error"==s&&r.length>0&&(s="conflict"),this._changeConnectStatus(o.Status.CONNFAIL,s)):this._changeConnectStatus(o.Status.CONNFAIL,"unknown"),void 0;this.sid||(this.sid=n.getAttribute("sid")),this.stream_id||(this.stream_id=n.getAttribute("authid"));var l=n.getAttribute("requests");l&&(this.window=parseInt(l,10));var c=n.getAttribute("hold");c&&(this.hold=parseInt(c,10));var u=n.getAttribute("wait");u&&(this.wait=parseInt(u,10));var d,h,p,f,m=!1,g=!1,v=!1,y=n.getElementsByTagName("mechanism");if(!(y.length>0)){var b=this._buildBody();return this._requests.push(new o.Request(b.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),b.tree().getAttribute("rid"))),this._throttledRequestHandler(),void 0}for(d=0;y.length>d;d++)h=o.getText(y[d]),"DIGEST-MD5"==h?g=!0:"PLAIN"==h?m=!0:"ANONYMOUS"==h&&(v=!0);null===o.getNodeFromJid(this.jid)&&v?(this._changeConnectStatus(o.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(t("auth",{xmlns:o.NS.SASL,mechanism:"ANONYMOUS"}).tree())):null===o.getNodeFromJid(this.jid)?(this._changeConnectStatus(o.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect()):g?(this._changeConnectStatus(o.Status.AUTHENTICATING,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(t("auth",{xmlns:o.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):m?(p=o.getBareJidFromJid(this.jid),p+="\0",p+=o.getNodeFromJid(this.jid),p+="\0",p+=this.pass,this._changeConnectStatus(o.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),f=Base64.encode(p),this.send(t("auth",{xmlns:o.NS.SASL,mechanism:"PLAIN"}).t(f).tree())):(this._changeConnectStatus(o.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(i({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:o.NS.AUTH}).c("username",{}).t(o.getNodeFromJid(this.jid)).tree()))}},_sasl_challenge1_cb:function(e){var n,i=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,s=Base64.decode(o.getText(e)),r=MD5.hexdigest(1234567890*Math.random()),a="",l=null,c="",u="";for(this.deleteHandler(this._sasl_failure_handler);s.match(i);)switch(n=s.match(i),s=s.replace(n[0],""),n[2]=n[2].replace(/^"(.+)"$/,"$1"),n[1]){case"realm":a=n[2];break;case"nonce":c=n[2];break;case"qop":u=n[2];break;case"host":l=n[2]}var d="xmpp/"+this.domain;null!==l&&(d=d+"/"+l);var h=MD5.hash(o.getNodeFromJid(this.jid)+":"+a+":"+this.pass)+":"+c+":"+r,p="AUTHENTICATE:"+d,f="";return f+="username="+this._quote(o.getNodeFromJid(this.jid))+",",f+="realm="+this._quote(a)+",",f+="nonce="+this._quote(c)+",",f+="cnonce="+this._quote(r)+",",f+='nc="00000001",',f+='qop="auth",',f+="digest-uri="+this._quote(d)+",",f+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(h)+":"+c+":00000001:"+r+":auth:"+MD5.hexdigest(p)))+",",f+='charset="utf-8"',this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(t("response",{xmlns:o.NS.SASL}).t(Base64.encode(f)).tree()),!1},_quote:function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(){return this.deleteHandler(this._sasl_success_handler),this.deleteHandler(this._sasl_failure_handler),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(t("response",{xmlns:o.NS.SASL}).tree()),!1},_auth1_cb:function(){var e=i({type:"set",id:"_auth_2"}).c("query",{xmlns:o.NS.AUTH}).c("username",{}).t(o.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return o.getResourceFromJid(this.jid)||(this.jid=o.getBareJidFromJid(this.jid)+"/strophe"),e.up().c("resource",{}).t(o.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(e.tree()),!1},_sasl_success_cb:function(){return o.info("SASL authentication succeeded."),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null),this._sendRestart(),!1},_sasl_auth1_cb:function(e){this.features=e;var t,n;for(t=0;e.childNodes.length>t;t++)n=e.childNodes[t],"bind"==n.nodeName&&(this.do_bind=!0),"session"==n.nodeName&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(o.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var s=o.getResourceFromJid(this.jid);return s?this.send(i({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:o.NS.BIND}).c("resource",{}).t(s).tree()):this.send(i({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:o.NS.BIND}).tree()),!1},_sasl_bind_cb:function(e){if("error"==e.getAttribute("type"))return o.info("SASL binding failed."),this._changeConnectStatus(o.Status.AUTHFAIL,null),!1;var t,n=e.getElementsByTagName("bind");return n.length>0?(t=n[0].getElementsByTagName("jid"),t.length>0&&(this.jid=o.getText(t[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(i({type:"set",id:"_session_auth_2"}).c("session",{xmlns:o.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(o.Status.CONNECTED,null))),void 0):(o.info("SASL binding failed."),this._changeConnectStatus(o.Status.AUTHFAIL,null),!1)},_sasl_session_cb:function(e){if("result"==e.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(o.Status.CONNECTED,null);else if("error"==e.getAttribute("type"))return o.info("Session creation failed."),this._changeConnectStatus(o.Status.AUTHFAIL,null),!1;return!1},_sasl_failure_cb:function(){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._changeConnectStatus(o.Status.AUTHFAIL,null),!1},_auth2_cb:function(e){return"result"==e.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(o.Status.CONNECTED,null)):"error"==e.getAttribute("type")&&(this._changeConnectStatus(o.Status.AUTHFAIL,null),this.disconnect()),!1},_addSysTimedHandler:function(e,t){var n=new o.TimedHandler(e,t);return n.user=!1,this.addTimeds.push(n),n},_addSysHandler:function(e,t,n,i,s){var r=new o.Handler(e,t,n,i,s);return r.user=!1,this.addHandlers.push(r),r},_onDisconnectTimeout:function(){o.info("_onDisconnectTimeout was called");for(var e;this._requests.length>0;)e=this._requests.pop(),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){};return this._doDisconnect(),!1},_onIdle:function(){for(var e,t,n,i;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)t=this.removeTimeds.pop(),e=this.timedHandlers.indexOf(t),e>=0&&this.timedHandlers.splice(e,1);var s=(new Date).getTime();for(i=[],e=0;this.timedHandlers.length>e;e++)t=this.timedHandlers[e],(this.authenticated||!t.user)&&(n=t.lastCalled+t.period,0>=n-s?t.run()&&i.push(t):i.push(t));this.timedHandlers=i;var r,a;if(this.authenticated&&0===this._requests.length&&0===this._data.length&&!this.disconnecting&&(o.info("no requests during idle cycle, sending blank requests"),this._data.push(null)),2>this._requests.length&&this._data.length>0&&!this.paused){for(r=this._buildBody(),e=0;this._data.length>e;e++)null!==this._data[e]&&("restart"===this._data[e]?r.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":o.NS.BOSH}):r.cnode(this._data[e]).up());delete this._data,this._data=[],this._requests.push(new o.Request(r.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),r.tree().getAttribute("rid"))),this._processRequest(this._requests.length-1)}this._requests.length>0&&(a=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(o.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),a>Math.floor(o.TIMEOUT*this.wait)&&(o.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(o.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())),clearTimeout(this._idleTimeout),this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}},e&&e(o,t,n,i,s)}(function(){window.Strophe=arguments[0],window.$build=arguments[1],window.$msg=arguments[2],window.$iq=arguments[3],window.$pres=arguments[4]}),/**
 * Version: 1.0 Alpha-1 
 * Build Date: 13-Nov-2007
 * Copyright (c) 2006-2007, Coolite Inc. (http://www.coolite.com/). All rights reserved.
 * License: Licensed under The MIT License. See license.txt and http://www.datejs.com/license/. 
 * Website: http://www.datejs.com/ or http://www.coolite.com/datejs/
 */
Date.CultureInfo={name:"en-GB",englishName:"English (United Kingdom)",nativeName:"English (United Kingdom)",dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbreviatedDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortestDayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],firstLetterDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:1,twoDigitYearMax:2029,dateElementOrder:"dmy",formatPatterns:{shortDate:"dd/MM/yyyy",longDate:"dd MMMM yyyy",shortTime:"HH:mm",longTime:"HH:mm:ss",fullDateTime:"dd MMMM yyyy HH:mm:ss",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"dd MMMM",yearMonth:"MMMM yyyy"},regexPatterns:{jan:/^jan(uary)?/i,feb:/^feb(ruary)?/i,mar:/^mar(ch)?/i,apr:/^apr(il)?/i,may:/^may/i,jun:/^jun(e)?/i,jul:/^jul(y)?/i,aug:/^aug(ust)?/i,sep:/^sep(t(ember)?)?/i,oct:/^oct(ober)?/i,nov:/^nov(ember)?/i,dec:/^dec(ember)?/i,sun:/^su(n(day)?)?/i,mon:/^mo(n(day)?)?/i,tue:/^tu(e(s(day)?)?)?/i,wed:/^we(d(nesday)?)?/i,thu:/^th(u(r(s(day)?)?)?)?/i,fri:/^fr(i(day)?)?/i,sat:/^sa(t(urday)?)?/i,future:/^next/i,past:/^last|past|prev(ious)?/i,add:/^(\+|after|from)/i,subtract:/^(\-|before|ago)/i,yesterday:/^yesterday/i,today:/^t(oday)?/i,tomorrow:/^tomorrow/i,now:/^n(ow)?/i,millisecond:/^ms|milli(second)?s?/i,second:/^sec(ond)?s?/i,minute:/^min(ute)?s?/i,hour:/^h(ou)?rs?/i,week:/^w(ee)?k/i,month:/^m(o(nth)?s?)?/i,day:/^d(ays?)?/i,year:/^y((ea)?rs?)?/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a|p)/i},abbreviatedTimeZoneStandard:{GMT:"-000",EST:"-0400",CST:"-0500",MST:"-0600",PST:"-0700"},abbreviatedTimeZoneDST:{GMT:"-000",EDT:"-0500",CDT:"-0600",MDT:"-0700",PDT:"-0800"}},Date.getMonthNumberFromName=function(e){for(var t=Date.CultureInfo.monthNames,n=Date.CultureInfo.abbreviatedMonthNames,i=e.toLowerCase(),s=0;t.length>s;s++)if(t[s].toLowerCase()==i||n[s].toLowerCase()==i)return s;return-1},Date.getDayNumberFromName=function(e){for(var t=Date.CultureInfo.dayNames,n=Date.CultureInfo.abbreviatedDayNames,i=(Date.CultureInfo.shortestDayNames,e.toLowerCase()),s=0;t.length>s;s++)if(t[s].toLowerCase()==i||n[s].toLowerCase()==i)return s;return-1},Date.isLeapYear=function(e){return 0===e%4&&0!==e%100||0===e%400},Date.getDaysInMonth=function(e,t){return[31,Date.isLeapYear(e)?29:28,31,30,31,30,31,31,30,31,30,31][t]},Date.getTimezoneOffset=function(e,t){return t?Date.CultureInfo.abbreviatedTimeZoneDST[e.toUpperCase()]:Date.CultureInfo.abbreviatedTimeZoneStandard[e.toUpperCase()]},Date.getTimezoneAbbreviation=function(e,t){var n,i=t?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard;for(n in i)if(i[n]===e)return n;return null},Date.prototype.clone=function(){return new Date(this.getTime())},Date.prototype.compareTo=function(e){if(isNaN(this))throw new Error(this);if(e instanceof Date&&!isNaN(e))return this>e?1:e>this?-1:0;throw new TypeError(e)},Date.prototype.equals=function(e){return 0===this.compareTo(e)},Date.prototype.between=function(e,t){var n=this.getTime();return n>=e.getTime()&&t.getTime()>=n},Date.prototype.addMilliseconds=function(e){return this.setMilliseconds(this.getMilliseconds()+e),this},Date.prototype.addSeconds=function(e){return this.addMilliseconds(1e3*e)},Date.prototype.addMinutes=function(e){return this.addMilliseconds(6e4*e)},Date.prototype.addHours=function(e){return this.addMilliseconds(36e5*e)},Date.prototype.addDays=function(e){return this.addMilliseconds(864e5*e)},Date.prototype.addWeeks=function(e){return this.addMilliseconds(6048e5*e)},Date.prototype.addMonths=function(e){var t=this.getDate();return this.setDate(1),this.setMonth(this.getMonth()+e),this.setDate(Math.min(t,this.getDaysInMonth())),this},Date.prototype.addYears=function(e){return this.addMonths(12*e)},Date.prototype.add=function(e){if("number"==typeof e)return this._orient=e,this;var t=e;return(t.millisecond||t.milliseconds)&&this.addMilliseconds(t.millisecond||t.milliseconds),(t.second||t.seconds)&&this.addSeconds(t.second||t.seconds),(t.minute||t.minutes)&&this.addMinutes(t.minute||t.minutes),(t.hour||t.hours)&&this.addHours(t.hour||t.hours),(t.month||t.months)&&this.addMonths(t.month||t.months),(t.year||t.years)&&this.addYears(t.year||t.years),(t.day||t.days)&&this.addDays(t.day||t.days),this},Date._validate=function(e,t,n,i){if("number"!=typeof e)throw new TypeError(e+" is not a Number.");if(t>e||e>n)throw new RangeError(e+" is not a valid value for "+i+".");return!0},Date.validateMillisecond=function(e){return Date._validate(e,0,999,"milliseconds")},Date.validateSecond=function(e){return Date._validate(e,0,59,"seconds")},Date.validateMinute=function(e){return Date._validate(e,0,59,"minutes")},Date.validateHour=function(e){return Date._validate(e,0,23,"hours")},Date.validateDay=function(e,t,n){return Date._validate(e,1,Date.getDaysInMonth(t,n),"days")},Date.validateMonth=function(e){return Date._validate(e,0,11,"months")},Date.validateYear=function(e){return Date._validate(e,1,9999,"seconds")},Date.prototype.set=function(e){var t=e;return t.millisecond||0===t.millisecond||(t.millisecond=-1),t.second||0===t.second||(t.second=-1),t.minute||0===t.minute||(t.minute=-1),t.hour||0===t.hour||(t.hour=-1),t.day||0===t.day||(t.day=-1),t.month||0===t.month||(t.month=-1),t.year||0===t.year||(t.year=-1),-1!=t.millisecond&&Date.validateMillisecond(t.millisecond)&&this.addMilliseconds(t.millisecond-this.getMilliseconds()),-1!=t.second&&Date.validateSecond(t.second)&&this.addSeconds(t.second-this.getSeconds()),-1!=t.minute&&Date.validateMinute(t.minute)&&this.addMinutes(t.minute-this.getMinutes()),-1!=t.hour&&Date.validateHour(t.hour)&&this.addHours(t.hour-this.getHours()),-1!==t.month&&Date.validateMonth(t.month)&&this.addMonths(t.month-this.getMonth()),-1!=t.year&&Date.validateYear(t.year)&&this.addYears(t.year-this.getFullYear()),-1!=t.day&&Date.validateDay(t.day,this.getFullYear(),this.getMonth())&&this.addDays(t.day-this.getDate()),t.timezone&&this.setTimezone(t.timezone),t.timezoneOffset&&this.setTimezoneOffset(t.timezoneOffset),this},Date.prototype.clearTime=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},Date.prototype.isLeapYear=function(){var e=this.getFullYear();return 0===e%4&&0!==e%100||0===e%400},Date.prototype.isWeekday=function(){return!(this.is().sat()||this.is().sun())},Date.prototype.getDaysInMonth=function(){return Date.getDaysInMonth(this.getFullYear(),this.getMonth())},Date.prototype.moveToFirstDayOfMonth=function(){return this.set({day:1})},Date.prototype.moveToLastDayOfMonth=function(){return this.set({day:this.getDaysInMonth()})},Date.prototype.moveToDayOfWeek=function(e,t){var n=(e-this.getDay()+7*(t||1))%7;return this.addDays(0===n?n+=7*(t||1):n)},Date.prototype.moveToMonth=function(e,t){var n=(e-this.getMonth()+12*(t||1))%12;return this.addMonths(0===n?n+=12*(t||1):n)},Date.prototype.getDayOfYear=function(){return Math.floor((this-new Date(this.getFullYear(),0,1))/864e5)},Date.prototype.getWeekOfYear=function(e){var t=this.getFullYear(),n=this.getMonth(),i=this.getDate(),s=e||Date.CultureInfo.firstDayOfWeek,o=8-new Date(t,0,1).getDay();8==o&&(o=1);var r=(Date.UTC(t,n,i,0,0,0)-Date.UTC(t,0,1,0,0,0))/864e5+1,a=Math.floor((r-o+7)/7);if(a===s){t--;var l=8-new Date(t,0,1).getDay();a=2==l||8==l?53:52}return a},Date.prototype.isDST=function(){return console.log("isDST"),"D"==this.toString().match(/(E|C|M|P)(S|D)T/)[2]},Date.prototype.getTimezone=function(){return Date.getTimezoneAbbreviation(this.getUTCOffset,this.isDST())},Date.prototype.setTimezoneOffset=function(e){var t=this.getTimezoneOffset(),n=-6*Number(e)/10;return this.addMinutes(n-t),this},Date.prototype.setTimezone=function(e){return this.setTimezoneOffset(Date.getTimezoneOffset(e))},Date.prototype.getUTCOffset=function(){var e,t=-10*this.getTimezoneOffset()/6;return 0>t?(e=(t-1e4).toString(),e[0]+e.substr(2)):(e=(t+1e4).toString(),"+"+e.substr(1))},Date.prototype.getDayName=function(e){return e?Date.CultureInfo.abbreviatedDayNames[this.getDay()]:Date.CultureInfo.dayNames[this.getDay()]},Date.prototype.getMonthName=function(e){return e?Date.CultureInfo.abbreviatedMonthNames[this.getMonth()]:Date.CultureInfo.monthNames[this.getMonth()]},Date.prototype._toString=Date.prototype.toString,Date.prototype.toString=function(e){var t=this,n=function n(e){return 1==e.toString().length?"0"+e:e};return e?e.replace(/dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?/g,function(e){switch(e){case"hh":return n(13>t.getHours()?t.getHours():t.getHours()-12);case"h":return 13>t.getHours()?t.getHours():t.getHours()-12;case"HH":return n(t.getHours());case"H":return t.getHours();case"mm":return n(t.getMinutes());case"m":return t.getMinutes();case"ss":return n(t.getSeconds());case"s":return t.getSeconds();case"yyyy":return t.getFullYear();case"yy":return t.getFullYear().toString().substring(2,4);case"dddd":return t.getDayName();case"ddd":return t.getDayName(!0);case"dd":return n(t.getDate());case"d":return t.getDate().toString();case"MMMM":return t.getMonthName();case"MMM":return t.getMonthName(!0);case"MM":return n(t.getMonth()+1);case"M":return t.getMonth()+1;case"t":return 12>t.getHours()?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return 12>t.getHours()?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"zzz":case"zz":case"z":return""}}):this._toString()},Date.now=function(){return new Date},Date.today=function(){return Date.now().clearTime()},Date.prototype._orient=1,Date.prototype.next=function(){return this._orient=1,this},Date.prototype.last=Date.prototype.prev=Date.prototype.previous=function(){return this._orient=-1,this},Date.prototype._is=!1,Date.prototype.is=function(){return this._is=!0,this},Number.prototype._dateElement="day",Number.prototype.fromNow=function(){var e={};return e[this._dateElement]=this,Date.now().add(e)},Number.prototype.ago=function(){var e={};return e[this._dateElement]=-1*this,Date.now().add(e)},function(){for(var e,t=Date.prototype,n=Number.prototype,i="sunday monday tuesday wednesday thursday friday saturday".split(/\s/),s="january february march april may june july august september october november december".split(/\s/),o="Millisecond Second Minute Hour Day Week Month Year".split(/\s/),r=function(e){return function(){return this._is?(this._is=!1,this.getDay()==e):this.moveToDayOfWeek(e,this._orient)}},a=0;i.length>a;a++)t[i[a]]=t[i[a].substring(0,3)]=r(a);for(var l=function(e){return function(){return this._is?(this._is=!1,this.getMonth()===e):this.moveToMonth(e,this._orient)}},c=0;s.length>c;c++)t[s[c]]=t[s[c].substring(0,3)]=l(c);for(var u=function(e){return function(){return"s"!=e.substring(e.length-1)&&(e+="s"),this["add"+e](this._orient)}},d=function(e){return function(){return this._dateElement=e,this}},h=0;o.length>h;h++)e=o[h].toLowerCase(),t[e]=t[e+"s"]=u(o[h]),n[e]=n[e+"s"]=d(e)}(),Date.prototype.toJSONString=function(){return this.toString("yyyy-MM-ddThh:mm:ssZ")},Date.prototype.toShortDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortDatePattern)},Date.prototype.toLongDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.longDatePattern)},Date.prototype.toShortTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortTimePattern)},Date.prototype.toLongTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.longTimePattern)},Date.prototype.getOrdinal=function(){switch(this.getDate()){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}},function(){Date.Parsing={Exception:function(e){this.message="Parse error at '"+e.substring(0,10)+" ...'"}};for(var e=Date.Parsing,t=e.Operators={rtoken:function(t){return function(n){var i=n.match(t);if(i)return[i[0],n.substring(i[0].length)];throw new e.Exception(n)}},token:function(){return function(e){return t.rtoken(new RegExp("^s*"+e+"s*"))(e)}},stoken:function(e){return t.rtoken(new RegExp("^"+e))},until:function(e){return function(t){for(var n=[],i=null;t.length;){try{i=e.call(this,t)}catch(s){n.push(i[0]),t=i[1];continue}break}return[n,t]}},many:function(e){return function(t){for(var n=[],i=null;t.length;){try{i=e.call(this,t)}catch(s){return[n,t]}n.push(i[0]),t=i[1]}return[n,t]}},optional:function(e){return function(t){var n=null;try{n=e.call(this,t)}catch(i){return[null,t]}return[n[0],n[1]]}},not:function(t){return function(n){try{t.call(this,n)}catch(i){return[null,n]}throw new e.Exception(n)}},ignore:function(e){return e?function(t){var n=null;return n=e.call(this,t),[null,n[1]]}:null},product:function(){for(var e=arguments[0],n=Array.prototype.slice.call(arguments,1),i=[],s=0;e.length>s;s++)i.push(t.each(e[s],n));return i},cache:function(t){var n={},i=null;return function(s){try{i=n[s]=n[s]||t.call(this,s)}catch(o){i=n[s]=o}if(i instanceof e.Exception)throw i;return i}},any:function(){var t=arguments;return function(n){for(var i=null,s=0;t.length>s;s++)if(null!=t[s]){try{i=t[s].call(this,n)}catch(o){i=null}if(i)return i}throw new e.Exception(n)}},each:function(){var t=arguments;return function(n){for(var i=[],s=null,o=0;t.length>o;o++)if(null!=t[o]){try{s=t[o].call(this,n)}catch(r){throw new e.Exception(n)}i.push(s[0]),n=s[1]}return[i,n]}},all:function(){var e=arguments,t=t;return t.each(t.optional(e))},sequence:function(n,i,s){return i=i||t.rtoken(/^\s*/),s=s||null,1==n.length?n[0]:function(t){for(var o=null,r=null,a=[],l=0;n.length>l;l++){try{o=n[l].call(this,t)}catch(c){break}a.push(o[0]);try{r=i.call(this,o[1])}catch(u){r=null;break}t=r[1]}if(!o)throw new e.Exception(t);if(r)throw new e.Exception(r[1]);if(s)try{o=s.call(this,o[1])}catch(d){throw new e.Exception(o[1])}return[a,o?o[1]:t]}},between:function(e,n,i){i=i||e;var s=t.each(t.ignore(e),n,t.ignore(i));return function(e){var t=s.call(this,e);return[[t[0][0],r[0][2]],t[1]]}},list:function(e,n,i){return n=n||t.rtoken(/^\s*/),i=i||null,e instanceof Array?t.each(t.product(e.slice(0,-1),t.ignore(n)),e.slice(-1),t.ignore(i)):t.each(t.many(t.each(e,t.ignore(n))),px,t.ignore(i))},set:function(n,i,s){return i=i||t.rtoken(/^\s*/),s=s||null,function(o){for(var r=null,a=null,l=null,c=null,u=[[],o],d=!1,h=0;n.length>h;h++){l=null,a=null,r=null,d=1==n.length;try{r=n[h].call(this,o)}catch(p){continue}if(c=[[r[0]],r[1]],r[1].length>0&&!d)try{l=i.call(this,r[1])}catch(f){d=!0}else d=!0;if(d||0!==l[1].length||(d=!0),!d){for(var m=[],g=0;n.length>g;g++)h!=g&&m.push(n[g]);a=t.set(m,i).call(this,l[1]),a[0].length>0&&(c[0]=c[0].concat(a[0]),c[1]=a[1])}if(c[1].length<u[1].length&&(u=c),0===u[1].length)break}if(0===u[0].length)return u;if(s){try{l=s.call(this,u[1])}catch(v){throw new e.Exception(u[1])}u[1]=l[1]}return u}},forward:function(e,t){return function(n){return e[t].call(this,n)}},replace:function(e,t){return function(n){var i=e.call(this,n);return[t,i[1]]}},process:function(e,t){return function(n){var i=e.call(this,n);return[t.call(this,i[0]),i[1]]}},min:function(t,n){return function(i){var s=n.call(this,i);if(t>s[0].length)throw new e.Exception(i);return s}}},n=function(e){return function(){var t=null,n=[];if(arguments.length>1?t=Array.prototype.slice.call(arguments):arguments[0]instanceof Array&&(t=arguments[0]),!t)return e.apply(null,arguments);for(var i=0,s=t.shift();s.length>i;i++)return t.unshift(s[i]),n.push(e.apply(null,t)),t.shift(),n}},i="optional not ignore cache".split(/\s/),s=0;i.length>s;s++)t[i[s]]=n(t[i[s]]);for(var o=function(e){return function(){return arguments[0]instanceof Array?e.apply(null,arguments[0]):e.apply(null,arguments)}},a="each any all".split(/\s/),l=0;a.length>l;l++)t[a[l]]=o(t[a[l]])}(),function(){var e=function(t){for(var n=[],i=0;t.length>i;i++)t[i]instanceof Array?n=n.concat(e(t[i])):t[i]&&n.push(t[i]);return n};Date.Grammar={},Date.Translator={hour:function(e){return function(){this.hour=Number(e)}},minute:function(e){return function(){this.minute=Number(e)}},second:function(e){return function(){this.second=Number(e)}},meridian:function(e){return function(){this.meridian=e.slice(0,1).toLowerCase()}},timezone:function(e){return function(){var t=e.replace(/[^\d\+\-]/g,"");t.length?this.timezoneOffset=Number(t):this.timezone=e.toLowerCase()}},day:function(e){var t=e[0];return function(){this.day=Number(t.match(/\d+/)[0])}},month:function(e){return function(){this.month=3==e.length?Date.getMonthNumberFromName(e):Number(e)-1}},year:function(e){return function(){var t=Number(e);this.year=e.length>2?t:t+(Date.CultureInfo.twoDigitYearMax>t+2e3?2e3:1900)}},rday:function(e){return function(){switch(e){case"yesterday":this.days=-1;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0,this.now=!0}}},finishExact:function(e){e=e instanceof Array?e:[e];var t=new Date;this.year=t.getFullYear(),this.month=t.getMonth(),this.day=1,this.hour=0,this.minute=0,this.second=0;for(var n=0;e.length>n;n++)e[n]&&e[n].call(this);if(this.hour="p"==this.meridian&&13>this.hour?this.hour+12:this.hour,this.day>Date.getDaysInMonth(this.year,this.month))throw new RangeError(this.day+" is not a valid value for days.");var i=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second);return this.timezone?i.set({timezone:this.timezone}):this.timezoneOffset&&i.set({timezoneOffset:this.timezoneOffset}),i},finish:function(t){if(t=t instanceof Array?e(t):[t],0===t.length)return null;for(var n=0;t.length>n;n++)"function"==typeof t[n]&&t[n].call(this);if(this.now)return new Date;var i=Date.today(),s=!(null==this.days&&!this.orient&&!this.operator);if(s){var o,r,a;return a="past"==this.orient||"subtract"==this.operator?-1:1,this.weekday&&(this.unit="day",o=Date.getDayNumberFromName(this.weekday)-i.getDay(),r=7,this.days=o?(o+a*r)%r:a*r),this.month&&(this.unit="month",o=this.month-i.getMonth(),r=12,this.months=o?(o+a*r)%r:a*r,this.month=null),this.unit||(this.unit="day"),(null==this[this.unit+"s"]||null!=this.operator)&&(this.value||(this.value=1),"week"==this.unit&&(this.unit="day",this.value=7*this.value),this[this.unit+"s"]=this.value*a),i.add(this)}return this.meridian&&this.hour&&(this.hour=13>this.hour&&"p"==this.meridian?this.hour+12:this.hour),this.weekday&&!this.day&&(this.day=i.addDays(Date.getDayNumberFromName(this.weekday)-i.getDay()).getDate()),this.month&&!this.day&&(this.day=1),i.set(this)}};var t,n=Date.Parsing.Operators,i=Date.Grammar,s=Date.Translator;i.datePartDelimiter=n.rtoken(/^([\s\-\.\,\/\x27]+)/),i.timePartDelimiter=n.stoken(":"),i.whiteSpace=n.rtoken(/^\s*/),i.generalDelimiter=n.rtoken(/^(([\s\,]|at|on)+)/);var o={};i.ctoken=function(e){var t=o[e];if(!t){for(var i=Date.CultureInfo.regexPatterns,s=e.split(/\s+/),r=[],a=0;s.length>a;a++)r.push(n.replace(n.rtoken(i[s[a]]),s[a]));t=o[e]=n.any.apply(null,r)}return t},i.ctoken2=function(e){return n.rtoken(Date.CultureInfo.regexPatterns[e])},i.h=n.cache(n.process(n.rtoken(/^(0[0-9]|1[0-2]|[1-9])/),s.hour)),i.hh=n.cache(n.process(n.rtoken(/^(0[0-9]|1[0-2])/),s.hour)),i.H=n.cache(n.process(n.rtoken(/^([0-1][0-9]|2[0-3]|[0-9])/),s.hour)),i.HH=n.cache(n.process(n.rtoken(/^([0-1][0-9]|2[0-3])/),s.hour)),i.m=n.cache(n.process(n.rtoken(/^([0-5][0-9]|[0-9])/),s.minute)),i.mm=n.cache(n.process(n.rtoken(/^[0-5][0-9]/),s.minute)),i.s=n.cache(n.process(n.rtoken(/^([0-5][0-9]|[0-9])/),s.second)),i.ss=n.cache(n.process(n.rtoken(/^[0-5][0-9]/),s.second)),i.hms=n.cache(n.sequence([i.H,i.mm,i.ss],i.timePartDelimiter)),i.t=n.cache(n.process(i.ctoken2("shortMeridian"),s.meridian)),i.tt=n.cache(n.process(i.ctoken2("longMeridian"),s.meridian)),i.z=n.cache(n.process(n.rtoken(/^(\+|\-)?\s*\d\d\d\d?/),s.timezone)),i.zz=n.cache(n.process(n.rtoken(/^(\+|\-)\s*\d\d\d\d/),s.timezone)),i.zzz=n.cache(n.process(i.ctoken2("timezone"),s.timezone)),i.timeSuffix=n.each(n.ignore(i.whiteSpace),n.set([i.tt,i.zzz])),i.time=n.each(n.optional(n.ignore(n.stoken("T"))),i.hms,i.timeSuffix),i.d=n.cache(n.process(n.each(n.rtoken(/^([0-2]\d|3[0-1]|\d)/),n.optional(i.ctoken2("ordinalSuffix"))),s.day)),i.dd=n.cache(n.process(n.each(n.rtoken(/^([0-2]\d|3[0-1])/),n.optional(i.ctoken2("ordinalSuffix"))),s.day)),i.ddd=i.dddd=n.cache(n.process(i.ctoken("sun mon tue wed thu fri sat"),function(e){return function(){this.weekday=e}})),i.M=n.cache(n.process(n.rtoken(/^(1[0-2]|0\d|\d)/),s.month)),i.MM=n.cache(n.process(n.rtoken(/^(1[0-2]|0\d)/),s.month)),i.MMM=i.MMMM=n.cache(n.process(i.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),s.month)),i.y=n.cache(n.process(n.rtoken(/^(\d\d?)/),s.year)),i.yy=n.cache(n.process(n.rtoken(/^(\d\d)/),s.year)),i.yyy=n.cache(n.process(n.rtoken(/^(\d\d?\d?\d?)/),s.year)),i.yyyy=n.cache(n.process(n.rtoken(/^(\d\d\d\d)/),s.year)),t=function(){return n.each(n.any.apply(null,arguments),n.not(i.ctoken2("timeContext")))},i.day=t(i.d,i.dd),i.month=t(i.M,i.MMM),i.year=t(i.yyyy,i.yy),i.orientation=n.process(i.ctoken("past future"),function(e){return function(){this.orient=e}}),i.operator=n.process(i.ctoken("add subtract"),function(e){return function(){this.operator=e}}),i.rday=n.process(i.ctoken("yesterday tomorrow today now"),s.rday),i.unit=n.process(i.ctoken("minute hour day week month year"),function(e){return function(){this.unit=e}}),i.value=n.process(n.rtoken(/^\d\d?(st|nd|rd|th)?/),function(e){return function(){this.value=e.replace(/\D/g,"")}}),i.expression=n.set([i.rday,i.operator,i.value,i.unit,i.orientation,i.ddd,i.MMM]),t=function(){return n.set(arguments,i.datePartDelimiter)},i.mdy=t(i.ddd,i.month,i.day,i.year),i.ymd=t(i.ddd,i.year,i.month,i.day),i.dmy=t(i.ddd,i.day,i.month,i.year),i.date=function(e){return(i[Date.CultureInfo.dateElementOrder]||i.mdy).call(this,e)},i.format=n.process(n.many(n.any(n.process(n.rtoken(/^(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(e){if(i[e])return i[e];throw Date.Parsing.Exception(e)}),n.process(n.rtoken(/^[^dMyhHmstz]+/),function(e){return n.ignore(n.stoken(e))}))),function(e){return n.process(n.each.apply(null,e),s.finishExact)});var r={},a=function(e){return r[e]=r[e]||i.format(e)[0]};i.formats=function(e){if(e instanceof Array){for(var t=[],i=0;e.length>i;i++)t.push(a(e[i]));return n.any.apply(null,t)}return a(e)},i._formats=i.formats(["yyyy-MM-ddTHH:mm:ss","ddd, MMM dd, yyyy H:mm:ss tt","ddd MMM d yyyy HH:mm:ss zzz","d"]),i._start=n.process(n.set([i.date,i.time,i.expression],i.generalDelimiter,i.whiteSpace),s.finish),i.start=function(e){try{var t=i._formats.call({},e);if(0===t[1].length)return t}catch(n){}return i._start.call({},e)}}(),Date._parse=Date.parse,Date.parse=function(e){var t=null;if(!e)return null;try{t=Date.Grammar.start.call({},e)}catch(n){return null}return 0===t[1].length?t[0]:null},Date.getParseFunction=function(e){var t=Date.Grammar.formats(e);return function(e){var n=null;try{n=t.call({},e)}catch(i){return null}return 0===n[1].length?n[0]:null}},Date.parseExact=function(e,t){return Date.getParseFunction(t)(e)};var Contact=Spine.Model.setup("Contact",["id","user_id","name","photo_url","affiliation","online","jid","avatar"]);Contact.include({setAvatar:function(){this.avatar||(this.avatar=$('<img src="'+this.photo_url+'" class="avatar icon little-rounded avatar_shadow"/>').html())}}),Contact.extend({base_url:"http://localhost:3000/branches/all",get:function(e,t,n,i){$.ajax({type:"GET",url:e,contentType:"application/json",data:i,success:t,error:n})},fakeItem:function(){return[{name:"paul",photo_url:"/assets/image_7.jpg",role:"admin",affiliation:"admin",online:{status:"available"},user_id:"1"},{name:"James",photo_url:"/assets/image_1.jpg",role:"admin",affiliation:"admin",online:{status:"available"},user_id:"2"},{name:"Crisp Grazia",photo_url:"/assets/image_2.jpg",role:"admin",affiliation:"admin",online:{status:"available"},user_id:"3"},{name:"Adebanjo Grace",photo_url:"/assets/image_4.jpg",role:"admin",affiliation:"admin",online:{status:"available"},user_id:"4"},{name:"Ishola Babatunde",photo_url:"/assets/image_5.jpg",role:"admin",affiliation:"admin",online:{status:"available"},user_id:"5"},{name:"Adebayo Boyega",photo_url:"/assets/image_6.jpg",role:"admin",affiliation:"admin",online:{status:"available"},user_id:"6"},{name:"Augustine Ndule",photo_url:"/assets/image_8.jpg",role:"admin",affiliation:"member",online:{status:"available"},user_id:"7"},{name:"Onyemaechi Okafor",photo_url:"/assets/image_9.jpg",role:"admin",affiliation:"member",online:{status:"available"},user_id:"8"},{name:"Chuba Okanumee",photo_url:"/assets/image_10.jpg",role:"admin",affiliation:"member",online:{status:"available"},user_id:"9"},{name:"Nnamdi Nwobgodo",photo_url:"/assets/avatar.jpg",role:"admin",affiliation:"member",online:{status:"available"},user_id:"10"}]}});var Chat=Spine.Model.setup("Chat",["id","user_id","thread_id","created_at","created_by_local_user","online","last_shown_time","contact"]),Conversation=Spine.Model.setup("Conversation",["id","user","messages","user_id","last_shown_time","current_state","notification_counter","initiated_by_local_user","last_active_time","notification","last_activity_time","last_active_formatted_time","last_active_formatted_date","avatar","visible"]);Conversation.include({touch:function(){this.last_active_time=new Date,this.last_active_formatted_time=this.last_active_time.toString("hh:mm tt"),this.last_active_formatted_date=this.last_active_time.toString("d-MMM-yyyy"),this.save()},touchShow:function(){this.last_shown_time=new Date,this.save()},onShow:function(){this.notification_counter=0,console.log("onshow",this.unread),this.visible=!0,this.touch()},onHide:function(){this.notification_counter=0,this.visible=!1,console.log("onhide",this.unread),this.touch()},onMessage:function(e){this.messages.push(e);var t={content:e.body,type:e.type,date:Date.now()};this.notify(t),this.touch()},notify:function(e){this.notification=e,this.notification_counter||(this.notification_counter=0),0==this.visible?this.notification_counter++:this.notification_counter=0},assertUser:function(){try{return this.user||(this.user=Contact.findByAttribute("user_id",this.user_id)),this.user}catch(e){}}});var Call=Spine.Model.setup("Call",["id","sid","token","initiated_by_local_user","callee_id","caller_id","conversation_id","state","ot_session"]);Call.include({getCaller:function(){try{if(!this.caller)return this.caller=Call.findByAttribute("caller_id",this.caller_id)}catch(e){}},getCallee:function(){try{if(!this.callee)return this.callee=Call.findByAttribute("callee_id",this.callee_id)}catch(e){}}}),Call.extend({STATE:{OFFER:100,ANSWER:200,INACTIVE:300,ACTIVE:400}});var Message=Spine.Model.setup("Message",["id","type","conversation_id","body","from","from_id","to_id","to","html","subject","thread","date","formatted_time"]);Message.include({assertFrom:function(){try{if(!this.from)return this.from=Contact.findByAttribute("user_id",this.from_id)}catch(e){}},touch:function(){this.date=new Date,this.save()}}),ConversationRequest=Spine.Model.setup("ConversationRequest",["id","message","from","to","thread","viewed"]),ConversationRequest.extend({fakeItem:function(){return[{from:{name:"paul",photo_url:"/assets/image_7.jpg",role:"admin",online:{status:"available"},user_id:"1"},message:"The idea behind this one is to give a very little and subtle shadow"},{from:{name:"James",photo_url:"/assets/image_1.jpg",role:"admin",online:{status:"available"},user_id:"2"},message:"The idea behind this one is to give a very little and subtle shadow"},{from:{name:"Crisp Grazia",photo_url:"/assets/image_2.jpg",role:"admin",online:{status:"available"},user_id:"3"},message:"The idea behind this one is to give a very little and subtle shadow"},{from:{name:"Adebanjo Grace",photo_url:"/assets/image_4.jpg",role:"admin",online:{status:"available"},user_id:"4"},message:"The idea behind this one is to give a very little and subtle shadow"},{from:{name:"Ishola Babatunde",photo_url:"/assets/image_5.jpg",role:"admin",online:{status:"available"},user_id:"5"},message:"The idea behind this one is to give a very little and subtle shadow"}]}}),Message.extend({MESSAGE_TYPE:{GROUP_CHAT:"groupchat",CHAT:"chat"},fakeItem:function(){return[{from_id:"1",body:"The idea behind this one is to give a very little and subtle shadow",html:"The idea behind this one is to give a very little and subtle shadow",subject:"",type:"video",date:new Date},{from_id:"2",body:"The idea behind this one is to give a very little and subtle shadow",html:"The idea behind this one is to give a very little and subtle shadow",subject:"",type:"chat",date:new Date},{from_id:"3",body:"The idea behind this one is to give a very little and subtle shadow",html:"The idea behind this one is to give a very little and subtle shadow",subject:"",type:"video",date:new Date},{from_id:"4",body:"The idea behind this one is to give a very little and subtle shadow",html:"The idea behind this one is to give a very little and subtle shadow",subject:"",type:"chat",date:new Date},{from_id:"5",body:"The idea behind this one is to give a very little and subtle shadow",html:"The idea behind this one is to give a very little and subtle shadow",subject:"",type:"video",date:new Date},{from_id:"6",body:"The idea behind this one is to give a very little and subtle shadow",html:"The idea behind this one is to give a very little and subtle shadow",subject:"",type:"chat",date:new Date}]}}),jQuery(function(e){window.TabController=Spine.Controller.create({elements:{".tab-body":"tabBody",".nav.tabs":"tabsNav",".nav.tabs li":"handlers"},proxied:["keydown","selectTabFromHash","popState"],tabIDprefix:"tab-",init:function(){this.handlers.each(this.proxy(function(t,n){console.log("item",e(n).find("a")),e(n).attr("role","tab").attr("id",this.tabIDprefix+e(n).find("a").attr("href").split("#")[1])})),this.tabsNav.find("a").attr("tabindex","-1"),this.tabsNav.find("a").click(this.proxy(this.click)),this.tabBody.find(">div").each(this.proxy(function(t,n){e(n).addClass("tab-pane").attr("role","tabpanel").attr("aria-hidden",!0).attr("aria-labelledby",this.tabIDprefix+e(n).attr("id"))})),this.tabsNav.find("a").keydown(this.keydown),this.tabsNav.find("a:first").click()},selectTab:function(t){this.tabsNav.find("li."+this.options.activeTabClass).removeClass(this.options.activeTabClass).find("a").attr("tabindex","-1"),t.attr("tabindex","0").parent().addClass(this.options.activeTabClass),this.tabBody.find(">div."+this.options.activePanelClass).attr("aria-hidden",!0).removeClass(this.options.activePanelClass),e(t.attr("href")).addClass(this.options.activePanelClass).attr("aria-hidden",!1),this.App.trigger(t.attr("data-action"))},click:function(t){return this.selectTab(e(t.currentTarget)),!1},keydown:function(t){var n=e(t.target).parent();switch(t.keyCode){case 37:case 38:n.prev().size()>0&&this.selectTab(n.prev().find("a"));break;case 39:case 40:n.next().size()>0&&this.selectTab(n.next().find("a"));break;case 36:this.selectTab(this.tabsNav.find("li:first a"));break;case 35:this.selectTab(this.tabsNav.find("li:last a"))}},saveState:function(e){history.pushState&&history.pushState(e.attr("href"),"","")},popState:function(e){e.state&&this.selectTabFromHash(e.state)},selectTabFromHash:function(e){var t=e||window.location.hash,n=this.tabsNav.find("a[href=#"+t.replace("#","")+"]");return n.size()>0?this.selectTab(n,!0):this.selectTab(this.tabsNav.find("a:first"),!0),!!n.size()}})}),jQuery(function(e){window.Chats=Spine.Controller.create({elements:{".items":"itemsEl",".items .item":"handler"},events:{"click .items li":"doAction"},proxied:["render","addOne","show","addAll","desc","updateUI","onError","refresh","scroll","onCreate"],init:function(){Conversation.bind("create",this.onCreate),e(document).on("resize",this.render),this.App.bind("chat:updateUI",this.updateUI),this.App.bind("chats:show",this.show),this.prefetched=!1,this.jsp=e(this.el).addScrollExtension(),this.contentPane=this.el.find(".jspPane"),this.conversations=[],this.chatControllers={}},onCreate:function(e){this.conversations.push(e),this.conversations.sort(this.desc)},addOne:function(e){console.log("conversation",e);try{if(this.contentPane.length>0){var t=this.jsp.getContentPane();this.itemsEl=t.find("ul.items");var n=this.getChatController(e);return n||(n=this.createController(e)),this.itemsEl.append(n.render().el),this.jsp.reinitialise(),this.jsp.addHoverFunc(),void 0}var n=this.getChatController(e);return n||(n=this.createController(e)),this.itemsEl.append(n.render().el),void 0}catch(i){console.log(i)
}},show:function(){this.render()},updateUI:function(){this.jsp&&(this.jsp.reinitialise(),this.jsp.addHoverFunc()),console.log("updated messageAlertUI")},emptyList:function(){this.contentPane=this.el.find(".jspPane"),this.contentPane.length>0?this.contentPane.empty():this.el.empty()},template:function(){},render:function(){this.itemsEl.empty(),this.conversations=Conversation.all(),console.log("latest_messages",this.conversations),this.conversations.length>0&&(this.conversations.sort(this.desc),this.addAll(this.conversations))},showProgress:function(t){this.hideProgress(),this.progress=e("#chat-load-tmpl").tmpl(t),this.progress.appendTo(this.el)},showError:function(t){this.hideError(),this.errorMessage=e("#chat-error-alert-tmpl").tmpl(t),this.errorMessage.appendTo(this.el)},hideError:function(){this.errorMessage&&this.errorMessage.remove()},addAll:function(t){e.each(t,this.proxy(function(e){this.addOne(t[e])}))},desc:function(e,t){return e.last_active_time>t.last_active_time?-1:e.last_active_time<t.last_active_time?1:0},onError:function(e){console.log("error",e),this.hideProgress(),this.hideLoadProgress(),this.prefetching=!1},doAction:function(t){this.currentAnchor=e(t.currentTarget),this.current=e(t.currentTarget).closest("li");var n=this.current.data("action"),i=Conversation.find(this.currentAnchor.attr("id"));return console.log("action",n),this.App.trigger(n,i),!1},getChatController:function(e){return this.chatControllers[e.id]},createController:function(e){var t=ChatItemController.init({item:e});return this.chatControllers[e.id]=t,t},getConversation:function(e,t){var n=Conversation.findByAttribute("user_id",e);return n?n:n=Conversation.create({user_id:e,messages:[],last_shown_time:new Date,initiated_by_local_user:t,visible:!1})}})}),jQuery(function(e){window.ChatItemController=Spine.Controller.create({proxied:["remove","render","update"],template:function(t){return e("#chat-item-tmpl").tmpl(t)},templateInfoBody:function(t){return e("#chat-info-tmpl").tmpl(t)},templateIndicator:function(t){return e("#indicator-tmpl").tmpl(t)},init:function(){this.item.bind("update",this.update),this.item.bind("destroy",this.remove),this.cached=!1},update:function(e){this.items.id==e.id&&(this.item=e,this.item.notification&&(this.setDateTime(this.item),this.infoBodyEl=this.el.find(".info-body"),this.infoBodyEl.html(this.templateInfoBody(this.item)),this.indicatorEl=this.infoBodyEl.find(".indicator"),this.indicatorEl.html(this.templateIndicator(this.item))))},render:function(e){if(e&&(this.item=e),!this.cached){var t=this.template(this.item);this.el.replaceWith(t),this.el=t,this.setDateTime(this.item),this.infoBodyEl=this.el.find(".info-body"),this.infoBodyEl.html(this.templateInfoBody(this.item)),this.indicatorEl=this.infoBodyEl.find(".indicator"),this.indicatorEl.html(this.templateIndicator(this.item)),this.cached=!0}return this},remove:function(){this.el.remove()},setDateTime:function(e){console.log("data to set time",e),e.notification.formattedTime=e.notification.date.toString("hh:mm tt"),e.notification.formattedDate=e.notification.date.toString("d-MMM-yyyy")}})}),jQuery(function(e){window.Contacts=Spine.Controller.create({elements:{".items":"itemsEl",".items .item":"handler",".progress":"progress",".load":"load",".tree":"tree",".tree .admins":"adminsEl",".tree .members":"membersEl",".tree li .toggle-admin":"toggleAdmin"},events:{"click .alert-container .alert .close":"hideError","click .items li":"doAction","toggle a.tree-parent":"updateUI"},proxied:["render","addOne","show","addAll","updateUI","prefetchComplete","onError","refresh","scroll","onCreate"],init:function(){Contact.bind("create",this.onCreate),e(document).on("resize",this.render),this.App.bind("chat:updateUI",this.updateUI),this.prefetched=!1,console.log("connection",this.App.connection),this.jsp=e(this.el).addScrollExtension(),this.contentPane=this.el.find(".jspPane"),this.contacts=[],this.contactControllers={}},onCreate:function(e){e.setAvatar(),this.contacts.push(e),this.addOne(e)},addOne:function(e){console.log("contact",e);try{if(this.contentPane.length>0){var t=this.jsp.getContentPane();this.itemsEl=t.find("ul.items");var n=this.getContactController(e);return n||(n=this.createController(e)),this.itemsEl.append(n.render().el),this.jsp.reinitialise(),this.jsp.addHoverFunc(),void 0}var n=this.getContactController(e);return n||(n=this.createController(e)),this.itemsEl.append(n.render().el),void 0}catch(i){console.log(i)}},show:function(){console.log("render"),this.prefetched||this.render()},updateUI:function(){this.jsp&&(this.jsp.reinitialise(),this.jsp.addHoverFunc()),console.log("updated contactUI")},template:function(){return e("#chat-tree-tmpl").tmpl()},emptyList:function(){this.contentPane=this.el.find(".jspPane"),this.contentPane.length>0?this.contentPane.empty():this.el.empty()},template:function(){},render:function(){this.itemsEl.empty(),this.contacts.length>0?this.addAll(this.contacts):(this.contacts=Contact.all(),this.contacts.length>0&&this.addAll(this.contacts))},test:function(){var t=Contact.fakeItem();e.each(t,this.proxy(function(e){Contact.create(t[e])}))},hideProgress:function(){this.progress&&this.progress.remove()},showProgress:function(t){this.hideProgress(),this.progress=e("#chat-load-tmpl").tmpl(t),this.progress.appendTo(this.el)},showError:function(t){this.hideError(),this.errorMessage=e("#chat-error-alert-tmpl").tmpl(t),this.errorMessage.appendTo(this.el)},hideError:function(){this.errorMessage&&this.errorMessage.remove()},loadMore:function(){this.prefetching||this.prefetch()},addAll:function(t){e.each(t,this.proxy(function(e){this.addOne(t[e])}))},doAction:function(t){return this.currentAnchor=e(t.currentTarget),this.current=e(t.currentTarget).closest("li"),action=this.current.data("action"),contact=Contact.find(this.currentAnchor.attr("id")),console.log(action,contact),this.App.trigger(action,contact,{show:!0,created_by_local_user:!1}),!1},getContactController:function(e){return this.contactControllers[e.id]},createController:function(e){var t=ContactItemController.init({item:e});return this.contactControllers[e.id]=t,t}})}),jQuery(function(e){window.ContactItemController=Spine.Controller.create({proxied:["remove","render","update"],template:function(t){return e("#contact-item-tmpl").tmpl(t)},init:function(){this.item.bind("update",this.update),this.item.bind("destroy",this.remove),this.cached=!1},update:function(){this.render()},render:function(e){if(!this.cached){e&&(this.item=e);var t=this.template(this.item);this.el.replaceWith(t),this.el=t,this.cached=!0}return this},remove:function(){this.el.remove()}})}),jQuery(function(e){window.ConferenceController=Spine.Controller.create({elements:{".header":"header",".content":"content",".footer":"footer",".chat-message-view":"chatMessageView",".footer .chat-input input":"input",".items":"itemsEl",".items .item":"handler"},events:{"click .send":"send","keydown .footer .chat-input input":"checkCreateMessage"},proxied:["render","addOne","show","addAll","updateUI","prefetchComplete","onError","refresh","scroll","onNewMessage","onMessage","updateUI"],init:function(){this.App.connection.addHandler(this.onMessage,null,"message","groupchat"),Message.bind("create",this.onNewMessage),this.App.bind("chat:updateUI",this.updateUI),this.App.bind("message:group:new",this.onNewMessage),e(document).on("resize",this.render),this.prefetched=!1,this.messages=[],this.messageControllers={},this.updateUI()},onNewMessage:function(e){e.type==Message.MESSAGE_TYPE.GROUP_CHAT&&(e.assertFrom(),!this.App.isCurrentUser(e.from),this.addOne(e))},addOne:function(e){this.checkMessage(e)&&(this.messages.push(e),this.scroll(function(){var t=this.getMessageController(e);t||(t=this.createController(e)),this.itemsEl.append(t.render().el)}),console.log("this.itemsEl",this.itemsEl))},show:function(){this.render()},template:function(){},render:function(){this.itemsEl.empty(),this.messages.length>0&&this.addAll(this.messages)},addAll:function(t){e.each(t,this.proxy(function(e){this.addOne(t[e])}))},checkMessage:function(e){return e.type==Message.MESSAGE_TYPE.GROUP_CHAT?!0:!1},onMessage:function(t){console.log("received group",t);var n=e(t).attr("from"),i=Strophe.getNodeFromJid(n);if(console.log("branch_id",i),console.log("this.App.branch.id",this.App.branch==i),i==this.App.branch.id){var s=Strophe.getResourceFromJid(n);console.log("user_id",s);var o=e(t).children("body"),t=Message.create({from_id:s,to_id:this.App.user.user_id,to:this.App.user,body:o.text(),html:null,type:Message.MESSAGE_TYPE.GROUP_CHAT,date:new Date})}return e("#chatAudio")[0].play(),!0},checkCreateMessage:function(e){return 13!=e.which||e.shiftKey?void 0:(this.createMessage(),!1)},send:function(){this.createMessage()},createMessage:function(){var e=this.input.val().trim();if(!e)return!1;var t=Message.create({from_id:this.App.user.user_id,from:this.App.user,to_id:this.App.branch.id,body:e,html:null,type:Message.MESSAGE_TYPE.GROUP_CHAT,date:new Date});this.input.val(""),this.scroll(),this.sendMessage(t)},sendMessage:function(e){this.App.connection.send($msg({to:this.App.BRANCH_JID,type:"groupchat"}).c("body").t(e.body)),console.log("sendMessage",e)},doAction:function(t){this.currentAnchor=e(t.currentTarget),this.current=e(t.currentTarget).closest("li");var n=this.current.data("action");console.log("action",n);var i=Message.find(this.currentAnchor.attr("id"));return this.App.trigger(n,i,this.current),!1},isScrolledToBottom:function(){var e=this.chatMessageView[0].scrollHeight-this.chatMessageView.scrollTop()-this.chatMessageView.outerHeight();return 0==e},scrollToBottom:function(){this.chatMessageView.animate({scrollTop:this.chatMessageView[0].scrollHeight},"slow")},scroll:function(e){var t=this.isScrolledToBottom();console.log("shouldScroll",t),e&&e.apply(this),t&&this.scrollToBottom()},getMessageController:function(e){return this.messageControllers[e.id]},createController:function(e){var t=ChatMessageItemController.init({item:e});return this.messageControllers[e.id]=t,t},activate:function(){console.log("activating...Group Conversation"),this.scrollToBottom()},deActivate:function(){console.log("de-activating...Group Conversation")},updateUI:function(){console.log("updateConversationItemUI"),this.headerH=this.header.outerHeight(),this.footerH=this.footer.outerHeight();var e=this.el.parent().height(),t=this.headerH+1;this.contentH=e-t-this.footerH,console.log("updateConversationItemUI",e),this.content.css({height:this.contentH+"px","padding-top":t+"px","padding-bottom":this.footerH+"px"}),this.chatMessageView.css({height:this.contentH+"px"})}})}),jQuery(function(e){window.ChatMessages=Spine.Controller.create({elements:{".items":"itemsEl",".items .item":"handler"},events:{"click .items li":"doAction"},proxied:["render","addOne","show","addAll","updateUI","prefetchComplete","onError","refresh","scroll","onNewMessage"],init:function(){this.App.bind("message:chat:new",this.onNewMessage),Message.bind("create",this.onNewMessage),e(document).on("resize",this.render),this.prefetched=!1,this.messages=[],this.messageControllers={}},onNewMessage:function(e){e.type==Message.MESSAGE_TYPE.CHAT&&(e.assertFrom(),this.App.isCurrentUser(e.from)||this.conversation.onMessage(e),this.addOne(e))},addOne:function(e){this.checkMessage(e)&&(this.messages.push(e),this.scroll(function(){var t=this.getMessageController(e);t||(t=this.createController(e)),this.itemsEl.append(t.render().el)}),console.log("this.itemsEl",this.itemsEl))},show:function(){console.log("showChatMessages"),this.render()},updateUI:function(){console.log("update chatui"),this.scrollToBottom()},template:function(){},render:function(){},addAll:function(t){e.each(t,this.proxy(function(e){this.addOne(t[e])}))},checkMessage:function(e){return e.type==Message.MESSAGE_TYPE.CHAT?this.conversation.id==e.conversation_id:!1},doAction:function(t){this.currentAnchor=e(t.currentTarget),this.current=e(t.currentTarget).closest("li");var n=this.current.data("action");return console.log("action",n),!1},isScrolledToBottom:function(){var e=this.el[0].scrollHeight-this.el.scrollTop()-this.el.outerHeight();return 0==e},scrollToBottom:function(){this.el.scrollTop(this.el[0].scrollHeight)},scroll:function(e){var t=this.isScrolledToBottom();console.log("shouldScroll",t),e&&e.apply(this),t&&this.scrollToBottom()},getMessageController:function(e){return this.messageControllers[e.id]},createController:function(e){var t=ChatMessageItemController.init({item:e});return this.messageControllers[e.id]=t,t}})}),jQuery(function(e){window.ChatMessageItemController=Spine.Controller.create({proxied:["remove","render","update"],template:function(t){return t.isCurrentUser=this.App.isCurrentUser(t.from)?!0:!1,t.formattedTime=t.date.toString("hh:mm tt"),t.formattedDate=t.date.toString("d-MMM-yyyy"),console.log("render",t),e("#chat-message-tmpl").tmpl(t)},init:function(){this.item.bind("update",this.update),this.item.bind("destroy",this.remove)},update:function(){this.render()},render:function(e){e&&(this.item=e);var t=this.template(this.item);return this.el.replaceWith(t),this.el=t,this},remove:function(){this.el.remove()}})}),jQuery(function(e){window.ChatVideoController=Spine.Controller.create({elements:{".call":"call",".local":"localWrap",".localVideo":"localVideo",".remote":"remoteWrap",".remote video":"remoteVideoEl",".remote .mini":"miniWrap",".remote .mini video":"miniVideo",".video-call-view":"videoCallView",".video-call-state":"callViewStates",".video-call-state.invite":"callInviteView",".video-call-state.offer":"callOfferView",".video-call-state.answer":"callAnswerView",".video-call-state.live":"callLiveView",".video-status-bar .message":"statusMessageEl",".video-status-bar .error_container":"errorContainer",".accept":"acceptBtn",".reject":"rejectBtn",".cancel":"cancelBtn"},events:{"click .call":"startVideoCall","click .accept":"acceptCall","click .reject":"rejectCall","click .cancel":"cancelCall","click .hang-up":"hangUp"},proxied:["render","onUserMediaSuccess","streamCreatedHandler","sessionConnectedHandler","streamDestroyedHandler","onCallInit","onCallInitUpError","exceptionHandler","onNewCall","onAccept","onReject","onTerminate"],template:function(t){return t.isCurrentUser=this.App.isCurrentUser(t.from)?!0:!1,console.log("render",t),e("#chat-message-tmpl").tmpl(t)},init:function(){this.isVideoMuted=!1,this.isAudioMuted=!1,this.initiator=!1,this.started=!1,this.UNINITIALIZED=0,this.INITIALIZING=1,this.INITIALIZED=2,this.CONNECTING=3,this.CONNECTED=4,this.state=this.UNINITIALIZED,this.App.bind("call:new",this.onNewCall),this.App.bind("call:accept",this.onAccept),this.App.bind("call:reject",this.onReject),this.App.bind("call:terminate",this.onTerminate),TB.addEventListener("exception",this.exceptionHandler)},activate:function(){console.log("activate conversation for ",this.conversation),this.el.addClass("active"),this.conversation.call||this.showInvite()},shouldShow:function(){var e=!1;return e=this.conversation.call?!0:!1},startVideoCall:function(){this.initiator=!0,this.doInitialize()},doInitialize:function(){this.state=this.INITIALIZING,this.setStatus(e("#_status-tmp").tmpl({message:"Please wait..."})),this.App.connection.sendIQ($iq({to:this.App.BRANCH_JID,type:"set"}).c("call-init",{xmlns:this.App.NS_CALL_SETUP,caller_id:this.App.user.user_id,callee_id:this.conversation.user_id}),this.proxy(function(t){var n=e(t).children("call-setup");this.sid=n.attr("sid"),this.token=n.attr("token"),this.doOffer(),console.log("sid",this.sid),console.log("token",this.token)}),this.proxy(function(){this.reset(),this.showError("failed to initialize stream")}))},testCallSetup:function(){this.sid="9999999";var e="ubjgjbjgbkgkbkgkbkg";this.opentokSession=TB.initSession(this.sid),console.log("test session",this.opentokSession),this.opentokSession.connect(this.App.OPENTOK_API_KEY,e)},initTB:function(e,t){this.state=this.CONNECTING,this.opentokSession=TB.initSession(e),this.opentokSession=TB.initSession(e),this.opentokSession.addEventListener("sessionConnected",this.sessionConnectedHandler),this.opentokSession.addEventListener("streamCreated",this.streamCreatedHandler),this.opentokSession.addEventListener("streamDestroyed",this.streamDestroyedHandler),this.opentokSession.connect(this.App.OPENTOK_API_KEY,t)},doOffer:function(){this.conversation.call=Call.init({sid:this.sid,token:this.token,initiated_by_local_user:!0,callee_id:this.conversation.user_id,ot_session:this.opentokSession,state:Call.STATE.OFFER,conversation_id:this.conversation.id})},onNewCall:function(e){if(console.log("new-call",e),this.el.hasClass("active")||this.conversationController.showVideo(),this.state=this.INITIALIZING,e.caller_id===this.conversation.user_id){this.conversation.call=e;var t=Message.create({from_id:this.conversation.user_id,from:this.conversation.user,to_id:this.App.user.user_id,conversation_id:this.conversation.id,to:this.App.user,body:"new video call",html:null,type:"video",date:new Date});this.conversation.onMessage(t),this.App.trigger("chats:show"),console.log("onNewCall",this.conversation),this.sid=e.sid,this.token=e.token,this.videoCallView.hide(),this.showAnswer()}},showInvite:function(){this.setStatus(e("#invite-tmpl").tmpl())},showAnswer:function(){this.setStatus(e("#answer-tmpl").tmpl())},showOffer:function(){this.callViewStates.hide(),this.callOfferView.show()},showLive:function(){this.videoCallView.html(e("#live-tmpl").tmpl())},showError:function(t){var n=e("#error-tmpl").tmpl({message:t});this.errorContainer.html(n)},acceptCall:function(){this.setStatus(e("#_status-tmp").tmpl({message:"Please wait..."})),this.App.connection.sendIQ($iq({to:this.App.BRANCH_JID,type:"set"}).c("call-accept",{xmlns:this.App.NS_CALL_SETUP,sid:this.sid}),this.proxy(function(){console.log("onAccept",this.App.user.id),this.state=this.INITIALIZED,this.initTB(this.sid,this.token),this.showLive()}),this.proxy(function(e){console.log("accept error",e),this.reset(),this.showError("failed to initialize stream")})),console.log("acceptCall")},rejectCall:function(){this.setStatus("Rejecting..."),this.App.connection.sendIQ($iq({to:this.App.BRANCH_JID,type:"set"}).c("call-reject",{xmlns:this.App.NS_CALL_SETUP,sid:this.sid}),this.proxy(function(){this.reset()}),this.proxy(function(e){console.log("error reject",e),this.reset()}))},cancelCall:function(){console.log("cancelCall"),this.el.find(".cancel").button("loading"),this.terminateCall()},terminateCall:function(){this.App.connection.sendIQ($iq({to:this.App.BRANCH_JID,type:"set"}).c("call-terminate",{xmlns:this.App.NS_CALL_SETUP,sid:this.sid}),this.proxy(function(){}),this.proxy(function(e){console.log("error terminate",e)})),this.reset()},onAccept:function(e){this.sid===e&&(console.log("onAccept",this.App.user.id),this.state=this.INITIALIZED,this.initTB(this.sid,this.token),this.showLive())},onReject:function(e){this.sid===e&&(console.log("onReject",this.App.user.id),this.reset(),this.showError("call cancelled"))},onTerminate:function(e){this.sid===e&&(console.log("onTerminate",this.App.user.id),this.reset(),this.showError("call Terminated"))},sessionConnectedHandler:function(e){this.state=this.CONNECTED,this.showLive();var t=TB.initPublisher(this.App.OPENTOK_API_KEY,"mirror",{height:"100%",width:"100%"});this.opentokSession.publish(t),this.subscribeToStreams(e.streams)},streamCreatedHandler:function(e){this.subscribeToStreams(e.streams)},sessionDisconnected:function(){console.log("local peer hung up by disconnecting, need to clean up, notify server"),this.terminateCall(),this.reset()},streamDestroyedHandler:function(){this.reset(),this.showError("Remote peer hung up"),this.terminateCall()},connectionDestroyed:function(){console.log("remote peer hung up,just reset, remote peer notifies the server"),this.reset()},exceptionHandler:function(e){var t=e.target;if(t.sessions[this.sid])switch(this.state){case this.CONNECTING:this.reset(),this.showError("Connection failed"),this.terminateCall()}},subscribeToStreams:function(e){for(var t=0;e.length>t;t++){if(e[t].connection.connectionId==this.opentokSession.connection.connectionId)return;console.log("Subscribe to the stream"),this.opentokSession.subscribe(e[t],"remote",{height:"100%",width:"100%"})}console.log("at this point it is believed that both peers are connected"),this.setStatus("")},hangUp:function(){this.el.find(".hang-up").button("loading"),this.opentokSession.connection&&this.opentokSession.disconnect(),this.terminateCall()},setStatus:function(e){this.statusMessageEl.html(e)},deActivate:function(){this.el.removeClass("active")},reset:function(){this.isVideoMuted=!1,this.isAudioMuted=!1,this.initiator=!1,this.started=!1,this.state=this.UNINITIALIZED,this.sid=null,this.call.button("reset"),this.cancelBtn.button("reset"),this.conversation.call=null,this.enableAnswerButtons(),this.setStatus(""),this.videoCallView.hide(),this.showInvite(),this.opentokSession=null},disableAnswerButtons:function(){this.acceptBtn.addClass("disabled"),this.rejectBtn.addClass("disabled")},enableAnswerButtons:function(){this.acceptBtn.removeClass("disabled"),this.rejectBtn.removeClass("disabled")}})}),jQuery(function(e){window.ConversationController=Spine.Controller.create({elements:{".header":"header",".content":"content",".footer":"footer",".chat-message-view":"chatMessageView",".chat-video-view":"chatVideoView",".footer .chat-input input":"input",".videoOp":"videoToggle"},proxied:["remove","render","updateUI","toggleFaceTimeVideo"],events:{"click .facetime-video-toggle":"toggleFaceTimeVideo","keydown .footer .chat-input input":"checkCreateMessage","click .send":"send"},template:function(t){return e("#conversation-tab-pane-tmpl").tmpl(t)},init:function(){this.updateUI(),this.chatMessages=ChatMessages.init({el:this.chatMessageView,conversationController:this,conversation:this.conversation}),this.videoController=ChatVideoController.init({el:this.chatVideoView,conversationController:this,conversation:this.conversation})},activate:function(){console.log("activating...",this.conversation),this.showConversation(),this.conversation.onShow()},deActivate:function(){this.conversation.onHide()},showConversation:function(){this.chatMessages.show(),this.videoController.shouldShow()&&this.showVideo()},checkCreateMessage:function(e){return 13!=e.which||e.shiftKey?void 0:(this.createMessage(),!1)},send:function(){this.createMessage()},createMessage:function(){var e=this.input.val().trim();if(!e)return!1;var t=Message.create({from_id:this.App.user.user_id,from:this.App.user,to_id:this.conversation.user_id,to:this.conversation.user,conversation_id:this.conversation.id,body:e,html:null,type:"chat",date:new Date});this.input.val(""),this.sendMessage(t)},sendMessage:function(e){this.App.connection.send($msg({to:this.App.BRANCH_JID+"/"+this.conversation.user.user_id,type:"chat"}).c("body").t(e.body)),console.log("sendMessage",e)},updateUI:function(){console.log("updateConversationItemUI"),this.headerH=this.header.outerHeight(),this.footerH=this.footer.outerHeight();var e=this.el.parent().height(),t=this.headerH+1;this.contentH=e-t-this.footerH,console.log("updateConversationItemUI",e),this.content.css({height:this.contentH+"px","padding-top":t+"px","padding-bottom":this.footerH+"px"}),this.updateContentPane()},updateContentPane:function(){if(this.chatVideoView.hasClass("active")){var e=180,t=this.contentH-e;this.chatVideoView.css({height:e+"px"}),this.chatMessageView.css({height:t+"px"})}else this.chatMessageView.css({height:this.contentH+"px"});this.chatMessages&&this.chatMessages.updateUI()},toggleFaceTimeVideo:function(t){console.log("toggleFaceTimeVideo",t),e(t.currentTarget).closest("li"),this.videoToggle.hasClass("active")?(this.videoToggle.removeClass("active"),this.videoController.deActivate()):(this.videoToggle.addClass("active"),this.videoController.activate()),this.updateContentPane()},showVideo:function(){this.videoToggle.addClass("active"),this.videoController.activate(),this.updateContentPane()}})}),jQuery(function(e){window.ConversationNavController=Spine.Controller.create({elements:{".conversation-tab-view":"tabView",".conversation-tab-view .conversation-tab-nav":"conversationNav",".conversation-tab-view .conversation-tab-body":"tabBody","#active-conversation-tabs":"activeConversationTabs","#connversation-side-nav .dropup-container":"dropUpContainer","#inactive-conversation-tabs":"inActiveConversationTabs","#conference-tab":"conferenceTab"},events:{"click #active-conversation-tabs li":"selectTab","click #connversation-side-nav .dropup-container":"dropUp","click #inactive-conversation-tabs  li":"selectInActiveTab","click #inactive-conversation-tabs  li .close":"removeInactiveConversation","click#active-conversation-tabs   li .close":"removeActiveConversation","click #conference-tab a":"activateConference"},proxied:["remove","render","update","updateUI","onUpdateConversation","onDestroyConversation","checkConversation","showConversationWithContact","onConversation","asc","desc","templateTab","hideDropUp","showConversation"],templateTab:function(t){return e("#conversation-tab-tmpl").tmpl(t)},templateInActiveTab:function(t){return e("#inactive-conversation-tab-tmpl").tmpl(t)},templateConversation:function(t){return e("#conversation-tab-pane-tmpl").tmpl(t)},init:function(){Conversation.bind("update",this.onUpdateConversation),Conversation.bind("destroy",this.onDestroyConversation),this.App.bind("conversations:show",this.onConversation),this.App.bind("conversations:show:contact",this.showConversationWithContact),this.maxNumActiveConversation=3,this.activeConversation=[],this.activeConversationMap={},this.inActiveConversationMap={},this.inActiveConversation=[],this.conversationControllers={},this.currentConversationController=null,this.hiddenEmptyView=!1,e(document).on("click",this.hideDropUp),this.App.bind("chat:updateUI",this.updateUI)},showConversationWithContact:function(e,t){var n=this.getConversationWithUser(e.user_id);if(n)this.checkConversation(n);else{var i=t&&t.created_by_local_user?t.created_by_local_user:!1;n=this.getConversation(e.user_id,i),t&&t.show&&this.showConversation(n)}t&&t.callback&&t.callback.call(null,n)},checkConversation:function(e){if(this.activeConversationMap[e.id]){var e=this.activeConversationMap[e.id];this.showConversation(e),console.log("conversation",e)}else if(this.inActiveConversationMap[e.id]){var t=this.inActiveConversationMap[e.id];console.log("inActiveConversation",t),this.activateInActiveConversation(t),console.log("show",t),this.showConversation(t)}},showConversation:function(e){this.render(),this.el.hasClass("active")||this.el.addClass("active"),this.activateConversation(e)},onConversation:function(e){this.showConversationWithContact(e.user)},updateConversationShowTime:function(e){e.last_shown_time=new Date},removeLeastActiveConversation:function(){var e=this.activeConversation.shift();return delete this.activeConversationMap[e.id],e},removeMostActiveInactiveConversation:function(){var e=this.inActiveConversation.pop();return e&&delete this.inActiveConversationMap[e.id],e},addToActiveConversation:function(e,t){t===!0&&e.touchShow(),this.activeConversation.push(e),this.activeConversation.sort(this.asc),this.activeConversationMap[e.id]=e},addToInActiveConversation:function(e,t){t===!0&&e.touchShow(),this.inActiveConversation.push(e),this.inActiveConversationMap[e.id]=e,this.inActiveConversation.sort(this.asc),e.onHide()},activateInActiveConversation:function(e){delete this.inActiveConversationMap[e.id];var t=this.removeLeastActiveConversation();this.addToActiveConversation(e,!0);var n=this.inActiveConversation.indexOf(e);console.log("removeLeastActiveConversation",t),this.inActiveConversation.splice(n,1),this.addToInActiveConversation(t,!0)},activateConversation:function(e){var t="#active-conversation-tab_"+e.id;this.activeConversationTabs.find("li a.active").removeClass("active").attr("tabindex","-1"),this.conferenceTab.removeClass("active").attr("tabindex","-1");var n=this.activeConversationTabs.find(t+" a");n.attr("tabindex","0").addClass("active"),this.tabBody.find(".conversation-tab-pane").attr("aria-hidden",!0).removeClass("active"),this.tabBody.find("#conversation-tab-pane_"+e.id).attr("aria-hidden",!1).addClass("active"),this.currentConversationController&&this.currentConversationController.deActivate(),this.currentConversationController=this.conversationControllers[e.id],this.currentConversationController.activate()},activateConference:function(){return this.activeConversationTabs.find("li a.active").removeClass("active").attr("tabindex","-1"),this.tabBody.find(".conversation-tab-pane").attr("aria-hidden",!0).removeClass("active"),this.conferenceTab.attr("tabindex","0").addClass("active"),this.tabBody.find("#conversation-tab-pane_conference").attr("aria-hidden",!1).addClass("active"),this.currentConversationController&&this.currentConversationController.deActivate(),this.currentConversationController=this.conferenceController,this.currentConversationController.activate(),!1},render:function(){this.renderInActiveConversationTabs(),this.renderActiveConversationTabs()},renderActiveConversationTabs:function(){this.activeConversationTabs.empty(),e.each(this.activeConversation,this.proxy(function(e){this.activeConversationTabs.append(this.templateTab(this.activeConversation[e]))})),this.activeConversationTabs.find("li").each(this.proxy(function(t,n){e(n).attr("role","tab")})),this.activeConversationTabs.find("a").attr("tabindex","-1"),this.inActiveConversation.length>0?this.dropUpContainer.show():this.dropUpContainer.hide()},renderInActiveConversationTabs:function(){this.inActiveConversationTabs.empty(),e.each(this.inActiveConversation,this.proxy(function(e){this.inActiveConversationTabs.append(this.templateInActiveTab(this.inActiveConversation[e]))}))},getConversation:function(e,t){var n=this.chats.getConversation(e,t);if(n.assertUser()){if(this.activeConversation.length<this.maxNumActiveConversation)this.addToActiveConversation(n,!0);else{var i=this.removeLeastActiveConversation();this.addToInActiveConversation(i,!0),this.addToActiveConversation(n,!0)}var s=this.templateConversation(n);this.tabBody.append(s);var o=ConversationController.init({conversation:n,el:s});return this.conversationControllers[n.id]=o,n}},onUpdateConversation:function(e){if(console.log("UPDATE CONVERSATION",e),this.activeConversationMap[e.id]){var t=this.activeConversationMap[e.id],n=this.activeConversation.indexOf(t);n>0&&this.activeConversation.splice(n,1,e),this.activeConversationMap[e.id]=e}else if(this.inActiveConversationMap[e.id]){var t=this.inActiveConversationMap[e.id],n=this.inActiveConversation.indexOf(t);n>0&&this.inActiveConversation.splice(n,1,e),this.inActiveConversationMap[e.id]=e}},onDestroyConversation:function(){},selectTab:function(t){var n=e(t.currentTarget),i=n.closest("li"),s=i.attr("id").split("_")[1];try{this.activateConversation(this.activeConversationMap[s])}catch(o){console.log(o)}},selectInActiveTab:function(t){var n=e(t.currentTarget),i=n.closest("li"),s=i.attr("id").split("_")[1];try{this.checkConversation(this.inActiveConversationMap[s])}catch(o){console.log(o)}},getConversationWithUser:function(e){var t=Conversation.findByAttribute("user_id",e);return t&&(this.activeConversationMap[t.id]||this.inActiveConversationMap[t.id])?t:null},removeInactiveConversation:function(t){var n=e(t.currentTarget),i=n.closest("li"),s=i.attr("id").split("_")[1];this.tabBody.find("#conversation-tab-pane_"+s).remove(),i.remove();var o=this.inActiveConversationMap[s],r=this.inActiveConversation.indexOf(o);return this.inActiveConversation.splice(r,1),delete this.inActiveConversationMap[o.id],delete this.conversationControllers[o.id],this.inActiveConversation.length>0?this.dropUpContainer.show():this.dropUpContainer.hide(),!1},removeActiveConversation:function(t){var n=e(t.currentTarget),i=n.closest("li"),s=i.attr("id").split("_")[1];this.tabBody.find(".conversation-tab-pane").attr("aria-hidden",!0).removeClass("active"),this.tabBody.find("#conversation-tab-pane_"+s).remove(),i.remove();var o=this.activeConversationMap[s],r=this.activeConversation.indexOf(o);this.activeConversation.splice(r,1),delete this.activeConversationMap[o.id],delete this.conversationControllers[o.id];var a=this.removeMostActiveInactiveConversation();return a&&(this.addToActiveConversation(a,!1),this.render()),!1},dropUp:function(t){var n=e(t.currentTarget),i=n.closest(".ops");return i.hasClass("open")?i.removeClass("open"):i.addClass("open"),!1},hideDropUp:function(){this.dropUpContainer.hasClass("open")&&this.dropUpContainer.removeClass("open active")},updateUI:function(){console.log("updateUI");var e=this.conversationNav.outerHeight(),t=this.el.height();tabH=t-e,this.tabBody.css({height:tabH+"px"})},asc:function(e,t){return e.last_shown_time>t.last_shown_time?1:e.last_shown_time<t.last_shown_time?-1:0
},desc:function(e,t){return e.last_shown_time>t.last_shown_time?-1:e.last_shown_time<t.last_shown_time?1:0}})}),jQuery(function(e){Spine.Controller.prototype.App.base_url="http://antrees.com/",Spine.Controller.prototype.App.bosh_addr="http://antrees.com/http-bind",Spine.Controller.prototype.App.OPENTOK_API_KEY="23037872",Spine.Controller.prototype.App.BRANCH_SERVICE="branch.antrees.com",Spine.Controller.prototype.App.isCurrentUser=function(e){return this.user&&e?this.user.user_id===e.user_id:!1},Spine.Controller.prototype.App.isVideoCallSupported=TB.checkSystemRequirements(),window.ChatApp=Spine.Controller.create({elements:{"#contacts":"contactsEl","#chats":"chatsView",".tabView":"tabView",".tabView .chat_tabs":"chatTabs",".tabView .tab-body":"tabBody",".tabView .tab-body .tab-pane":"tabPane","#conversation_direct":"conversationsView",".chat-toggle":"chatToggle","#conversation-tab-pane_conference":"conferenceView"},events:{"click .chat-toggle":"toggleChatView"},proxied:["showConversations","showContacts","onPresence","onMessage","updateUI","showChats","onConnect","onFailure","onAttach","onContactsError","onContacts","onIq"],init:function(){this.App.bind("show:contacts",this.showContacts),this.App.bind("show:chats",this.showChats),this.App.bind("updateUI",this.updateUI),this.App.NS_CHECK_IN="http://rzaartz.com/protocol/check_in",this.App.NS_MUC="http://jabber.org/protocol/muc",this.App.NS_RTC_SESSION_INIT="http://antrees.com/rtc/session_init",this.App.NS_CALL_SETUP="http://antrees.com/call_setup",this.App.NS_ANTREES="http://antrees.com",this.App.NS_ROSTER="jabber:iq:roster",this.App.BRANCH_JID=this.App.branch.id+"@"+this.App.BRANCH_SERVICE,this.setUpAudio(),this.connect()},setUpAudio:function(){e('<audio id="chatAudio"><source src="/assets/notify.ogg" type="audio/ogg"><source src="/assets/notify.mp3" type="audio/mpeg"><source src="/assets/notify.wav" type="audio/wav"></audio>').appendTo("body")},doInit:function(){this.chatTabs.removeClass("disabled"),this.contacts=Contacts.init({el:this.contactsEl}),this.chats=Chats.init({el:this.chatsView}),this.conferenceController=ConferenceController.init({el:this.conferenceView}),this.conversationNavController=ConversationNavController.init({el:this.conversationsView,chats:this.chats,conferenceController:this.conferenceController}),this.chatMessageHandler=ChatMessageHandler.init(),this.tabs=TabController.init({el:this.tabView,options:{activeTabClass:"active",activePanelClass:"tab-pane-active"}}),this.App.trigger("chat:updateUI")},runTests:function(){this.App.user=Contact.init({name:"paul",user_id:"567"}),this.contacts.show(),this.contacts.test(),this.chatMessageHandler.test()},connect:function(){this.showProgress({message:"initializing..."}),this.chatTabs.addClass("disabled"),console.log("attempting to connect"),e.ajax({type:"GET",url:this.App.base_url+"connect",contentType:"application/json",error:this.onFailure,success:this.onConnect})},onConnect:function(e){console.log("Successfull ",e),this.sid=e.sid,this.rid=e.rid,this.userJid=e.jid,this.App.user=Contact.init({name:e.user.name,user_id:e.user.id}),console.log("jid ",this.userJid),this.App.connection=new Strophe.Connection(this.App.bosh_addr),console.log("Attaching",this.App.connection),this.App.connection.attach(this.userJid,this.sid,this.rid,this.onAttach)},onAttach:function(e){switch(e){case Strophe.Status.ATTACHED:this.onAttached()}return!1},onAttached:function(){this.App.connection.sendIQ($iq({to:this.App.BRANCH_JID,type:"get"}).c("query",{xmlns:this.App.NS_ROSTER}),this.onContacts,this.onContactsError)},onContacts:function(t){console.log("response iq",t),this.hideProgress(),this.doInit(),e(t).find("item").each(function(){var t=e(this).attr("jid"),n=e(this).attr("name")||t,i=e(this).attr("photo_url"),s=e(this).attr("affiliation");Contact.create({name:n,photo_url:i,affiliation:s,online:{status:"available"},user_id:Strophe.getResourceFromJid(t),jid:t})}),this.App.trigger("chat:updateUI"),this.App.connection.addHandler(this.onPresence,null,"presence"),this.App.connection.addHandler(this.onIq,null,"iq"),this.notifyServicePresence()},onContactsError:function(e){console.log("error",e),this.showError({message:"Failed to retrieve contacts please refresh this page"})},onIq:function(t){console.log("iq received",t);var n=e(t).find('*[xmlns="'+this.App.NS_CALL_SETUP+'"]:first');return n.length>0?this.handleVideoCall(t,n):this.sendError(t,"cancel","feature-not-implemented"),!0},handleVideoCall:function(t,n){var i=e(t).attr("id"),s=e(t).attr("from"),o=e(t).attr("type");if("get"===o)return this.send_error(t,"cancel","bad-request"),!0;if("set"!==o)return!0;switch(n[0].tagName){case"call-invite":this.doCallInvite(i,s,n);break;case"call-accept":this.doCallAccept(i,s,n);break;case"call-reject":this.doCallReject(i,s,n);break;case"call-terminate":this.doCallTerminate(i,s,n);break;default:this.sendError(t,"cancel","bad-request")}},doCallInvite:function(t,n,i){this.App.connection.send($iq({to:n,id:t,type:"result"}));var s=Strophe.getResourceFromJid(e(i).attr("from")),o=e(i).attr("sid"),r=e(i).attr("token"),a=Call.init({sid:o,token:r,initiated_by_local_user:!1,caller_id:s,callee_id:this.App.user.user_id,state:Call.STATE.ANSWER}),l=Conversation.findByAttribute("user_id",s);if(l)this.App.trigger("call:new",a);else{var c=Contact.findByAttribute("user_id",s);c&&this.App.trigger("conversations:show:contact",c,{show:!1,created_by_local_user:!1,callback:this.proxy(function(){this.App.trigger("call:new",a)})})}},doCallAccept:function(t,n,i){this.App.connection.send($iq({to:n,id:t,type:"result"}));var s=e(i).attr("sid");this.App.trigger("call:accept",s)},doCallReject:function(t,n,i){this.App.connection.send($iq({to:n,id:t,type:"result"}));var s=e(i).attr("sid");this.App.trigger("call:reject",s)},doCallTerminate:function(t,n,i){this.App.connection.send($iq({to:n,id:t,type:"result"}));var s=e(i).attr("sid");this.App.trigger("call:terminate",s)},notifyServicePresence:function(){this.App.connection.send($pres().c("priority").t("-1")),this.App.user.jid=this.App.BRANCH_JID+"/"+this.App.user.user_id,console.log("user",this.App.user),this.App.connection.send($pres({to:this.App.user.jid}).c("x",{xmlns:this.App.NS_MUC})),console.log("sending pres to branch component",this.App.user.jid)},onFailure:function(e){return console.log(e.responseText),this.attempt++<this.maxAttemp?this.connect():(this.hideProgress(),this.showError({message:"could not connect to server"})),!1},onPresence:function(t){console.log(t);var n=e(t).attr("from"),i=e(t).attr("type"),s=Strophe.getBareJidFromJid(n),o=Strophe.getResourceFromJid(n);if(console.log("branch_jid",s),s===this.App.BRANCH_JID){var r=Contact.findByAttribute("user_id",o);if("error"!==i||this.joined){if(!r&&"unavailable"!==i){var a=e(t).find("item"),l=a.attr("affiliation"),c=a.attr("name"),u=a.attr("photo_url");r=Contact.create({name:c,photo_url:u,affiliation:l,online:{status:"available"},user_id:o,jid:n})}}else;"error"===i||this.joined||e(t).find('status[code="110"]').length>0&&e(t).find('status[code="210"]').length>0}return!0},showProgress:function(t){this.hideProgress(),this.progress=e("#chat-load-tmpl").tmpl(t),this.progress.appendTo(this.tabBody)},showError:function(t){this.hideError(),this.errorMessage=e("#chat-error-alert-tmpl").tmpl(t),this.errorMessage.appendTo(this.tabBody)},hideProgress:function(){this.progress&&this.progress.remove()},hideError:function(){this.errorMessage&&this.errorMessage.remove()},updateUI:function(){console.log("updateUI");var e=this.chatTabs.outerHeight(),t=this.el.height();tabH=t-e,this.tabBody.css({height:tabH+"px"}),this.tabPane.css({height:tabH+"px"}),this.App.trigger("chat:updateUI")},showContacts:function(){this.contacts.show()},showChats:function(){this.chats.show()},toggleChatView:function(){this.chatToggle.hasClass("open")?(this.chatToggle.removeClass("open"),this.conversationsView.addClass("active")):(this.chatToggle.addClass("open"),this.conversationsView.removeClass("active"))},sendError:function(t,n,i,s){var o=$iq({to:e(t).attr("from"),id:e(t).attr("id"),type:"error"}).cnode(t.cloneNode(!0)).up().c("error",{type:n}).c(i,{xmlns:Strophe.NS.STANZAS}).up();s&&o.c(s,{xmlns:this.App.NS_ANTREES}),this.App.connection.send(o)}})}),jQuery(function(e){window.ChatMessageHandler=Spine.Controller.create({proxied:["remove","render","update"],template:function(t){return e("#contact-item-tmpl").tmpl(t)},proxied:["onMessage"],init:function(){this.App.connection.addHandler(this.onMessage,null,"message","chat")},test:function(){var t=Message.fakeItem();e.each(t,this.proxy(function(e){var n=Conversation.findByAttribute("user_id",t[e].from_id);if(n){var i=Message.create(t[e]);n.onMessage(i),this.App.trigger("chats:show")}else{var s=Contact.findByAttribute("user_id",t[e].from_id);s&&(console.log("contact",s),this.App.trigger("conversations:show:contact",s,{show:!1,created_by_local_user:!1,callback:this.proxy(function(n){var i=Message.create(t[e]);i.assertFrom()?(console.log("asserted"),n.onMessage(i),this.App.trigger("chats:show")):i.destroy()})}))}}))},onMessage:function(t){console.log("received",t);var n=e(t).attr("from");Strophe.getNodeFromJid(n),Strophe.getBareJidFromJid(n);var i=Strophe.getResourceFromJid(n);console.log("user_id",i);var s=Conversation.findByAttribute("user_id",i);if(s)this.handleMessage(t,s);else{var o=Contact.findByAttribute("user_id",i);o&&this.App.trigger("conversations:show:contact",o,{show:!1,created_by_local_user:!1,callback:this.proxy(function(e){this.handleMessage(t,e)})})}return!0},handleMessage:function(t,n){var i=e(t).children("body"),t=Message.create({from_id:n.user_id,from:n.user,to_id:this.App.user.user_id,conversation_id:n.id,to:this.App.user,body:i.text(),html:null,type:Message.MESSAGE_TYPE.CHAT,date:new Date});e("#chatAudio")[0].play(),this.App.trigger("chats:show")}})}),jQuery(function(e){window.TipLink=Spine.Controller.create({elements:{".content":"content",".input":"input",".save":"saveBtn",".tip-alert":"alertEl",".tip-link-preview":"linkPreview",".update-btns":"updateBtns",".tip-link-input":"linkInput",".linkEl":"linkEl",".change":"changeBtn",".delete":"deleteBtn"},events:{"click .remove":"removeLink","click .remove-error":"hideError","click #post-upload-preview-wrap .change":"changePhoto","click .save":"saveLink","click .change":"changeLink","click .delete":"deleteLink"},proxied:["show","render"],template:function(){},init:function(){this.browsePhoto=BrowsePhoto.init({el:this.uploadBtn,onChange:this.uploadPhoto}),this.browsePhoto.activate(),this.App.bind("show:tip:link",this.show)},show:function(e){this.tip=e,this.tip.type="LinkTip",console.log("tiplink",this.tip)},showError:function(t){this.alertEl.show().html(e("#tip-upload-error-tmpl").tmpl(t))},hide:function(){this.progressEl.hide(),this.previewEl.hide(),this.uploadBtn.hide()},removeLink:function(){this.xhr&&4!=this.xhr.readystate&&(this.delete_url=null,this.photo_url=null,this.xhr.abort(),this.reset(),this.tipController.deActivateTabs(),this.tip.type=""),this.tipController.deActivateTabs(),this.tip.type=""},saveLink:function(){this.saveBtn.hasClass("disabled")||(this.url=this.input.val(),console.log("url",this.url),this.saveBtn.button("loading"),e.ajax({type:"PUT",data:{"link[url]":this.url,"tip[type]":"LinkTip"},url:this.tip.update_url,error:this.proxy(function(t){var n=JSON.parse(t.responseText).url.join(" , ");console.log("data",n),this.saveBtn.button("reset"),this.el.find(".help-inline").remove(),this.input.closest(".control-group").addClass("error"),e('<span class="help-inline"><i class="icon-warning"></i> '+n+"</span>").insertAfter(this.input.parent()),this.showError({message:"could not save link"}),this.input.val("")}),success:this.proxy(function(e){this.link_url=e.url,this.delete_url=e.delete_url,this.saveBtn.button("reset"),this.input.closest(".control-group").hasClass("error")&&(this.input.closest(".control-group").removeClass("error"),this.input.closest(".control-group").find(".help-inline").remove()),this.input.val(""),this.hideAll(),this.render()})}))},render:function(){console.log("linkel",this.LinkEl),this.linkPreview.show(),this.linkEl.html(e("#link-tmpl").tmpl({url:this.link_url}))},hideAll:function(){this.linkInput.hide(),this.linkPreview.hide()},changeLink:function(){this.hideAll(),this.linkInput.show()},deleteLink:function(){this.link_url&&this.delete_url&&(this.changeBtn.addClass("disabled"),this.deleteBtn.button("loading"),e.ajax({type:"POST",url:this.delete_url,error:this.proxy(function(){this.changeBtn.removeClass("disabled"),this.deleteBtn.button("reset"),this.showError({message:"could not delete photo"})}),success:this.proxy(function(){this.delete_url=null,this.photo_url=null,this.changeBtn.removeClass("disabled"),this.deleteBtn.button("reset"),this.hideAll(),this.linkInput.show()})}))}})}),jQuery(function(e){window.TipPhotoUpload=Spine.Controller.create({elements:{".content":"content","#tip-photo-upload-btn":"uploadBtn",".tip-alert":"alertEl","#post-upload-preview-wrap":"previewEl",".photo-upload-progress":"progressEl",".status":"progressStatus"," .bar":"progressBar","#post-upload-preview-wrap .change":"changeBtn",".delete":"delete",".delete_tip":"deleteTipBtn",".update-btns .btn":"updateButtons"},events:{"click .delete":"hideView","click .delete_tip":"deletePhoto","click .remove-error":"hideError","click #post-upload-preview-wrap .change":"changePhoto"},proxied:["upload","onUpload","uploadProgress","uploadError","uploadSuccess","show","uploadPhoto"],template:function(){},init:function(){this.browsePhoto=BrowsePhoto.init({el:this.uploadBtn,onChange:this.uploadPhoto}),this.browsePhoto.activate(),this.App.bind("show:tip:photo",this.show)},showProgress:function(){this.progressEl.show(),this.delete.hide()},hideProgress:function(){this.progressEl.hide(),this.delete.show()},show:function(e){this.tip=e,this.tip.type="PhotoTip",console.log("tip",e)},hide:function(){this.progressEl.hide(),this.previewEl.hide(),this.uploadBtn.hide()},upload:function(t,n){console.log("upload",n[0]),this.files=n,this.hide(),this.showProgress(),this.xhr=e.upload(t,{"photo[image]":n[0],"tip[type]":"PhotoTip"},{type:"PUT",contentType:"JSON",upload:{progress:this.uploadProgress,load:this.onUpload},error:this.uploadError,success:this.uploadSuccess})},uploadSuccess:function(e){this.photo_url=e.photo_url,this.delete_url=e.delete_url,this.hideProgress(),this.reset(),console.log("data",e),this.previewEl.find("img").attr("src",this.photo_url),console.log("success",e),this.xhr=null},uploadError:function(){this.showError({message:"upload failed !"}),this.hideProgress(),this.reset(),this.xhr=null},reset:function(){this.hide(),this.progressStatus.text(""),this.progressBar.css({width:"0"}),this.uploadBtn.removeClass("disabled"),this.browsePhoto=BrowsePhoto.init({el:this.uploadBtn,onChange:this.uploadPhoto}),this.browsePhoto.activate(),this.photo_url?this.previewEl.show():this.uploadBtn.show()},uploadProgress:function(e){percentage=Math.round(100*(e.position/e.total)),console.log("progress",e),this.progressStatus&&this.progressStatus.text("uploading..."+percentage+"%"),this.progressBar&&this.progressBar.css({width:percentage+"%"})},onUpload:function(e){console.log("load",e)},showError:function(t){this.alertEl.show().html(e("#tip-upload-error-tmpl").tmpl(t))},showDeleteInfo:function(t){this.alertEl.show().html(e("#tip-delete-info-tmpl").tmpl(t))},hideDeleteInfo:function(){this.alertEl.empty().hide()},hideError:function(){return this.content.show(),this.alertEl.empty().hide(),!1},uploadPhoto:function(e){console.log("upload",e),event=e.originalEvent,this.files=event.target.files,this.files.length>0&&(this.uploadBtn.addClass("disabled"),this.browsePhoto.deActivate(),this.upload(this.tip.update_url,this.files))},hideView:function(){this.xhr&&4!=this.xhr.readystate&&(this.delete_url=null,this.photo_url=null,this.xhr.abort(),this.reset()),this.tipController.deActivateTabs()},deletePhoto:function(){this.photo_url&&this.delete_url&&(this.deleteTipBtn.button("loading"),this.updateButtons.addClass("disabled"),e.ajax({type:"POST",url:this.delete_url,error:this.proxy(function(){this.hideDeleteInfo(),this.deleteTipBtn.button("reset"),this.updateButtons.removeClass("disabled"),this.showError({message:"could not delete photo"})}),success:this.proxy(function(){this.deleteTipBtn.button("reset"),this.updateButtons.removeClass("disabled"),this.delete_url=null,this.photo_url=null,this.hideDeleteInfo(),this.reset()})}))},changePhoto:function(){this.photo_url&&this.delete.show(),this.hide(),this.uploadBtn.show()}})}),jQuery(function(e){window.NewTip=Spine.Controller.create({elements:{".input-btn":"postTrigger",".input-btn .status":"openStatus","#input-controls .btn":"controlButtons",".attachment":"toolBar",".tip-input":"input","#tip-categories":"postCategories",".categoryOp":"categoryEl",".linkOp":"linkEl",".photoOp":"photoEl","#tip-btn":"postBtnEl","#tip-btn .tip":"postBtn",".tip-main-container":"mainContainer",".tab-body":"tabBody",".tab-pane":"tabPane","#input-controls .dropdown-menu":"tabs","#tip-photo":"tipPhoto","#tip-link":"tipLink","#tip-title":"titleEl","#tip-input .input-wrap":"bodyEl"},events:{"click .input-btn":"openPost","click .categoryOp":"toggleCategories","click .titleOp":"toggleTitle","click #input-controls .dropdown-menu li a":"changeTip","keydown .tip-input":"checkInput","keyup .tip-input":"checkInput","click #tip-btn .tip":"post","click .close-tip":"closeTip"},proxied:["uploadPhoto","onUpload","uploadError","postError","postSuccess","reset"],template:function(){},init:function(){this.tipPhotoUpload=TipPhotoUpload.init({el:this.tipPhoto,tipController:this}),this.tipLink=TipLink.init({el:this.tipLink,tipController:this})},openPost:function(){this.postTrigger.hasClass("disabled")||(this.postTrigger.removeClass("error").addClass("disabled"),this.openStatus.text("opening..."),url=this.postTrigger.data("url"),branch_id=this.postTrigger.data("branch"),data={branch_id:branch_id},e.ajax({type:"POST",url:url,data:data,error:this.proxy(function(e){console.log(e),this.postTrigger.removeClass("disabled").addClass("error"),this.openStatus.text("error loading data!")}),success:this.proxy(function(t){console.log(t),this.tip=t,this.postTrigger.removeClass("disabled error"),this.postTrigger.hide(),this.toolBar.removeClass("disabled"),this.bodyEl.html(e("#tip-input-title-tmpl").tmpl()),this.input=this.bodyEl.find(".tip-input"),this.input.on("resize",this.proxy(function(){console.log("resize"),this.App.trigger("tips:update")})),this.bodyEl.show(),this.postBtnEl.show(),this.postBtn.addClass("disabled"),this.mainContainer.show(),this.App.trigger("tips:update")})}))},closePost:function(e){this.mainContainer.hide(),this.postCategories.empty(),this.tabPane.attr("aria-hidden",!0).removeClass("active"),this.titleEl.empty(),this.bodyEl.empty(),this.postTrigger.show(),this.toolBar.addClass("disabled"),e&&e.call(null),this.App.trigger("tips:update")},toggleCategories:function(t){var n=e(t.currentTarget);if(!n.hasClass("disabled")&&!this.toolBar.hasClass("disabled")){if(n.hasClass("open"))n.removeClass("open"),this.postCategories.show(),e(this).empty();else{n.addClass("open");var i=e("#tip-category-tmpl").tmpl("");this.postCategories.html(i).find(".listbuilderinput ").listbuilder({width:"100%",url:"/tags",jsonContainer:"tags",hintText:"type a name and press enter or comma."}),this.postCategories.hide(),this.categories=this.postCategories.find("textarea")}this.App.trigger("tips:update")}},toggleTitle:function(t){var n=e(t.currentTarget);n.hasClass("disabled")||this.toolBar.hasClass("disabled")||(n.hasClass("open")?(n.removeClass("open"),this.titleEl.hide(),e(this).empty(),this.categoryEl.find(".ui-text").text("Add Categories")):(n.addClass("open"),this.titleEl.html(e("#tip-title-tmpl").tmpl("")),this.titleEl.hide().show(),this.title=this.titleEl.find("input")),this.App.trigger("tips:update"))},checkInput:function(){var e=this.input.val();""==e?this.postBtn.addClass("disabled"):this.postBtn.removeClass("disabled")},post:function(){if(!this.postBtn.hasClass("disabled")&&(this.tip.content=this.input.val(),this.categories&&(this.tip.categories=this.categories.val()),console.log("input",this.input),this.tip.content&&this.tip)){var t={};t["tip[content]"]=this.tip.content,this.tip.link&&(t["link[url]"]=this.tip.link),this.tip.categories&&(t["tip[categories_list]"]=this.tip.categories),this.postBtn.button("loading"),this.xhr=e.upload(this.tip.publish_url,t,{type:"POST",contentType:"JSON",error:this.postError,success:this.postSuccess}),this.postTrigger.removeClass("error").addClass("disabled")}},postError:function(e){console.log("error",e),this.closePost(this.proxy(function(){this.postBtn.button("reset"),this.input.addClass("error"),this.openStatus.text("error posting"),this.postTrigger.removeClass("disabled").addClass("error")}))},postSuccess:function(e){console.log("post",e),this.closeTip()},closeTip:function(){return this.closePost(this.reset),!1},reset:function(){this.postBtn.button("reset"),this.openStatus.text("click to open"),this.postTrigger.removeClass("disabled error"),this.postTrigger.show()},changeTip:function(t){var n=e(t.target);n.is("a")||(n=n.closest("a")),this.tabs.find("li a").removeClass("active").attr("tabindex","-1"),n.attr("tabindex","0").addClass("active"),this.tabPane.attr("aria-hidden",!0).removeClass("active"),this.tabBody.find(n.data("target")).attr("aria-hidden",!1).addClass("active"),this.currentType=n.data("type"),this.App.trigger(n.data("action"),this.tip)},deActivateTabs:function(){this.tabPane.attr("aria-hidden",!0).removeClass("active"),this.tabs.find("li a").removeClass("active").attr("tabindex","-1")}})}),jQuery(function(e){window.Application=Spine.Controller.create({elements:{"#main_navbar":"mainNavBar","#left_panel":"leftPanel","#left_panel .left_panel_wrap":"leftPanelWrap","#conversation_all":"conversationEl"},events:{},proxied:["updateUI"],init:function(){this.tips=Tips.init({el:e("#tipView")}),this.newTip=NewTip.init({el:e("#upost")}),this.App.branch={id:this.conversationEl.data("branch-id"),name:this.conversationEl.data("branch-name")},console.log("branch",this.App.branch),this.chatApp=ChatApp.init({el:this.conversationEl}),e(window).on("resize",this.updateUI),this.updateUI()},updateUI:function(){var t=this.mainNavBar.outerHeight(),n=e(window).height();this.leftPanel.css({height:"100%"}),this.leftPanelWrap.css({height:n-t+"px"}),this.App.trigger("updateUI")}}),Application.init({el:e("body")})});